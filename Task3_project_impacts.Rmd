---
title: "Task 3. project impacts"
author: "Mike Allen"
date: "2/28/2022"
output:
  html_document: default
  pdf_document: default
---
# To Do
1. Columbia Dam: 
  * boxplots:  downstream: TNC_25 vs. upstream TNC_23
  * BACI statistical analysis 25 vs. 23 before/after 2018
  - time series plots of downstream/upstream diff by year
  - plot & compare: downstream 25 vs. inside 80/81? (only 'after' 2018+ data)
  - address autocorrelation in residuals
  
2. Tree planting:
  - Plot TNC_4 (up), 5 (in), and 8 (down)
  - Analysis: does 4/5 or 4/8 difference increase over time? (2015-2018)

# Task 3: Project Specific Analyses
a. What are water quality conditions upstream/downstream/within project area(s) pre and post dam removal (assessing turbidity, conductivity, dissolved oxygen and temperature)?

b. What are baseline water quality conditions 
upstream/downstream/within floodplain reforestation corridor(s) before and after tree plantings (assessing temperature, dissolved oxygen)?

c. What are baseline water quality conditions downstream Hyper Humus (assessing temperature, dissolved oxygen)?

Task and Product 3 Due: April 10, 2022

# Product 3:
• Evaluate project specific questions via statistical analysis and data visualization (figures, maps,
plots).
• Meetings as needed to refine objectives and desired outputs.
• Assess spatial and temporal changes in water quality metrics with respect to dam removal (before/after, upstream/downstream), restoration projects, and other sites of interest (Hyper Humus). Provide associated interpretative text.

# Load libraries, format data, etc.
```{r}
library(dplyr)
library(knitr)
library(tidyr)
library(kableExtra)
library(wesanderson)
library(lubridate)
library(ggplot2)
library(forcats)
# library(lme4)
library(here)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tdata <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60) %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  # right_join(expand.grid(site = unique(p$site), 
  #                        year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  # peak movement ~ 15 April - 15 May in Raritan per Anthony V.
  mutate(season = case_when(day %in% 105:135 ~ "migrate", #4/15-5/15
                            day %in% 136:151 ~ "spawn", #5/16-5/31
                            day %in% 152:181 ~ "larvae", #6/1-6/30
                            day %in% 182:258 ~ "juvenile", #7/1-9/15
                            day %in% 259:334 ~ "fall_mig"), #9/15-11
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour),
         season = as.factor(season))

# Columbia Dam - Temperature
    # upstream: TNC_23, downstream: TNC_25 (& 24), in: 80 & 81
col <- tdata %>%
  filter(site %in% c("TNC_23", "TNC_25", 
                     "TNC_24", "TNC_81", "TNC_80")) %>%
  mutate(monthf = as.factor(month)) %>%
    group_by(site, yearf, monthf, dayf, hourf) %>%
  summarize(mean_temp = mean(temp),
            .groups = "drop") %>%
  group_by(site, yearf, monthf, dayf) %>%
  summarize(mean_temp = mean(mean_temp),
            .groups = "drop") %>%
  tidyr::pivot_wider(names_from = "site", 
                     values_from = "mean_temp") %>%
  mutate(d25.23 = TNC_25-TNC_23,
         d25.80 = TNC_25-TNC_80,
         d25.81 = TNC_25-TNC_81,
         stage = as.factor(case_when(yearf %in% 2016:2017 ~ 1,
                           yearf == 2018 & as.numeric(as.character(monthf))<7~1,
                           yearf == 2018 & as.numeric(as.character(monthf))>=7 |
                             yearf == 2019 & as.numeric(as.character(monthf))<5~2,
                           yearf == 2019 & as.numeric(as.character(monthf))>=5~3,
                           yearf %in% 2020:2021 ~ 3))
         )

# Tree planting area - Temperature
    # upstream: TNC_4, within: TNC_5, downstream: TNC_8
tree <- tdata %>%
  filter(site %in% c("TNC_4", "TNC_5", "TNC_8")) %>%
  mutate(monthf = as.factor(month)) %>%
    group_by(site, yearf, monthf, dayf, hourf) %>%
  summarize(mean_temp = mean(temp),
            .groups = "drop") %>%
  group_by(site, yearf, monthf, dayf) %>%
  summarize(mean_temp = mean(mean_temp),
            .groups = "drop") %>%
  tidyr::pivot_wider(names_from = "site", 
                     values_from = "mean_temp") %>%
  mutate(d8.4 = TNC_8-TNC_4,
         d5.4 = TNC_5-TNC_4,
         d4.8 = TNC_4-TNC_8,
         d4.5 = TNC_4-TNC_5,
         stage = as.factor(case_when(yearf %in% 2016:2018 ~ 1,
                           yearf %in% 2019:2021 ~ 2))
         )

# format final compiled DO data
dodata <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60,
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  select(-do, -do_adj) %>%
  rename(do = do_adj2) %>%
  # right_join(expand.grid(site = unique(p$site), 
  #                        year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
    # Dates based on Anthony V. and shad reference he provided
  mutate(season = case_when(day %in% 105:135 ~ "migrate", #4/15-5/15
                            day %in% 136:151 ~ "spawn", #5/16-5/31
                            day %in% 152:181 ~ "larvae", #6/1-6/30
                            day %in% 182:258 ~ "juvenile", #7/1-9/15
                            day %in% 259:334 ~ "fall_mig"), #9/15-11
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour))

coldo <- dodata %>%
  filter(site %in% c("TNC_23", "TNC_25", 
                     "TNC_24", "TNC_81", "TNC_80")) %>%
  mutate(monthf = as.factor(month)) %>%
    group_by(site, yearf, monthf, dayf, hourf) %>%
  summarize(mean_do = mean(do),
            .groups = "drop") %>%
  group_by(site, yearf, monthf, dayf) %>%
  summarize(mean_do = mean(mean_do),
            .groups = "drop") %>%
  tidyr::pivot_wider(names_from = "site", 
                     values_from = "mean_do") %>%
  mutate(d25.23 = TNC_25-TNC_23,
         d25.80 = TNC_25-TNC_80,
         d25.81 = TNC_25-TNC_81,
         stage = as.factor(case_when(yearf %in% 2016:2017 ~ 1,
                           yearf == 2018 & as.numeric(as.character(monthf))<7~1,
                           yearf == 2018 & as.numeric(as.character(monthf))>=7 |
                             yearf == 2019 & as.numeric(as.character(monthf))<5~2,
                           yearf == 2019 & as.numeric(as.character(monthf))>=5~3,
                           yearf %in% 2020:2021 ~ 3))
         )

rm(p)
```
# Plot A - Columbia Dam - Temperature upstream vs. downstream - raw data by year
upstream: TNC_23, downstream: TNC_25 (& 24), in: 80 & 81
first notch July 2018, completed April 2019
```{r}
col %>%
  ggplot() +
  geom_abline(intercept = 0, slope = 0, lty = 3, color = "steelblue")  +
  geom_boxplot(aes(y = d25.23, x = yearf), 
               fill = "steelblue", alpha = 0.5,
               color = "steelblue"
              ) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "Temp. difference (C)\n(downstream - upstream)",
       title = "Columbia Dam") 


# ggsave(here::here("output/Task3_project_impacts/",
#                   "PlotA_columbia_up_downstream_diff_by_year.png"),
#                   height = 4, width = 6, dpi = 400)

```
# PlotB_assessing variability in upstream/downstream temp diff by month/year
```{r}
col %>%
  ggplot() +
  geom_abline(intercept = 0, slope = 0, lty = 3, color = "steelblue")  +
  geom_boxplot(aes(x = monthf, 
                y = d25.23), 
               color = "steelblue", fill = "steelblue",
               alpha = 0.5) +
  facet_wrap(~yearf) + 
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white")) +
  labs(x = "", y = "Temp. difference (C)\n(downstream - upstream)",
       title = "Columbia Dam") +
  scale_x_discrete(breaks = c(3,6,9,12),
                     labels = c("Mar","Jun","Sep","Dec"))
  
# ggsave(here::here("output/Task3_project_impacts/",
#                   "PlotB_columbia_up_downstream_diff_by_year.png"),
#                   height = 5, width = 7, dpi = 400)
```

# Model A - Columbia Dam downstream/upstream BACI - by stage
Upstream: TNC_23
Downstream: TNC_25
```{r}

colt_jags <- col %>% 
  filter(is.na(d25.23) == F,
         monthf %in% 4:11) %>%
  droplevels()

colt_jags_data <- list(
  N = nrow(colt_jags),
  tdiff = colt_jags$d25.23,
  stage = as.numeric(as.character(colt_jags$stage)),
  year = as.numeric(colt_jags$yearf),
  month = as.numeric(as.character(colt_jags$monthf)),
  cov.mat = as.matrix(
    model.matrix(d25.23 ~ stage + monthf ,
                 data = colt_jags)[, c(2:10)]
  )
)

cat(file = "scripts/columbia_baci.txt", 
"
model{

  # likelihood
  for( i in 1:N ){
  tdiff[i] ~ dnorm(mu[i], tau[stage[i]])
  mu[i] <- beta0 + inprod(beta.cov[], cov.mat[i,])

  }
  
  # priors
  beta0 ~ dnorm(0, 1.0E-06)
  
  for( s in 1:3 ) {
  tau[s] ~ dgamma(1, 1)
  }
  
  for( m in 1:9 ){ 
  beta.cov[m] ~ dnorm(0, 1.0E-06)
  }
  
  # derrived
  mean_month <- (0+beta.cov[3]+beta.cov[4]+beta.cov[5]+beta.cov[6]+beta.cov[7]+beta.cov[8])/7
  
  mean_pre <- beta0 + mean_month
  mean_dur <- beta0 + beta.cov[1] + mean_month
  mean_post <- beta0 + beta.cov[2] + mean_month
  ba_diff <- mean_post - mean_pre

  for(s in 1:3){
  sigma[s] <- pow(tau[s], -0.5)
  }
  
}
"
)

colt_jags_mod <- jagsUI::jags(data = colt_jags_data,
             model.file = "scripts/columbia_baci.txt",
             n.iter = 3000, n.burnin = 1000,
             parameters.to.save = c("mean_pre",
                                    "mean_dur",
                                    "mean_post",
                                    "ba_diff",
                                    "beta0",
                                    "beta.cov",
                                    "sigma",
                                    "tau",
                                    "mean_month"),
             n.chains = 3, parallel = T, n.thin = 1
             ); colt_jags_mod

# DIC w/ month: ~500 
    # w/o month: ~550
dev.new(6,6);plot(colt_jags_mod)


# jagsUI::traceplot(colt_jags_mod)

# saveRDS(colt_jags_mod, here("output/Task3_project_impacts/",
#                             "statistical_analysis/",
#                           "ModelA_columbia_jags_tmod.rds"))
```
# Plot C estimated upstream/downstream tdiff by restoration stage
```{r}

col_jags_tmod_ni <- readRDS(here::here("output/Task3_project_impacts/",
                            "statistical_analysis/",
                          "ModelA_columbia_jags_tmod.rds"))

col_tdiff_plot <- 
  data.frame(draws = col_jags_tmod_ni$sims.list$mean_pre,
           var = "Before\nremoval") %>%
  bind_rows(
    data.frame(draws = col_jags_tmod_ni$sims.list$mean_dur,
           var = "During\nremoval")) %>%
  bind_rows(
  data.frame(draws = col_jags_tmod_ni$sims.list$mean_post,
           var = "After\nremoval")) %>%
  bind_rows(
  data.frame(draws = col_jags_tmod_ni$sims.list$ba_diff,
           var = "change")) %>%
  group_by(var) %>%
  summarise(mu = mean(draws),
            q2.5 = quantile(draws, 0.025),
            q10 = quantile(draws, 0.1),
            q50 = quantile(draws, 0.5),
            q90 = quantile(draws, 0.9),
            q97.5 = quantile(draws, 0.975)) %>%
  mutate(order = c(3,1,4,2),
         var = fct_reorder(var, order))

col_tdiff_plot %>%
  filter(var != "change") %>%
  ggplot() +
  geom_line(aes(x = var, y = mu, group = 1), 
            size = .75, lty = 2) +
  geom_errorbar(aes(x = var, ymin = q10, 
                    ymax = q90), width = 0, size = 1.5) +
  geom_errorbar(aes(x = var, ymin = q2.5, 
                    ymax = q97.5), width = 0, size = .75) +
  geom_point(aes(x = var, y = mu), size = 4) +

  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) + 
  annotate("text", x = 2.95, y = .46, 
           label = "Change = -0.33C\n(95% CI = -0.41, -0.25)",
           hjust = .5, color = "darkgray", size = 5) +  
  scale_y_continuous(limits = c(-0.05, 0.5)) +
  geom_hline(yintercept = 0, lty = 2, color = "darkgray") + 
  labs(x = "", 
       y = "Temperature difference (C)\n(downstream - upstream)",
       title = "Columbia Dam")

# ggsave(here::here("output/Task3_project_impacts/",
#                   "PlotC_columbia_river_temp_BACI_plot.png"),
#                   height = 4, width = 6, dpi = 400)
  
```
# Plot D estimated variability in upstream/downstream temp diff by restoration stage
Did the standard deviation (variability) of the upstream/downstream difference change pre- / post-restoration?
```{r}

col_jags_tmod_ni <- readRDS(here::here("output/Task3_project_impacts/",
                            "statistical_analysis/",
                          "ModelA_columbia_jags_tmod.rds"))

col_tdiff_plot_sd <- 
  data.frame(draws = col_jags_tmod_ni$sims.list$sigma[,1],
           var = "Before\nremoval") %>%
  bind_rows(
    data.frame(draws = col_jags_tmod_ni$sims.list$sigma[,2],
           var = "During\nremoval")) %>%
  bind_rows(
  data.frame(draws = col_jags_tmod_ni$sims.list$sigma[,3],
           var = "After\nremoval")) %>%
  bind_rows(
  data.frame(draws = col_jags_tmod_ni$sims.list$ba_diff,
           var = "change")) %>%
  group_by(var) %>%
  summarise(mu = mean(draws),
            q2.5 = quantile(draws, 0.025),
            q10 = quantile(draws, 0.1),
            q50 = quantile(draws, 0.5),
            q90 = quantile(draws, 0.9),
            q97.5 = quantile(draws, 0.975)) %>%
  mutate(order = c(3,1,4,2),
         var = fct_reorder(var, order))

col_tdiff_plot_sd %>%
  filter(var != "change") %>%
  ggplot() +
  geom_line(aes(x = var, y = mu, group = 1), 
            size = .75, lty = 2) +
  geom_errorbar(aes(x = var, ymin = q10, 
                    ymax = q90), width = 0, size = 1.5) +
  geom_errorbar(aes(x = var, ymin = q2.5, 
                    ymax = q97.5), width = 0, size = .75) +
  geom_point(aes(x = var, y = mu), size = 4) +

  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) + 
  scale_y_continuous(limits = c(0.1, 0.8)) +
  labs(x = "", 
       y = "Std. dev. temperature difference (C)\n(downstream - upstream)",
       title = "Columbia Dam")

# ggsave(here::here("output/Task3_project_impacts/",
#                   "PlotD_columbia_river_temp_SD_BACI_plot.png"),
#                   height = 4, width = 6, dpi = 400)
```
# Plot E - Columbia Dam - Temperature upstream vs. downstream - raw data by year
upstream: TNC_23, downstream: TNC_25 (& 24), in: 80 & 81
first notch July 2018, completed April 2019
```{r}
coldo %>%
  ggplot() +
  geom_abline(intercept = 0, slope = 0, lty = 3, color = "olivedrab")  +
  geom_boxplot(aes(y = d25.23, x = yearf), 
               fill = "olivedrab", alpha = 0.5,
               color = "olivedrab"
              ) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "DO difference (mg/L)\n(downstream - upstream)",
       title = "Columbia Dam") 


ggsave(here::here("output/Task3_project_impacts/",
                  "PlotE_columbia_up_downstream_DO_diff_by_year.png"),
                  height = 4, width = 6, dpi = 400)

```
# PlotF_assessing variability in upstream/downstream DO diff by month/year
```{r}
coldo %>%
  ggplot() +
  geom_abline(intercept = 0, slope = 0, lty = 3, color = "olivedrab")  +
  geom_boxplot(aes(x = monthf, 
                y = d25.23), 
               color = "olivedrab", fill = "olivedrab",
               alpha = 0.5) +
  facet_wrap(~yearf) + 
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white")) +
  labs(x = "", y = "DO difference (mg/L)\n(downstream - upstream)",
       title = "Columbia Dam") +
  scale_x_discrete(breaks = c(3,6,9,12),
                     labels = c("Mar","Jun","Sep","Dec"))
  
ggsave(here::here("output/Task3_project_impacts/",
                  "PlotF_columbia_up_downstream_DO_diff_by_month_year.png"),
                  height = 5, width = 7, dpi = 400)
```
# Model B - Columbia Dam downstream/upstream BACI - DO by stage
```{r}

coldo_jags <- coldo %>% 
  filter(is.na(d25.23) == F,
         monthf %in% 4:11) %>%
  droplevels()

coldo_jags_data <- list(
  N = nrow(coldo_jags),
  tdiff = coldo_jags$d25.23,
  stage = as.numeric(as.character(coldo_jags$stage)),
  year = as.numeric(coldo_jags$yearf),
  month = as.numeric(as.character(coldo_jags$monthf)),
  cov.mat = as.matrix(
    model.matrix(d25.23 ~ stage + monthf ,
                 data = coldo_jags)[, c(2:10)]
  )
)

coldo_jags_mod <- jagsUI::jags(data = coldo_jags_data,
             model.file = "scripts/columbia_baci.txt",
             n.iter = 3000, n.burnin = 1000,
             parameters.to.save = c("mean_pre",
                                    "mean_dur",
                                    "mean_post",
                                    "ba_diff",
                                    "beta0",
                                    "beta.cov",
                                    "sigma",
                                    "tau",
                                    "mean_month"),
             n.chains = 3, parallel = T, n.thin = 1
             ); coldo_jags_mod

 dev.new(6,6);plot(coldo_jags_mod)


# jagsUI::traceplot(coldo_jags_mod)

# saveRDS(coldo_jags_mod, here::here("output/Task3_project_impacts/",
#                             "statistical_analysis/",
#                           "ModelB_columbia_jags_domod.rds"))
```
# Plot F estimated upstream/downstream DO diff by restoration stage
```{r}

coldo_jags_mod <- readRDS(here::here("output/Task3_project_impacts/",
                            "statistical_analysis/",
                          "ModelB_columbia_jags_domod.rds"))

coldo_diff_plot <- 
  data.frame(draws = coldo_jags_mod$sims.list$mean_pre,
           var = "Before\nremoval") %>%
  bind_rows(
    data.frame(draws = coldo_jags_mod$sims.list$mean_dur,
           var = "During\nremoval")) %>%
  bind_rows(
  data.frame(draws = coldo_jags_mod$sims.list$mean_post,
           var = "After\nremoval")) %>%
  bind_rows(
  data.frame(draws = coldo_jags_mod$sims.list$ba_diff,
           var = "change")) %>%
  group_by(var) %>%
  summarise(mu = mean(draws),
            q2.5 = quantile(draws, 0.025),
            q10 = quantile(draws, 0.1),
            q50 = quantile(draws, 0.5),
            q90 = quantile(draws, 0.9),
            q97.5 = quantile(draws, 0.975)) %>%
  mutate(order = c(3,1,4,2),
         var = fct_reorder(var, order))

coldo_diff_plot %>%
  filter(var != "change") %>%
  ggplot() +
  geom_line(aes(x = var, y = mu, group = 1), 
            size = .75, lty = 2) +
  geom_errorbar(aes(x = var, ymin = q10, 
                    ymax = q90), width = 0, size = 1.5) +
  geom_errorbar(aes(x = var, ymin = q2.5, 
                    ymax = q97.5), width = 0, size = .75) +
  geom_point(aes(x = var, y = mu), size = 4) +

  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) + 
  annotate("text", x = 2.95, y = .4, 
           label = "Change = +0.18mg/L\n(95% CI = 0.08, 0.27)",
           hjust = .5, color = "darkgray", size = 5) +  
  geom_hline(yintercept = 0, lty = 2, color = "darkgray") + 
  labs(x = "", 
       y = "DO difference (mg/L)\n(downstream - upstream)",
       title = "Columbia Dam")

ggsave(here::here("output/Task3_project_impacts/",
                  "PlotG_columbia_river_DO_BACI_plot.png"),
                  height = 4, width = 6, dpi = 400)
  
```
# Plot H estimated variability (SD) in upstream/downstream DO diff by restoration stage
```{r}

coldo_jags_mod <- readRDS(here::here("output/Task3_project_impacts/",
                            "statistical_analysis/",
                          "ModelB_columbia_jags_domod.rds"))

coldo_diff_plot_sd <- 
  data.frame(draws = coldo_jags_mod$sims.list$sigma[,1],
           var = "Before\nremoval") %>%
  bind_rows(
    data.frame(draws = coldo_jags_mod$sims.list$sigma[,2],
           var = "During\nremoval")) %>%
  bind_rows(
  data.frame(draws = coldo_jags_mod$sims.list$sigma[,3],
           var = "After\nremoval")) %>%
  bind_rows(
  data.frame(draws = coldo_jags_mod$sims.list$ba_diff,
           var = "change")) %>%
  group_by(var) %>%
  summarise(mu = mean(draws),
            q2.5 = quantile(draws, 0.025),
            q10 = quantile(draws, 0.1),
            q50 = quantile(draws, 0.5),
            q90 = quantile(draws, 0.9),
            q97.5 = quantile(draws, 0.975)) %>%
  mutate(order = c(3,1,4,2),
         var = fct_reorder(var, order))

coldo_diff_plot_sd %>%
  filter(var != "change") %>%
  ggplot() +
  geom_line(aes(x = var, y = mu, group = 1), 
            size = .75, lty = 2) +
  geom_errorbar(aes(x = var, ymin = q10, 
                    ymax = q90), width = 0, size = 1.5) +
  geom_errorbar(aes(x = var, ymin = q2.5, 
                    ymax = q97.5), width = 0, size = .75) +
  geom_point(aes(x = var, y = mu), size = 4) +

  theme_bw() +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) + 
  # annotate("text", x = 2.95, y = .6, 
  #          label = "Change = +0.18mg/L\n(95% CI = 0.08, 0.27)",
  #          hjust = .5, color = "darkgray", size = 5) +  
  # geom_hline(yintercept = 0, lty = 2, color = "darkgray") + 
  scale_y_continuous(limits = c(0.4,0.8)) +
  labs(x = "", 
       y = "Std. dev. of DO difference (mg/L)\n(downstream - upstream)",
       title = "Columbia Dam")

ggsave(here::here("output/Task3_project_impacts/",
                  "PlotH_columbia_river_DO_SD_BACI_plot.png"),
                  height = 4, width = 6, dpi = 400)
  
```
# Plot I - Tree planting - upstream/downstream temp diff by month/year
```{r}
tree %>%
  filter(yearf != 2016,
         monthf %in% 5:9) %>%
  droplevels() %>%
  rename(val1 = d8.4) %>%
  group_by(yearf, monthf) %>%
  summarise(val = mean(val1, na.rm = T),
            sd = sd(val1, na.rm = T),
            n = length(is.na(val1)),
            se = sd/sqrt(n)) %>%
  mutate(mo = case_when(monthf == 5 ~ "May",
                        monthf == 6 ~ "Jun",
                        monthf == 7 ~ "Jul",
                        monthf == 8 ~ "Aug",
                        monthf == 9 ~ "Sep"),
         mo = fct_reorder(mo, as.numeric(monthf))) %>%
  ggplot() +
  geom_abline(intercept = 0, slope = 0, 
              lty = 2, color = "darkgray")  +
  geom_line(aes(x = yearf,
                y = val, color = mo,
                group = monthf),
               size = .75, lty = 1) +
  geom_point(aes(x = yearf, 
                y = val, 
                color = mo), 
               size = 4) +
  geom_errorbar(aes(x = yearf, 
                ymin = val-2*se, ymax = val+2*se,
                color = mo), 
               size = 1, width = 0) +
  # geom_smooth(aes(x = yearf, y = val, color = mo, group = mo), 
  #             method = "lm", 
  #             se = F, size = .5) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "Temp. difference (C)\n(downstream - upstream)",
       title = "Tree planting area",
       color = "Month") +
  scale_x_discrete(breaks = c(2017,2019,2021)) + 
  scale_color_manual(values = wes_palettes$Darjeeling1) +
 scale_y_continuous(limits = c(-0.5, 1.5))
  
# ggsave(here::here("output/Task3_project_impacts/",
#                   "PlotI_tree_planting_up_downstream_diff_by_mo_year.png"),
#                   height = 5, width = 7, dpi = 400)
```
# Plot J - Tree planting - upstream/within temp diff by month/year
```{r}
tree %>%
  filter(yearf %in% 2018:2021,
         monthf %in% 5:9) %>%
  droplevels() %>%
  rename(val1 = d5.4) %>%
  group_by(yearf, monthf) %>%
  summarise(val = mean(val1, na.rm = T),
            sd = sd(val1, na.rm = T),
            n = length(is.na(val1)),
            se = sd/sqrt(n)) %>%
  mutate(mo = case_when(monthf == 5 ~ "May",
                        monthf == 6 ~ "Jun",
                        monthf == 7 ~ "Jul",
                        monthf == 8 ~ "Aug",
                        monthf == 9 ~ "Sep"),
         mo = fct_reorder(mo, as.numeric(monthf))) %>%
  ggplot() +
  geom_abline(intercept = 0, slope = 0, 
              lty = 2, color = "darkgray")  +
  geom_line(aes(x = yearf,
                y = val, color = mo,
                group = monthf),
               size = .75, lty = 1) +
  geom_point(aes(x = yearf, 
                y = val, 
                color = mo), 
               size = 4) +
  geom_errorbar(aes(x = yearf, 
                ymin = val-2*se, ymax = val+2*se,
                color = mo), 
               size = 1, width = 0) +
  # geom_smooth(aes(x = yearf, y = val, color = mo, group = mo), 
  #             method = "lm", 
  #             se = F, size = .5) +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "", y = "Temp. difference (C)\n(restoration area - upstream)",
       title = "Tree planting area",
       color = "Month") +
  scale_x_discrete(breaks = c(2017,2019,2021)) + 
  scale_color_manual(values = wes_palettes$Darjeeling1) +
  scale_y_continuous(limits = c(-0.5, 1.5))
  
# ggsave(here::here("output/Task3_project_impacts/",
#                 "PlotJ_tree_planting_upstream_within_diff_by_mo_year.png"),
#                   height = 5, width = 7, dpi = 400)
```
# Plot K - Tree planting - downstream & within, raw temp by month/year
```{r}
tree %>%
  filter(yearf %in% 2016:2021,
         monthf %in% 5:9) %>%
  droplevels() %>%
  select(yearf, monthf, TNC_5, TNC_8) %>%
  pivot_longer(cols = c(TNC_5, TNC_8), names_to = "site",
               values_to = "val1") %>%
  group_by(yearf, monthf, site) %>%
  summarise(val = mean(val1, na.rm = T),
            sd = sd(val1, na.rm = T),
            n = length(is.na(val1)),
            se = sd/sqrt(n)) %>%
  mutate(mo = case_when(monthf == 5 ~ "May",
                        monthf == 6 ~ "Jun",
                        monthf == 7 ~ "Jul",
                        monthf == 8 ~ "Aug",
                        monthf == 9 ~ "Sep"),
         mo = fct_reorder(mo, as.numeric(monthf))) %>%
  ggplot() +
  geom_line(aes(x = yearf,
                y = val, color = mo,
                group = monthf),
               size = .75, lty = 1) +
  geom_point(aes(x = yearf, 
                y = val, 
                color = mo), 
               size = 4) +
  geom_errorbar(aes(x = yearf, 
                ymin = val-2*se, ymax = val+2*se,
                color = mo), 
               size = 1, width = 0) +
  facet_wrap(~site) +
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white")) +
  labs(x = "", y = "Mean temperature (C)\n+/- 2 SE",
       title = "Tree planting area",
       color = "Month") +
  scale_x_discrete(breaks = c(2017,2019,2021)) + 
  scale_color_manual(values = wes_palettes$Darjeeling1)
  
# ggsave(here::here("output/Task3_project_impacts/",
#                 "PlotK_tree_plant_downstream_within_temp_by_mo_year.png"),
#                   height = 5, width = 7, dpi = 400)
```


