---
title: "Task 0. Logger data import and QAQC"
author: "Mike Allen"
date: "1/4/2022"
output:
  html_document: default
  pdf_document: default
---
# Task 0: Load and compile all logger data

# How to run this code
Run the first section ("chunk") of this Rmd document (section 0.0). That will load all libraries and functions. After that, run each chunk sequentially until all the logger data is compiled, QC plots are created (and you are satisfied with the results), and the "compiled_logger_data.rds" file has been created. QC plots will save to the "Initial_QC" sub-folder in the "output" folder. If you see errors or data problems in files added after 2021, FIX THEM (for errors) or FLAG THEM (for spurious data) WITHIN THE ORIGINAL EXCEL FILE. After you are all done with that process, you do not need to run any code from Task 0 again unless you have more logger data you wish to add. All Rmd files after this one will source the compiled data from the rds file. 

## Errors discovered in 2016-2021 XLSX files 
The 2016-2021 data files that this code works on were downloaded from the Box folder on January 4-7, 2022. A few errors discovered in the 2016-2021 data files were fixed in the code (in chunk 0.1) except error no. 2, which was fixed in the xlsx file (a tab was renamed). For all code to work properly, these 2016-2021 data files should not be changed any further and any errors you discover in data added later (after 2021) should be fixed within the original excel file. Here are the 2016-2021 errors that were fixed in the code:

1. see 3 QC filter steps for hobo (section 0.1)
2. TNC_25_CLDHY_2_masterfile_2017.xlsx sheet name was "2021"
  note: I fixed this in the xlsx file to allow compile to run
3. possible naming issue in HYDRO data: is CLDHY-2 the same as CLDHY_2? In file: TNC_81_CLDHY2_2020_masterfile.xlsx (see section 0.4)

# 0.0. Load libraries and set logger data path
To load data from a new year, you will place the excel file into the folder linked to at the end of this code chunk (currently "data/Logger_Data"). It should be formatted exactly like the 2021 file from the corresponding logger type.
```{r}
library(dplyr)
library(here)
library(readxl)
library(lubridate)
library(ggplot2)
here <- here::here # set "here" function to be in "here" package
# load function to compile data files for hobo or hydro loggers 
source(here("scripts", "logger_compile_function.R"))
# load function to compile logger data from future (2022+) years
source(here("scripts", "future_compile_function.R"))
# load function to plot temp or do over time for each site/year 
source(here("scripts", "logger_plot_function.R"))
plotsave <- "output/Task0_Compile_Initial_QC/"

# set path to folder where the latest logger data files are kept
logger_path <- "data/Logger_Data/" 
```
# 0.1. Read and compile HOBO data using logger_compile function
This code section runs the "logger_compile" function on the HOBO logger data files from each year to compile data into one big data frame named "hobo". It has built in fixes for errors discovered in the data excel files from 2016-2021. So, any changes to those files will also require changes to this code. [Note: functionality to handle new years through 2026 exists as long as those data are identical in format and file/folder naming convention to the 2021 format. Adding data after that year will require editing the code below to add a new "future_compile" line.]
```{r}
# compile hobo logger data from 2016-2021
hobo <- logger_compile("2016", type = "hobo") %>%
  bind_rows(logger_compile("2017", type = "hobo")) %>%
  bind_rows(logger_compile("2018", type = "hobo")) %>%
  bind_rows(logger_compile("2019", type = "hobo")) %>%
  bind_rows(logger_compile("2020", type = "hobo")) %>%
  bind_rows(logger_compile("2021", type = "hobo")) %>%
  bind_rows(future_compile("2022", type = "hobo")) %>%
  bind_rows(future_compile("2023", type = "hobo")) %>%
  bind_rows(future_compile("2024", type = "hobo")) %>%
  bind_rows(future_compile("2025", type = "hobo")) %>%
  bind_rows(future_compile("2026", type = "hobo")) %>%
  # remove rows with year = NA (removes ~50k rows)
  filter(is.na(year) != TRUE) %>%
# fix for 10460 rows in TNC_24_CLDHO_1_2019_masterfile.xlsx
# with wrong year, site, and logger values (increasing sequentially)
  mutate(site = case_when(year != year(datetime) ~ "TNC_24",
                          TRUE ~ site),
         logger = case_when(year != year(datetime) ~ "CLDHO_1",
                            TRUE ~ logger),
         year = case_when(year != year(datetime) ~ year(datetime),
                          TRUE ~ year)) %>%
# fix name (TNC to TNC_16) in TNC_16_PKHO_10_2017_masterfile.xlsx
# affected 15372 rows
  mutate(site = case_when(site == "TNC" ~ "TNC_16",
                          TRUE ~ site)) %>%
  # remove 17952 rows from various files with large negative numbers
  filter(temp != -9999.00,
         temp != -888.88)

```
# 0.2. Various QC checks for HOBO data
This code section allows you to perform basic checks on the imported HOBO logger data (the 'hobo' object). It will work best to run each line individually (e.g., using ctrl-Enter in Windows). The output will appear in the RStudio Console. You can also view the hobo object by clicking on it in the RStudio Environment section.
```{r}
# examine the structure of the data frame
# including the name, data type, and example values for each variable

str(hobo)

# check which years are included
unique(hobo$year) # 2016:2021

# check which sites are included
unique(hobo$site)

# count how many sites are included
length(unique(hobo$site)) 

# check which logger ID's are included
unique(hobo$logger)

# count how many logger ID's are included
length(unique(hobo$logger))

# tally how many of each type of temperature flag there are
table(hobo$FLAG_temp)

# tally how many of each type of DO flag there are
table(hobo$FLAG_DO)

# tally how many of each type of 'other' flag there are
table(hobo$FLAG_other)

# tally how many of each type of 'cnt' flag there are
table(hobo$FLAG_cnt)

# make a data frame of all observations with DO flag 5
hobo_flag5 = hobo[hobo$FLAG_DO == 5,] # view it in the environment
rm(hobo_flag5) # remove that object when you are done
 
```
# 0.3. Plotting HOBO data by site for QC
Plots raw HOBO data by year (with and without flagged data)
```{r}
# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(filename = paste0(plotsave, "hobo_temp/", i, 
              "_hobo_temp.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "hobo_do/", i, "_hobo_do.png"), 
              width = 9, height = 9, dpi = 100)
}

# do the same but now without flagged data
# make versions of the data without any flagged observations
hobo_no_temp_flags <- hobo %>%
  filter(FLAG_temp == 0)

hobo_no_DO_flags <- hobo %>%
  filter(FLAG_DO == 0)

# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo_no_temp_flags, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(filename = paste0(plotsave, "hobo_temp/", i, 
              "_hobo_temp_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo_no_DO_flags, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "hobo_do/", i, 
              "_hobo_do_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

rm(hobo_no_temp_flags, hobo_no_DO_flags)
```
# 0.4. Read and compile HYDRO data using logger_compile function
```{r}

hydro <- logger_compile("2016", type = "hydro") %>%
  bind_rows(logger_compile("2017", type = "hydro")) %>%
  bind_rows(logger_compile("2018", type = "hydro")) %>%
  bind_rows(logger_compile("2019", type = "hydro")) %>%
  bind_rows(logger_compile("2020", type = "hydro")) %>%
  bind_rows(logger_compile("2021", type = "hydro")) %>%
  bind_rows(future_compile("2022", type = "hydro")) %>%
  bind_rows(future_compile("2023", type = "hydro")) %>%
  bind_rows(future_compile("2024", type = "hydro")) %>%
  bind_rows(future_compile("2025", type = "hydro")) %>%
  bind_rows(future_compile("2026", type = "hydro")) %>%
  # remove a 12 row with NA year (and other fields)
  filter(is.na(year) != TRUE,
         is.na(temp) != TRUE)

# note: TNC_25_CLDHY_2_masterfile_2017.xlsx sheet name was "2021"
#   I corrected it so the code would run; informed TNC

```
# 0.5. Various QC checks for HYDRO data
```{r}
str(hydro)
unique(hydro$year) # 2016 to max year
unique(hydro$site)
length(unique(hydro$site)) # should equal number of sites
unique(hydro$logger)
length(unique(hydro$logger)) # should equal number of loggers 
# note: possible logger naming issue: is CLDHY-2 the same as CLDHY_2?
# file: TNC_81_CLDHY2_2020_masterfile.xlsx
hydro[hydro$logger == "CLDHY-2",]
```
# 0.6. Plotting HYDRO data by site for QC
```{r}
# make all HYDRO temperature data by site & year for QC
for(i in as.character(unique(hydro$year))){
logger_plot(hydro, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "hydro_temp/", i, 
              "_hydro_temp.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HYDRO DO data by site & year for QC
for(i in as.character(unique(hydro$year))){
logger_plot(hydro, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "hydro_do/", i, "_hydro_do.png"), 
              width = 9, height = 9, dpi = 100)
}

# do the same but now without flagged data
# make versions of the data without any flagged observations
hydro_no_temp_flags <- hydro %>%
  filter(FLAG_Temp == 0)

hydro_no_DO_flags <- hydro %>%
  filter(FLAG_DO == 0)

# make all HYDRO temperature data by site & year for QC (w/o flags)
for(i in as.character(unique(hydro$year))){
logger_plot(hydro_no_temp_flags, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "hydro_temp/", i, "_hydro_temp_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HYDRO DO data by site & year for QC (w/o flags)
for(i in as.character(unique(hydro$year))){
logger_plot(hydro_no_DO_flags, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "hydro_do/", i, 
              "_hydro_do_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

rm(hydro_no_temp_flags, hydro_no_DO_flags)
```
# 0.7. Read and compile PLDEUR data using logger_compile function
```{r}
# Compile all existing PLDEUR logger data
pldeur <- logger_compile("2016", type = "pldeur") %>%
  bind_rows(logger_compile("2017", type = "pldeur")) %>%
  bind_rows(logger_compile("2018", type = "pldeur")) %>%
  bind_rows(logger_compile("2019", type = "pldeur")) %>%
  bind_rows(logger_compile("2020", type = "pldeur")) %>%
  bind_rows(logger_compile("2021", type = "pldeur")) %>%
  bind_rows(future_compile("2022", type = "pldeur")) %>%
  bind_rows(future_compile("2023", type = "pldeur")) %>%
  bind_rows(future_compile("2024", type = "pldeur")) %>%
  bind_rows(future_compile("2025", type = "pldeur")) %>%
  bind_rows(future_compile("2026", type = "pldeur")) %>%
  # remove rows with NA year (and other fields)
  filter(is.na(year) != TRUE,
         is.na(temp) != TRUE)
```
# 0.8. Various QC checks for PLDEUR data
```{r}
str(pldeur)
unique(pldeur$year) # 2016 to max year
unique(pldeur$site)
length(unique(pldeur$site)) # should equal number of sites
unique(pldeur$logger)
length(unique(pldeur$logger)) # should equal number of loggers 
```
# 0.9. Plotting PLDEUR data by site for QC
```{r}
# make plots of all PLDEUR temperature data by site & year for QC
for(i in as.character(unique(pldeur$year))){
logger_plot(pldeur, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "pldeur_temp/", i, 
              "_pldeur_temp.png"), 
              width = 9, height = 9, dpi = 100)
}

# do the same but now without flagged data
# make versions of the data without any flagged observations
pldeur_no_temp_flags <- hydro %>%
  filter(FLAG_Temp == 0)

# make all PLDEUR temperature data by site & year for QC (w/o flags)
for(i in as.character(unique(pldeur$year))){
logger_plot(pldeur_no_temp_flags, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(paste0(plotsave, "pldeur_temp/", i, "_pldeur_temp_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

rm(pldeur_no_temp_flags)
```
# 0.10. Make final compiled logger data file with temp, turb, & DO
```{r}
p <- hobo %>%
  select(site, year, datetime, logger, temp, do, do_adj, do_sat,
         FLAG_Temp = FLAG_temp, FLAG_DO) %>%
  mutate(spcon = NA, turb = NA, FLAG_NTU = NA, FLAG_SpCnd = NA,
         logger_type = "hobo") %>%
  bind_rows(mutate(hydro, logger_type = "hydro")) %>%
  bind_rows(mutate(pldeur, spcon = NA, FLAG_SpCnd = NA, 
                   do = NA, do_adj = NA,
                   do_sat = NA, FLAG_DO = NA,
                   logger_type = "pldeur")) %>%
  select(site:logger_type)

saveRDS(p, "output/compiled_logger_data.rds")
```
# 0.11. plot temperature time series for each site/year vs. thresholds (showing loggers)
```{r}
unique(p$site)
#  [1] "TNC_10" "TNC_18" "TNC_19" "TNC_2"  "TNC_28" "TNC_5"  "TNC_8" 
#  [8] "TNC_9"  "TNC_16" "TNC_24" "TNC_4"  "TNC_13" "TNC_81" "TNC_80"
# [15] "TNC_23" "TNC_25" "TNC_26" "TNC_27"

for(station in unique(p$site)){
  
# station = "TNC_80"
p %>%
  filter(FLAG_Temp == 0,
         site == station) %>%
  ggplot() +
  geom_hline(yintercept = 22, color = "gray", lty = 3, size = 1) +
  geom_hline(yintercept = 25, color = "gray", lty = 2, size = 1) +
  geom_hline(yintercept = 31, color = "gray", lty = 1, size = 1) +  geom_point(aes(x = yday(datetime), y = temp, color = logger), 
             shape = 1, alpha = 0.5, size = 0.1) +
  facet_wrap(~year) +
  scale_color_manual(values = wes_palette("Darjeeling1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = "none",
        strip.background = element_rect(fill = "white")) +
  labs(y = "Temperature (degrees C)", x = "Day of year",
       title = station) +
  scale_y_continuous(limits = c(0,35))

ggsave(paste0(plotsave, "temp_by_date_year_site_logger/", 
              station, "_temp.png"),
       height = 6, width = 6, dpi = 400)
}
```
# 0.12. plot DO time series for each site/year vs. thresholds (showing loggers)
```{r}
unique(p$site)
#  [1] "TNC_10" "TNC_18" "TNC_19" "TNC_2"  "TNC_28" "TNC_5"  "TNC_8" 
#  [8] "TNC_9"  "TNC_16" "TNC_24" "TNC_4"  "TNC_13" "TNC_81" "TNC_80"
# [15] "TNC_23" "TNC_25" "TNC_26" "TNC_27"

for(station in unique(p$site)){
  print(paste0("working on... ", station))
# station = "TNC_2"
p %>%
  filter(FLAG_DO == 0,
         site == station) %>%
  ggplot() +
  geom_hline(yintercept = 7, color = "gray", lty = 3, size = 1) +
  geom_hline(yintercept = 5, color = "gray", lty = 2, size = 1) +
  geom_hline(yintercept = 4, color = "gray", lty = 1, size = 1) +  geom_point(aes(x = yday(datetime), y = do, color = logger), 
             shape = 1, alpha = 0.5, size = 0.1) +
  facet_wrap(~year) +
  scale_color_manual(values = wes_palette("Darjeeling1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = "none",
        strip.background = element_rect(fill = "white")) +
  labs(y = "Dissolved Oxygen", x = "Day of year",
       title = station) +
  scale_y_continuous(limits = c(0,17))

ggsave(paste0(plotsave, "DO_by_date_year_site_logger/", 
              station, "_DO.png"),
       height = 6, width = 6, dpi = 400)
}
```
# 0.13. plot DO (adjusted) time series for each site/year vs. thresholds (showing loggers)
```{r}
unique(p$site)
#  [1] "TNC_10" "TNC_18" "TNC_19" "TNC_2"  "TNC_28" "TNC_5"  "TNC_8" 
#  [8] "TNC_9"  "TNC_16" "TNC_24" "TNC_4"  "TNC_13" "TNC_81" "TNC_80"
# [15] "TNC_23" "TNC_25" "TNC_26" "TNC_27"

for(station in unique(p$site)){
  print(paste0("working on... ", station))
# station = "TNC_2"
p %>%
  filter(FLAG_DO == 0,
         site == station) %>%
  ggplot() +
  geom_hline(yintercept = 7, color = "gray", lty = 3, size = 1) +
  geom_hline(yintercept = 5, color = "gray", lty = 2, size = 1) +
  geom_hline(yintercept = 4, color = "gray", lty = 1, size = 1) +  geom_point(aes(x = yday(datetime), y = do_adj, color = logger), 
             shape = 1, alpha = 0.5, size = 0.1) +
  facet_wrap(~year) +
  scale_color_manual(values = wes_palette("Darjeeling1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = "none",
        strip.background = element_rect(fill = "white")) +
  labs(y = "Dissolved Oxygen (adjusted)", x = "Day of year",
       title = station) +
  scale_y_continuous(limits = c(0,17))

ggsave(paste0(plotsave, "DO_by_date_year_site_logger/", 
              station, "_DOadj.png"),
       height = 6, width = 6, dpi = 400)
}
```