---
title: "Invertebrates"
author: "Mike Allen"
date: "4/28/2022"
output: html_document
---
# Task 4: Macroinvertebrates and quality scores
a. Visualize and perform statistical analysis of macroinvertebrate and EPA Habitat Assessment scores, including assessing spatial patterns and temporal trends. 

1. Where do sites fall on the optimum/excellent to poor spectrum? 
2. How are scores changing over time at the level of the
individual site and within the broader network as a whole?

b. How are the individual component metrics contributing to the resulting macroinvertebrate and EPA Habitat Assessment scores at the sites? 

For example, are all “Poor” sites classified as such for
the same reason or are there a range of contributing factors?

# Load libraries and read in data
```{r}
library(readxl)
library(dplyr)
library(ggplot2)
library(here)
library(lubridate)
library(forcats)
library(GGally)
library(fmsb)
library(wesanderson)

task_path <- "output/Task4_inverts_and_habitat/"

# Read in Macroinvertebrate data
inv16 <- read_xlsx(here("other",
                        "Macro_Habitat_data_dl_20220428",
                        "macro_habitat_data_2016_2017.xlsx"),
                   skip = 2, 
                   sheet = "macro_2016"
                   ) %>%
  select(c(3,4,32:40)) %>%
  rename(num_gen = 3,
         pct_noninsect = 4,
         pct_ept = 5,
         num_scraper = 6,
         hilsenhoff = 7,
         num_talu2 = 8,
         num_talu3 = 9,
         index = 10,
         rating = 11
         )

inv17 <- read_xlsx(here("other",
                        "Macro_Habitat_data_dl_20220428",
                        "macro_habitat_data_2016_2017.xlsx"),
                   skip = 3, 
                   sheet = "macro_2017"
                   ) %>%
  select(c(3,4,32:40)) %>%
  rename(tnc_code = 1,
         date = 2,
         num_gen = 3,
         pct_noninsect = 4,
         pct_ept = 5,
         num_scraper = 6,
         hilsenhoff = 7,
         num_talu2 = 8,
         num_talu3 = 9,
         index = 10,
         rating = 11
         )
 
inv18 <- read_xlsx(here("other",
                        "Macro_Habitat_data_dl_20220428",
                        "macro_habitat_data_2018_2019.xlsx"),
                   skip = 3, 
                   sheet = "macro_2018"
                   ) %>%
  select(c(3,4,32:40)) %>%
  rename(tnc_code = 1,
         date = 2,
         num_gen = 3,
         pct_noninsect = 4,
         pct_ept = 5,
         num_scraper = 6,
         hilsenhoff = 7,
         num_talu2 = 8,
         num_talu3 = 9,
         index = 10,
         rating = 11
         ) %>%
  filter(is.na(tnc_code) == F)

inv19 <- read_xlsx(here("other",
                        "Macro_Habitat_data_dl_20220428",
                        "macro_habitat_data_2018_2019.xlsx"),
                   skip = 2, 
                   sheet = "macro_2019"
                   ) %>%
  select(c(3,4,32:40)+1) %>%
  rename(num_gen = 3,
         pct_noninsect = 4,
         pct_ept = 5,
         num_scraper = 6,
         hilsenhoff = 7,
         num_talu2 = 8,
         num_talu3 = 9,
         index = 10,
         rating = 11
         )

inv <- inv16 %>%
  bind_rows(inv17) %>%
  bind_rows(inv18) %>%
  bind_rows(inv19) %>%
  mutate(year = year(date),
         yearf = as.factor(year)) %>%
  mutate(yearf = fct_reorder(yearf, index, .fun = "mean"),
         tnc_code = fct_reorder(tnc_code, index, .fun = "mean"),
         rating = case_when(rating == "EXCELLENT" ~ "Excellent",
                            rating == "GOOD" ~ "Good",
                            rating == "FAIR" ~ "Fair",
                            rating == "POOR" ~ "Poor",
                            TRUE ~ rating),
         rating_col = case_when(rating == "Excellent" ~ "green",
                            rating == "Good" ~ "darkgreen",
                            rating == "Fair" ~ "orange",
                            rating == "Poor" ~ "firebrick"))

rm(inv16, inv17, inv18, inv19)

# Read in habitat data
hab16 <- read_xlsx(here("other",
                        "Macro_Habitat_data_dl_20220428",
                        "macro_habitat_data_2016_2017.xlsx"),
                   skip = 0, 
                   sheet = "Habitat_2016"
                   ) %>%
  select(c(3:17,19:20)) %>%
  rename(epifaunal_sub = 3,
         pool_sub = 4,
         pool_var = 5,
         sed_dep = 6,
         channel_flow = 7,
         channel_alt = 8,
         channel_sin = 9,
         bank_stab_l = 10,
         bank_stab_r = 11,
         bank_veg_l = 12,
         bank_veg_r = 13,
         rip_veg_l = 14,
         rip_veg_r = 15)

# Read in habitat data
hab17 <- read_xlsx(here("other",
                        "Macro_Habitat_data_dl_20220428",
                        "macro_habitat_data_2016_2017.xlsx"),
                   skip = 0, 
                   sheet = "Habitat_2017"
                   ) %>%
  select(c(3:17,19:20)) %>%
  rename(epifaunal_sub = 3,
         pool_sub = 4,
         pool_var = 5,
         sed_dep = 6,
         channel_flow = 7,
         channel_alt = 8,
         channel_sin = 9,
         bank_stab_l = 10,
         bank_stab_r = 11,
         bank_veg_l = 12,
         bank_veg_r = 13,
         rip_veg_l = 14,
         rip_veg_r = 15)


```
# Plot A - dot plot of overall index average by site/year
```{r}

inv %>%
  group_by(tnc_code) %>%
  summarize(index_mean = mean(index),
            min = min(index),
            max = max(index),
            n = length(index)) %>%
  mutate(n2 = paste0(c(rep("",20),"n = "), n)) %>%
  ggplot() +
  geom_errorbar(aes(xmin = min, xmax = max, y = tnc_code),
                width = 0, color = "black",
                size = .75) +  
  geom_point(aes(x = index_mean, y = tnc_code),
             size = 3, fill = "skyblue", shape = 21) +

  theme_bw() +
  labs(y = "", x = "Macroinvertebrate Index") +
  geom_text(aes(x = 110, y = tnc_code, label = n2),
            color = "darkgray", hjust = 1)

# ggsave(here(task_path,
#             "PlotA_mean_macroinvertebrate_index_by_site.png"),
#        height = 4, width = 3, dpi = 400)
```
# Macroinvertebrate index table1
values by site & year
```{r}

```

# Macroinvertebrate index table2
mean/sd/min/max/n values by site
```{r}

```
#PlotB - data visualization of index components
Scatterplot matrix to inspect data
```{r}

# ggpairs plot. Found code here:
# https://www.r-bloggers.com/2016/02/multiple-regression-lines-in-ggpairs/
my_smooth_fn <- function(data, mapping, ...){
  p <- ggplot(data = data, mapping = mapping) + 
    geom_point(color = "steelblue", alpha = 0.5, 
               shape = 1, size = 1) + 
    # geom_density_2d(color = "black", size = 0.5, alpha = 0.5) +
    geom_smooth(method=loess, fill="steelblue", color="black", size = 0.5, ...)
  p
}

my_bar_fn <- function(data, mapping, ...){
  the_mean <- mean(data)
  p <- ggplot(data = data, mapping = mapping) + 
    geom_histogram(color = "darkblue", 
                   fill = "steelblue", alpha = 0.5, bins = 15) +
    geom_vline(xintercept = mean(data$x), color = "red")
}

#require(scales)
options(scipen=10000, digits = 0)
g = ggpairs(inv, columns = 3:9, 
            lower = list(continuous = my_smooth_fn),
            diag = list(continuous = my_bar_fn),
            upper = list(continuous = wrap("cor", method = "spearman")),
            columnLabels = c("No. genera",
                             "% non-insects",
                             "% sens. EPT",
                             "No. scrapers",
                             "Hilsenhoff",
                             "No. TALU 2",
                             "No. TALU 3")
            ) +
  theme_bw()
g

# ggsave(plot = g, here(task_path, 
#                "PlotB_macroinvertebrate_scatterplot_matrix.png"), 
#        dpi = 400, width = 7, height = 7)

rm(g)
```
# Plot C - Spiderweb plot of macroinvertebrate index
Code from: https://r-graph-gallery.com/142-basic-radar-chart.html
```{r}
# format data
inv_radar <- inv %>%
  select(c(1, 3:9)) %>%
  group_by(tnc_code) %>%
  summarize_all(mean)


for(i in 1:nrow(inv_radar)){

print(i)

the_title <- as.character(inv_radar$tnc_code[i])

png(here(task_path, 
         "PlotC_macro_radar_plots",
         paste0("PlotC_", the_title, "_macro_radar.png")), res = 400,
    height = 5, width = 5, units = "in")

# data
data <- inv_radar[i,2:8]

# add 2 lines to the dataframe: the max and min you want to show on the plot
data <- rbind(rep(100,7) , rep(0,7) , data)
 
# Make the radarChart !
radarchart( data  , axistype=1 , maxmin = T,
 
    #custom polygon
    pcol=rgb(0.2,0.5,0.5,0.9) , pfcol=rgb(0.2,0.5,0.5,0.5) , plwd=4 , 
 
    #custom the grid
    cglcol="grey", cglty=1, axislabcol="grey", caxislabels=seq(0,100,25),
    cglwd=0.8,
 
    #custom labels
    vlcex=0.8, title = the_title
    )
dev.off()
}
```
# Plot D - macroinvertebrate index over time (separate plots by site)
```{r}
for(i in unique(inv$tnc_code)){

print(i)

color_vector <- c("olivedrab",
            "olivedrab2",
            wes_palettes$BottleRocket2[1:2])

all_colors <- data.frame(
    rating = c("Excellent", "Good", "Fair", "Poor"),
    col = color_vector,
    year = 2017,
    index = 200)


the_colors = inv %>%
  filter(tnc_code == i) %>%
  select(rating) %>%
  distinct() %>%
  arrange(rating) %>%
    left_join(all_colors, by = "rating")


inv %>%
  filter(tnc_code == i) %>%
  group_by(year) %>%
  summarize(index = mean(index)) %>%
  ggplot() +
  geom_line(aes(x = year, y = index), 
            color = "darkgray",
            size = 1) +
  geom_point(aes(x = year, y = index, color = rating), 
            size = 4, data = filter(inv, tnc_code == i)) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_manual(values = the_colors$col) +
    theme_bw() +
    theme(text = element_text(size = 14)) +
    labs(y = "Macroinvertebrate Index", x = "",
         color = "Rating",
         title = i)

  ggsave(here(task_path, "PlotD_macro_by_year",
              paste0("PlotD_macro_by_year_site_", i, ".png")),
         width = 6, height = 4, dpi = 400)
}

```
# Plot E - macroinvertebrate index over time at Columbia Dam sites
```{r}
sites <- c("TNC_25", "TNC_23")
inv %>%
  filter(tnc_code %in% sites) %>%
  group_by(tnc_code, year) %>%
  summarize(index = mean(index)) %>%
  ggplot() +
  geom_line(aes(x = year, y = index, color = tnc_code), 
            size = 1) +
  geom_point(aes(x = year, y = index, color = tnc_code), 
            size = 4) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_manual(values = c("olivedrab", "orange")) +
    theme_bw() +
    theme(text = element_text(size = 14)) +
    labs(y = "Macroinvertebrate Index", x = "",
         title = "Columbia Dam", color = "")

  ggsave(here(task_path, 
              "PlotE_macro_by_year_Columbia_Dam.png"),
         width = 6, height = 4, dpi = 400)

```
# Plot F - macroinvertebrate index over time at Paulina Dam sites
```{r}
sites <- c("TNC_18", "TNC_19")
inv %>%
  filter(tnc_code %in% sites) %>%
  group_by(tnc_code, year) %>%
  summarize(index = mean(index)) %>%
  ggplot() +
  geom_line(aes(x = year, y = index, color = tnc_code), 
            size = 1) +
  geom_point(aes(x = year, y = index, color = tnc_code), 
            size = 4) +
  scale_y_continuous(limits = c(0, 100)) +
  scale_color_manual(values = c("olivedrab", "orange")) +
    theme_bw() +
    theme(text = element_text(size = 14)) +
    labs(y = "Macroinvertebrate Index", x = "",
         title = "Paulina Dam", color = "")

  ggsave(here(task_path, 
              "PlotE_macro_by_year_Paulina_Dam.png"),
         width = 6, height = 4, dpi = 400)

```
