---
title: "Task 2. migratory species"
author: "Mike Allen"
date: "2/28/2022"
output:
  html_document: default
  pdf_document: default
---
# To Do
1. lmer check about making year random effect too
2. lmer for dissolved oxygen
3. redo plot F with larvae stage

#Task 2: Site specific water quality conditions important to us other than SWQS
a. Determine which sites are more supportive of migrating species during key lifecycle periods over time
spring adult migration (~ 15 Apr - 15 May) 
spring spawning (~ 16-31 May)
summer fry stage (~ 1 Jun - 15 Sep; ~ 1 mo. larval, ~ 3 mo. juv.)
fall fry migration (~ 16 Sep - 30 Nov)

i. What is the daily min, max, mean temperature and dissolved oxygen?

b. Determine which sites are more likely not to thermally stress sensitive species during peak summer temperatures?
i. For the period of July 1- Sept 15
1. What’s the daily max?

c. What is the daily mean, min, and max temperatures?

d. What is the monthly mean temperature?

e. What is the annual mean temperature?

f. Are there significant changes to daily, monthly and annual mean temperature and dissolved oxygen over time (year to year, across all years sampled)?

g. How can we characterize seasonal variation over time and what differences, or patterns do we see in seasonal variation across the years?


# Product 2:
• Evaluate the water quality characteristics highlighted in Task 2 with respect to the needs of key migratory species.
• Meetings as needed to refine objectives and desired outputs.
• Data visualization (figures, maps, plots) and statistical analysis to compare same across sites and assess trends through time, along with associated interpretative text.

# Load libraries, format data, etc.
```{r}
library(dplyr)
library(knitr)
library(kableExtra)
library(wesanderson)
library(lubridate)
library(ggplot2)
library(forcats)
library(lme4)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tdata <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60) %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  # right_join(expand.grid(site = unique(p$site), 
  #                        year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  # peak movement ~ 15 April - 15 May in Raritan per Anthony V.
  mutate(season = case_when(day %in% 105:135 ~ "migrate", #4/15-5/15
                            day %in% 136:151 ~ "spawn", #5/16-5/31
                            day %in% 152:181 ~ "larvae", #6/1-6/30
                            day %in% 182:258 ~ "juvenile", #7/1-9/15
                            day %in% 259:334 ~ "fall_mig"), #9/15-11
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour),
         season = as.factor(season))

# summarize data by day
tsum <- tdata %>%
    group_by(site, yearf, month, day, dayf) %>%
  summarise(min_temp = min(temp, na.rm = T),
            max_temp = max(temp, na.rm = T),
            mean_temp = mean(temp, na.rm = T),
            .groups = "drop") 

# summarize daily temp data by month
tsum_month <- tsum %>%
  group_by(site, yearf, month) %>%
  summarize(mean_mean = mean(mean_temp),
            mean_max = mean(max_temp),
            mean_min = mean(min_temp),
            n = length(mean_temp),
            .groups = "drop") %>%
  mutate(mid = case_when(month == 3 ~ yday("2021-03-15"),
                         month == 4 ~ yday("2021-04-15"),
                         month == 5 ~ yday("2021-05-15"),
                         month == 6 ~ yday("2021-06-15"),
                         month == 7 ~ yday("2021-07-15"),
                         month == 8 ~ yday("2021-08-15"),
                         month == 9 ~ yday("2021-09-15"),
                         month == 10 ~ yday("2021-10-15"),
                         month == 11 ~ yday("2021-11-15")
                         )) %>%
  mutate(Month = case_when(month == 4 ~ "April",
                           month == 5 ~ "May",
                           month == 6 ~ "June",
                           month == 7 ~ "July",
                           month == 8 ~ "August",
                           month == 9 ~ "September",
                           month == 10 ~ "October",
                           month == 11 ~ "November",
                           month == 12 ~ "December"))

# summarize daily temp data by fish life history season
tsum_season <- tdata %>%
    group_by(site, yearf, season, day, dayf) %>%
  summarise(min_temp = min(temp, na.rm = T),
            max_temp = max(temp, na.rm = T),
            mean_temp = mean(temp, na.rm = T),
            .groups = "drop")  %>%
  group_by(site, yearf, season) %>%
  summarize(mean_mean = mean(mean_temp),
            mean_max = mean(max_temp),
            mean_min = mean(min_temp),
            max_max = max(max_temp),
            min_min = min(min_temp),
            n = length(mean_temp),
            .groups = "drop") %>%
  mutate(order = case_when(season == "migrate" ~ 1,
                           season == "spawn" ~ 2,
                           season == "larvae" ~ 3,
                           season == "juvenile" ~ 4,
                           season == "fall_mig" ~ 5),
         season2 = case_when(season == "migrate" ~ "Migrate (S)",
                           season == "spawn" ~ "Spawn",
                           season == "larvae" ~ "Larvae",
                           season == "juvenile" ~ "Juvenile",
                           season == "fall_mig" ~ "Migrate (F)"),
         season2 = fct_reorder(season2, order))

# format final compiled DO data
dodata <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60,
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  select(-do, -do_adj) %>%
  rename(do = do_adj2) %>%
  # right_join(expand.grid(site = unique(p$site), 
  #                        year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
    # Dates based on Anthony V. and shad reference he provided
  mutate(season = case_when(day %in% 105:135 ~ "migrate", #4/15-5/15
                            day %in% 136:151 ~ "spawn", #5/16-5/31
                            day %in% 152:181 ~ "larvae", #6/1-6/30
                            day %in% 182:258 ~ "juvenile", #7/1-9/15
                            day %in% 259:334 ~ "fall_mig"), #9/15-11
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour))
  
# summarize DO data by day
dosum <- dodata %>%
    group_by(site, yearf, month, day, dayf) %>%
  summarise(min_do = min(do, na.rm = T),
            mean_do = mean(do, na.rm = T),
            max_do = max(do, na.rm = T),
            .groups = "drop") %>%
  arrange(site, yearf, day)

# summarize daily DO data by month
dosum_month <- dosum %>%
  group_by(site, yearf, month) %>%
  summarize(mean_mean = mean(mean_do),
            mean_max = mean(max_do),
            mean_min = mean(min_do),
            n = length(mean_do),
            .groups = "drop") %>%
  mutate(mid = case_when(month == 3 ~ yday("2021-03-15"),
                         month == 4 ~ yday("2021-04-15"),
                         month == 5 ~ yday("2021-05-15"),
                         month == 6 ~ yday("2021-06-15"),
                         month == 7 ~ yday("2021-07-15"),
                         month == 8 ~ yday("2021-08-15"),
                         month == 9 ~ yday("2021-09-15"),
                         month == 10 ~ yday("2021-10-15"),
                         month == 11 ~ yday("2021-11-15")
                         ))

# summarize daily DO data by fish life history season
dosum_season <- dodata %>%
    group_by(site, yearf, season, day, dayf) %>%
  summarise(min_do = min(do, na.rm = T),
            max_do = max(do, na.rm = T),
            mean_do = mean(do, na.rm = T),
            .groups = "drop")  %>%
  group_by(site, yearf, season) %>%
  summarize(mean_mean = mean(mean_do),
            mean_max = mean(max_do),
            mean_min = mean(min_do),
            n = length(mean_do),
            .groups = "drop") %>%
  mutate(order = case_when(season == "migrate" ~ 1,
                           season == "spawn" ~ 2,
                           season == "larvae" ~ 3,
                           season == "juvenile" ~ 4,
                           season == "fall_mig" ~ 5),
         season2 = case_when(season == "migrate" ~ "Migrate (S)",
                           season == "spawn" ~ "Spawn",
                           season == "larvae" ~ "Larvae",
                           season == "juvenile" ~ "Juvenile",
                           season == "fall_mig" ~ "Migrate (F)"),
         season2 = fct_reorder(season2, order))

rm(p)
```
i. What is the daily min, max, mean temperature and dissolved oxygen?
```{r}
sites <- unique(tdata$site)

i = sites[2]
for(i in sites){
# x11(8,5); 
print(i)
tsum %>%
  filter(site == i) %>%
  ggplot() +
  geom_errorbar(aes(x = day, ymin = min_temp, ymax = max_temp),
                width = 0, size = .3, color = "firebrick",
                alpha = 0.4) +  
  geom_point(aes(x = day, y = mean_temp), size = .5,
             color = "firebrick", shape = 18, alpha = 1) +
  geom_errorbar(aes(x = mid, ymin = mean_min, ymax = mean_max),
                width = 0, size = .5, color = "black",
                data = filter(tsum_month, site == i)) +  
  geom_point(aes(x = mid, y = mean_mean), size = 2,
             color = "black", shape = 16,
             data = filter(tsum_month, site == i)) +
  facet_wrap(~yearf) +
  theme_minimal() +
  labs(x = "", y = "Daily & monthly temperatures",
       title = i) +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
  scale_y_continuous(breaks = seq(0,30, by = 10),
                     limits = c(0,32)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    limits = c(82, 339),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  )

ggsave(paste0("output/Task2_WQ_migratory_species/PlotA/PlotA_",i,"_daily_monthly_temps.png"), height = 5, width = 8, dpi = 400)
}

```
# Plot monthy mean temperatures for each site
```{r}
sites <- unique(tdata$site)

tsum_envelope <- tdata %>%
  group_by(site, day) %>%
  summarize(multi_min = min(temp),
            multi_max = max(temp),
            .groups = "drop")

i = sites[1]

for( i in sites ) {
print(i)
tsum_month %>%
  filter(site == i) %>%
  ggplot() +
  geom_ribbon(aes(x = day, ymax = multi_max,
                  ymin = multi_min), 
              data = filter(tsum_envelope, site == i),
              fill = "gray", alpha = 0.5) +
  geom_line(aes(x = mid, y = mean_mean, color = yearf), size = .5,
             shape = 16,
             position = position_dodge(width = 10)) +      
  geom_point(aes(x = mid, y = mean_mean, color = yearf), size = 2,
             shape = 16,
             position = position_dodge(width = 10)) +
  theme_minimal() +
  labs(x = "", y = "Mean monthly temperature",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
    scale_y_continuous(breaks = seq(0,30, by = 10),
                     limits = c(0,32)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    limits = c(82, 339),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  scale_color_manual(values = c(wes_palettes$Royal1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotB/PlotB_",i,"_monthly_temps.png"), height = 5, width = 7, dpi = 400)
}


```

# do monthly and daily
```{r}
sites <- unique(dodata$site)

i = sites[2]

for(i in sites){
# x11(8,5); 
print(i)
dosum %>%
  filter(site == i) %>%
  ggplot() +
  geom_errorbar(aes(x = day, ymin = min_do, ymax = max_do),
                width = 0, size = .3, color = "dodgerblue",
                alpha = 0.4) +  
  geom_point(aes(x = day, y = mean_do), size = .5,
             color = "dodgerblue", shape = 18, alpha = 1) +
  geom_errorbar(aes(x = mid, ymin = mean_min, ymax = mean_max),
                width = 0, size = .5, color = "black",
                data = filter(dosum_month, site == i)) +  
  geom_point(aes(x = mid, y = mean_mean), size = 2,
             color = "black", shape = 16,
             data = filter(dosum_month, site == i)) +
  facet_wrap(~yearf) +
  theme_minimal() +
  labs(x = "", y = "Daily & monthly dissolved oxygen",
       title = i) +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
  scale_y_continuous(breaks = seq(0,16, by = 4),
                     limits = c(0,16.5)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    limits = c(82, 339),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  )

ggsave(paste0("output/Task2_WQ_migratory_species/PlotC/PlotC_",i,"_daily_monthly_DO.png"), height = 5, width = 8, dpi = 400)
}
```

# Plot monthy mean DO for each site
```{r}
sites <- unique(tdata$site)

dosum_envelope <- dodata %>%
  group_by(site, day) %>%
  summarize(multi_min = min(do),
            multi_max = max(do),
            .groups = "drop") 

i = "TNC_16"

for( i in sites) {
print(i)
dosum_month %>%
  filter(site == i,
         n >= 10) %>%
  ggplot() +
  geom_ribbon(aes(x = day, ymax = multi_max,
                  ymin = multi_min), 
              data = filter(dosum_envelope, site == i),
              fill = "gray", alpha = 0.5) +
  geom_line(aes(x = mid, y = mean_mean, color = yearf), size = .5,
             position = position_dodge(width = 10)) +      
  geom_point(aes(x = mid, y = mean_mean, color = yearf), size = 2,
             shape = 16,
             position = position_dodge(width = 10)) +
  theme_minimal() +
  labs(x = "", y = "Mean monthly dissolved oxygen",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
    scale_y_continuous(breaks = seq(0,16, by = 4),
                     limits = c(0,16.5)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    limits = c(82, 339),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
    ) +
  scale_color_manual(values = c(wes_palettes$Royal1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotD/PlotD_",i,"_monthly_DO.png"), height = 5, width = 7, dpi = 400)
}
```
# mean/min/max temperature during migratory fish periods
```{r}
sites <- unique(tdata$site)

i = sites[2]

for(i in sites){
  print(i)
tsum_season %>%
  filter(site == i,
         is.na(season)==F,
         n > 10) %>%
  ggplot() +
  geom_errorbar(aes(y = yearf, 
                    xmin = mean_min, xmax = mean_max),
                width = 0) +
  geom_point(aes(y = yearf, x = mean_mean, color = season2),
             size = 3) +
  facet_grid(season2~.) +
    theme_bw() +
  labs(x = "Mean daily temperature\n(+/- average min and max)", y = "",
       title = i, color = "") +
  scale_x_continuous(limits = c(6,27),
                     breaks = seq(6,26, by = 4)) +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        strip.text = element_blank(),
        strip.background = element_blank(),
        legend.position = "right") +
  scale_color_manual(values = c(wes_palettes$Zissou1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotE/PlotE_",i,"_fish_seasons_temp.png"), height = 5, width = 7, dpi = 400)
}
```
# mean/min/max DO during migratory fish periods
```{r}
sites <- unique(dodata$site)

i = sites[1]

for(i in sites){
  print(i)
dosum_season %>%
  filter(site == i,
         is.na(season)==F,
         n > 10) %>%
  ggplot() +
  geom_errorbar(aes(y = yearf, 
                    xmin = mean_min, xmax = mean_max),
                width = 0) +
  geom_point(aes(y = yearf, x = mean_mean, color = season2),
             size = 3) +
  facet_grid(season2~.) +
    theme_bw() +
    scale_x_continuous(limits = c(0,14),
                     breaks = seq(0,14, by = 2)) +
  labs(x = "Mean daily dissolved oxygen\n(+/- average min and max)", y = "",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12),
        axis.text.y = element_text(size = 10),
        strip.text = element_blank(),
        strip.background = element_blank(),
        legend.position = "right") +
  scale_color_manual(values = c(wes_palettes$Zissou1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotF/PlotF_",i,"_fish_seasons_DO.png"), height = 5, width = 7, dpi = 400)
}
```
# Tables of average daily temperatures by month
- What is the monthly mean mean/min/max temperature?
```{r}
sites <- unique(tdata$site)

i = sites[1]

for(i in sites){
  print(i)
(tmonth_table <- tsum_month %>%
  filter(n >= 10,
         site == i) %>%
  rename(Year = yearf,
         Site = site,
         Mean = mean_mean,
         Max = mean_max,
         Min = mean_min) %>%
  arrange(Site, month, Year) %>%
  select(Site, Month, Year, Min, Mean, Max, n)  %>%
  kbl(caption = 
        paste0("Average daily temperatures (min, mean, and max) by month for site ", i,"."), 
      digits = 1) %>%
  kable_classic(full_width = F, html_font = "Cambria")
)

# save the table to HTML file
save_kable(tmonth_table,
           paste0("output/",
                  "Task2_WQ_migratory_species/TableA/",
                  "TableA_", i, 
                  "_monthly_average_temperatures.html"))
}

```
# Tables of average daily temperatures for 1 Jul - 15 Sept
- For July 1- Sept 15, What’s the mean daily max?
```{r}

sites <- unique(tdata$site)

i = sites[1]

for(i in sites){
  print(i)
(t_hotseason_table <- tsum_season %>%
  filter(n >= 10,
         season == "juvenile",
         site == i) %>%
  rename(Year = yearf,
         Site = site,
         Mean = mean_mean,
         'Avg. Max' = mean_max,
         'Avg. Min' = mean_min,
         'Abs. Min' = min_min,
         'Abs. Max' = max_max) %>%
    mutate(Period = "1 Jul - 15 Sep") %>%
  arrange(Site, Year) %>%
  select(Site, Year, Period, 'Abs. Min', 'Avg. Min', 
         Mean, 'Avg. Max', 'Abs. Max',  n)  %>%
  kbl(caption = 
        paste0("Average daily temperatures (min, mean, and max) during the period 1 July to 15 September for site ", i,"."), 
      digits = 1) %>%
  kable_classic(full_width = F, html_font = "Cambria")
)

# save the table to HTML file
save_kable(t_hotseason_table,
           paste0("output/",
                  "Task2_WQ_migratory_species/TableB/",
                  "TableB_", i, 
                  "_average_temps_1Jul_15Sep.html"))
}

```
# Tables of average daily temperatures for migratory fish seasons
- What is mean mean/min/max by fish season?
```{r}

sites <- unique(tdata$site)

i = sites[1]

for(i in sites){
  print(i)
(t_fishseason_table <- tsum_season %>%
  filter(n >= 10,
         site == i,
         is.na(season) == F) %>%
  rename(Year = yearf,
         Season = season2,
         Site = site,
         Mean = mean_mean,
         'Avg. Max' = mean_max,
         'Avg. Min' = mean_min,
         'Abs. Min' = min_min,
         'Abs. Max' = max_max) %>%
  arrange(Site, Season, Year) %>%
  select(Site, Season, Year, 'Abs. Min', 'Avg. Min', 
         Mean, 'Avg. Max', 'Abs. Max',  n)  %>%
  kbl(caption = 
        paste0("Average daily temperatures (min, mean, and max) during the primary migratory fish periods for site ", i,". Spring migration: 15 April - 15 May; Spawning: 16-31 May; Larvae: 1-30 June; Juvenile: 1 July - 15 Sept.; Fall migration: 16 Sept. - 30 Nov."), 
      digits = 1) %>%
  kable_classic(full_width = F, html_font = "Cambria")
)

# save the table to HTML file
save_kable(t_fishseason_table,
           paste0("output/",
                  "Task2_WQ_migratory_species/TableC/",
                  "TableC_", i, 
                  "_average_temps_mig_fish_seasons.html"))
}

```
# Modeling mean temperature by site in each season
```{r}
# intercept varying among years and among days within years (nested random effects)

# fit model during migration period
temp_mod_migrate <- lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "migrate"))
summary(temp_mod_migrate)

# fit model during spawning period
temp_mod_spawn <- 
  lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "spawn"))
summary(temp_mod_spawn)

# fit model during larval period
temp_mod_lar <- 
  lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "larvae"))
summary(temp_mod_lar)

# fit model during juvenile period
temp_mod_juv <- 
  lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "juvenile"))
summary(temp_mod_juv)

# fit model during fall migration period
temp_mod_fall <- 
  lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_mod_fall)

# make prediction covariate data for migration
newdat_migrate <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "migrate")$site) %>%
  droplevels()

# make prediction covariate data for spawning
newdat_spawn <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "spawn")$site) %>%
  droplevels()

# make prediction covariate data for larvae
newdat_lar <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "larvae")$site) %>%
  droplevels()

# make prediction covariate data for juvenile
newdat_juv <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "juvenile")$site) %>%
  droplevels()

# make prediction covariate data for fall migration
newdat_fall <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "fall_mig")$site) %>%
  droplevels()
```
# Generate bootstrapped CI's for predictions
Warning: very long run time (& juv run needs lots of RAM)
```{r}
# Bootstrapped CIs for predicted mean temperature - Spawning
pred_fun_spawn <- function(.) {
  c(predict(., data.frame(site = unique(newdat_spawn$site)), 
            re.form = NA))
}

bootCI_spawn = bootMer(temp_mod_spawn, pred_fun_spawn, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_spawn, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_spawn_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Larvae
pred_fun_lar <- function(.) {
  c(predict(., data.frame(site = unique(newdat_lar$site)), 
            re.form = NA))
}

bootCI_lar = bootMer(temp_mod_lar, pred_fun_lar, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_lar, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_lar_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Juvenile
pred_fun_juv <- function(.) {
  c(predict(., data.frame(site = unique(newdat_juv$site)), 
            re.form = NA))
}

bootCI_juv = bootMer(temp_mod_juv, pred_fun_juv, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_juv, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_juv_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Fall migration
pred_fun_fall <- function(.) {
  c(predict(., data.frame(site = unique(newdat_fall$site)), 
            re.form = NA))
}

bootCI_fall = bootMer(temp_mod_fall, pred_fun_fall, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_fall, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_fall_bootstraps.rds")


# Bootstrapped CIs for predicted mean temperature - Migration
pred_fun_migrate <- function(.) {
  c(predict(., data.frame(site = unique(newdat_migrate$site)), 
            re.form = NA))
}

bootCI_migrate = bootMer(temp_mod_migrate, pred_fun_migrate, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_migrate, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_migrate_bootstraps.rds")
```
# Plot modeled mean temp by fish stage w/ CIs
```{r}
bootCI_migrate <- readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_migrate_bootstraps.rds")

bootCI_spawn <- readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_spawn_bootstraps.rds")

bootCI_lar <- readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_lar_bootstraps.rds")

bootCI_juv <- readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_juv_bootstraps.rds")

bootCI_fall <- readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_fall_bootstraps.rds")

boot_compile <- function(boot, mod, newdat, label){
  
tplot_df <- apply(boot$t, 2, 
               function(x) quantile(x, c(0.025,0.975))) %>% 
  t() %>%
  as.data.frame() %>%
  bind_cols(predict(mod, 
                    data.frame(site = unique(newdat$site)), 
                    re.form = NA)) %>%
  rename(q2.5 = 1, q97.5 = 2, fit = 3) %>%
  mutate(site = unique(newdat$site)) %>%
  select(site, fit, q2.5, q97.5) %>%
  mutate(site = fct_reorder(site, fit),
         per = label)

return(tplot_df)

}

tplots <- rbind.data.frame(
  boot_compile(bootCI_juv, temp_mod_juv, 
               newdat_juv, "Juvenile"),  boot_compile(bootCI_migrate, temp_mod_migrate, 
               newdat_migrate, "Spring Migration"),
  boot_compile(bootCI_spawn, temp_mod_spawn, 
               newdat_spawn, "Spawning"),
  boot_compile(bootCI_lar, temp_mod_lar, 
               newdat_lar, "Larvae"),
  boot_compile(bootCI_fall, temp_mod_fall, 
               newdat_fall, "Fall Migration")
) %>%
  mutate(per = fct_rev(per))

tplots %>%
  ggplot() +
  geom_point(aes(y = site, x = fit,
                 ),
             size = 2) +
  geom_errorbar(aes(y = site, xmin = q2.5, 
                    xmax = q97.5),
                width = 0) +
  facet_wrap(~ per, ncol = 5, scale = "free_x") +
  theme_bw() +
  labs(y = "", x = "Mean temperature (C; +/- 95% CI)") +
  theme(strip.background = element_rect(fill = "white")) +
  scale_x_continuous(breaks = seq(1,28, by = 2))
                      
ggsave("output/Task2_WQ_migratory_species/PlotG_modeled_mean_temp_by_fish_stage.png", width = 6, height = 4, dpi = 400)

# try Bayesian later...
# y ~ dnorm(mu, tau)
# mu ~ site[s] + day[y] + year[y]
# or in BRMS
# library(brms)
# temp_bmod_migrate <- brm(temp ~ site +
#                        (1 | yearf/dayf),
#              data = filter(tdata, is.na(temp)==F,
#                            season== "migrate"))
# saveRDS(temp_bmod_migrate, "output/Task2_WQ_migratory_species/statistical_analysis/temp_bmod_migrate_stanmod.rds")
```

# Modeling year trend in mean temperature within each season
Note: tried model with correlated random slope & intercept of year by site, uncorrelated, and just intercept. Correlated slope & intercept fit best for all seasons.
```{r}
tdata$yearn <- tdata$year - 2015
# tried quadratic day as continuous 
# very similar results (for spawn anyway)
# tdata <- tdata %>%
#   group_by(season) %>%
#   mutate(dayz = (day - mean(day))/sd(day))

# fit model during migration period
# correlated random slope & intercept of year by site
temp_trend_migrate <- lmerTest::lmer(temp ~ yearn + 
                                       (1 | dayf) + 
                                        (yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "migrate"))
summary(temp_trend_migrate)
ss <- getME(temp_trend_migrate,c("theta","fixef"))
# get it to converge...
# code from: https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
temp_trend_migrate2 <- update(temp_trend_migrate,
             start=ss,
             control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(temp_trend_migrate2)
temp_trend_migrate <- temp_trend_migrate2

# # uncorrelated random slope & intercept
# temp_trend_migrate0 <- lmerTest::lmer(temp ~ yearn + 
#                                        (1 | dayf) + (1 | site) + 
#                                         (0 + yearn | site), 
#              data = filter(tdata, is.na(temp)==F,
#                            season == "migrate"))
# summary(temp_trend_migrate0)
# 
# # just random intercept
# temp_trend_migrate_int <- lmerTest::lmer(temp ~ yearn + (1 | dayf) +
#                                        (1 | site), 
#              data = filter(tdata, is.na(temp)==F,
#                            season == "migrate"))
# 
# summary(temp_trend_migrate_int)
# 
# anova(temp_trend_migrate, 
#       temp_trend_migrate0, 
#       temp_trend_migrate_int)

# fit model during spawning period
temp_trend_spawn <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) +
                   (yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "spawn"))
summary(temp_trend_spawn)

temp_trend_spawn0 <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + 
                   (1|site) + (0 + yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "spawn"))
summary(temp_trend_spawn0)

temp_trend_spawn_int <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + 
                   (1|site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "spawn"))
summary(temp_trend_spawn_int)

anova(temp_trend_spawn, 
      temp_trend_spawn0, 
      temp_trend_spawn_int)

# fit model during larval period
temp_trend_lar <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "larvae"))
summary(temp_trend_lar)

temp_trend_lar0 <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (1|site) + 
                   (0 + yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "larvae"))
summary(temp_trend_lar0)

temp_trend_lar_int <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (1|site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "larvae"))
summary(temp_trend_lar_int)

anova(temp_trend_lar, temp_trend_lar0, temp_trend_lar_int)

# fit model during juvenile period
temp_trend_juv <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "juvenile"))
summary(temp_trend_juv)
# get it to converge...
ss <- getME(temp_trend_juv, c("theta","fixef"))
temp_trend_juv2 <- update(temp_trend_juv,
             start=ss,
             control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(temp_trend_juv2)
temp_trend_juv <- temp_trend_juv2
# aa <- allFit(temp_trend_lar)

temp_trend_juv0 <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + 
                   (1|site) + (0 + yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "juvenile"))

summary(temp_trend_juv0)

temp_trend_juv_int <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + 
                   (1|site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "juvenile"))

summary(temp_trend_juv_int)

anova(temp_trend_juv, 
      temp_trend_juv0, 
      temp_trend_juv_int)

# fit model during fall migration period
temp_trend_fall <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_trend_fall)

temp_trend_fall_noday <- 
  lmerTest::lmer(temp ~ yearn + (yearn | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_trend_fall_noday)

temp_trend_fall0 <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (1|site) +
                   (0 + yearn|site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_trend_fall0)

temp_trend_fall_int <- 
  lmerTest::lmer(temp ~ yearn + (1 | dayf) + (1 | site), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_trend_fall_int)

anova(temp_trend_fall,
      temp_trend_fall_noday,
      temp_trend_fall0, 
      temp_trend_fall_int)
```
# Plot temperature trends across sites
```{r}

library(ggeffects)

migrate_temp_trend_df <- 
  ggpredict(temp_trend_migrate, terms = "yearn")
spawn_temp_trend_df <- 
  ggpredict(temp_trend_spawn, terms = "yearn", type = "fixed")
larvae_temp_trend_df <- 
  ggpredict(temp_trend_lar, terms = "yearn")
juv_temp_trend_df <- 
  ggpredict(temp_trend_juv, terms = "yearn")
fall_temp_trend_df <- 
  ggpredict(temp_trend_fall, terms = c("yearn"))
fall_temp_trend_df_noday <- 
  ggpredict(temp_trend_fall_noday, terms = c("yearn"))

# Plot of temperature trends in spring migration

season_pts <- tsum_season %>%
  # filter(n > 10) %>%
  group_by(season, yearf) %>% 
  summarise(mean = mean(mean_mean),
            sd = sd(mean_mean),
            n = length(mean_mean),
            .groups = "drop") %>%
  mutate(se = sd/sqrt(n),
            ll = mean-2*se,
            ul = mean+2*se,
            yearn = as.numeric(as.character(yearf))-2015)

(migrate_temp_plot <- 
    ggplot(migrate_temp_trend_df) +
  geom_line(aes(x, predicted),
            size = 1.25, color = "dodgerblue") +
  geom_ribbon(aes(x = x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts, season == "migrate"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts, season == "migrate")) +
  theme_bw() +
  # scale_y_continuous(limits = c(13, 16)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean temperature trend (C)",
         title = "Apr 15 - May 15 (spring migration)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 12.3, 
             label = paste0("Trend = ", 
                            round(fixef(temp_trend_migrate)[2], 2),
                            " C / yr",
            "\np-value = ",                   
            round(summary(temp_trend_migrate)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
)

ggsave("output/Task2_WQ_migratory_species/PlotH_mean_temperature_trends_spring_mig.png",
       width = 5, height = 5, dpi = 400)

# Plot of temperature trends in spawning season

(spawn_temp_plot <- 
    ggplot(spawn_temp_trend_df) +
  geom_line(aes(x, predicted), size = 1.25, color = "dodgerblue") +
  geom_ribbon(aes(x = x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts, season == "spawn"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts, season == "spawn")) +
  theme_bw() +
  # scale_y_continuous(limits = c(16.5, 19.5)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean temperature trend (C)",
         title = "May 16-31 (spawning)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 16, 
             label = paste0("Trend = ", 
                            round(fixef(temp_trend_spawn)[2], 2),
                            " C / yr",
            "\np-value = ",                   
            round(summary(temp_trend_spawn)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotI_mean_temperature_trends_spawning.png",
       width = 5, height = 5, dpi = 400)

# Plot of temperature trends in larval season
(larvae_temp_plot <- 
    ggplot(larvae_temp_trend_df) +
  geom_line(aes(x, predicted), size = 1.25, color = "dodgerblue") +
  geom_ribbon(aes(x = x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts, season == "larvae"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts, season == "larvae")) +
  theme_bw() +
  # scale_y_continuous(limits = c(17.5, 20.5)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean temperature trend (C)",
         title = "Jun 1-30 (larvae)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 19, 
             label = paste0("Trend = ", 
                            round(fixef(temp_trend_lar)[2], 2),
                            " C / yr",
            "\np-value = ",                   
            round(summary(temp_trend_lar)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotJ_mean_temperature_trends_larvae.png",
       width = 5, height = 5, dpi = 400)

(juv_temp_plot <- 
    ggplot(juv_temp_trend_df) +
  geom_line(aes(x, predicted), size = 1.25, color = "dodgerblue") +
  geom_ribbon(aes(x=x,ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts, season == "juvenile"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts, season == "juvenile")) +
  theme_bw() +
  # scale_y_continuous(limits = c(22, 25)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean temperature trend (C)",
         title = "Jul 1 - Sep 15 (juvenile)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 19.5, 
             label = paste0("Trend = ", 
                            round(fixef(temp_trend_juv)[2], 2),
                            " C / yr",
            "\np-value = ",                   
            round(summary(temp_trend_juv)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotK_mean_temperature_trends_juvenile.png",
       width = 5, height = 5, dpi = 400)

(fall_temp_plot <- 
    ggplot(fall_temp_trend_df) +
  geom_line(aes(x, predicted), size = 1.25, color = "dodgerblue") +
  geom_ribbon(aes(x=x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_line(aes(x, predicted), size = 1, color = "dodgerblue",
            data = fall_temp_trend_df_noday, lty = 2) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts, season == "fall_mig"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts, season == "fall_mig")) +
  theme_bw() +
  scale_y_continuous(limits = c(10, 19.5)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean temperature trend (C)",
         title = "Sep 16 - Nov 30 (fall migration)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 10, 
             label = paste0("Trend = ", 
                            round(fixef(temp_trend_fall)[2], 2),
                            " C / yr",
            "\np-value = ",                   
            round(summary(temp_trend_fall)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotL_mean_temperature_trends_fall.png",
       width = 5, height = 5, dpi = 400)

gg <- gridExtra::arrangeGrob(migrate_temp_plot, 
                             spawn_temp_plot,
                             larvae_temp_plot,
                             juv_temp_plot,
                             fall_temp_plot)

ggsave("output/Task2_WQ_migratory_species/PlotM_mean_temperature_trends_all_stages.png", plot = gg, width = 10, height = 10, dpi = 400)
```




# Modeling year trend in mean DO within each season
Note: tried model with correlated random slope & intercept of year by site, uncorrelated, and just intercept. Correlated slope & intercept fit best for all seasons.
```{r}

dodata$yearn <- dodata$year - 2015

# fit model during migration period
# correlated random slope & intercept of year by site
do_trend_migrate <- lmerTest::lmer(do ~ yearn + 
                                       (1 | dayf) + 
                                        (yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "migrate"))
summary(do_trend_migrate)

# uncorrelated random slope & intercept
do_trend_migrate0 <- lmerTest::lmer(do ~ yearn + 
                                       dayf + (1 | site) + 
                                        (0 + yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "migrate"))
summary(do_trend_migrate0)

# just random intercept
do_trend_migrate_int <- lmerTest::lmer(do ~ yearn + dayf +
                                       (1 | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "migrate"))

summary(do_trend_migrate_int)

anova(do_trend_migrate, 
      do_trend_migrate0, 
      do_trend_migrate_int)

# fit model during spawning period
do_trend_spawn <- 
  lmerTest::lmer(do ~ yearn + (1 | dayf) + (yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "spawn"))
summary(do_trend_spawn)

do_trend_spawn0 <- 
  lmerTest::lmer(do ~ yearn + dayf + 
                   (1|site) + (0 + yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "spawn"))
summary(do_trend_spawn0)

do_trend_spawn_int <- 
  lmerTest::lmer(do ~ yearn + dayf + 
                   (1|site), 
             data = filter(dodata, is.na(do)==F,
                           season == "spawn"))
summary(do_trend_spawn_int)

anova(do_trend_spawn, 
      do_trend_spawn0, 
      do_trend_spawn_int)

# fit model during larval period
do_trend_lar <-
  lmerTest::lmer(do ~ yearn + (1|dayf) + (yearn | site),
             data = filter(dodata, is.na(do)==F,
                           season == "larvae"))
summary(do_trend_lar)

# uncorrelated random slope & intercept
do_trend_lar0 <- lmerTest::lmer(do ~ yearn + 
                                       (1|dayf) + (1 | site) + 
                                        (0 + yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "larvae"))
summary(do_trend_migrate0)

# just random intercept
do_trend_lar_int <- lmerTest::lmer(do ~ yearn + (1|dayf) +
                                       (1 | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "larvae"))

summary(do_trend_lar_int)

anova(do_trend_lar, 
      do_trend_lar0, 
      do_trend_lar_int)

# fit model during juvenile period
do_trend_juv <- 
  lmerTest::lmer(do ~ yearn + (1|dayf) + (yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "juvenile"))
summary(do_trend_juv)
ss <- getME(do_trend_juv, c("theta","fixef"))
# get it to converge...
# code from: https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
do_trend_juv2 <- update(do_trend_juv,
             start=ss,
             control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(do_trend_juv2)
do_trend_juv <- do_trend_juv2
# aa <- allFit(do_trend_juv)

do_trend_juv0 <- 
  lmerTest::lmer(do ~ yearn + (1|dayf) + 
                   (1|site) + (0 + yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "juvenile"))

summary(do_trend_juv0)

do_trend_juv_int <- 
  lmerTest::lmer(do ~ yearn + (1|dayf) + 
                   (1|site), 
             data = filter(dodata, is.na(do)==F,
                           season == "juvenile"))

summary(do_trend_juv_int)

anova(do_trend_juv, 
      do_trend_juv0, 
      do_trend_juv_int)

# fit model during fall migration period
do_trend_fall <- 
  lmerTest::lmer(do ~ yearn + (1|dayf) + (yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "fall_mig"))
summary(do_trend_fall)

do_trend_fall_noday <- 
  lmerTest::lmer(do ~ yearn + (yearn | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "fall_mig"))
summary(do_trend_fall_noday)
ss <- getME(do_trend_fall_noday, c("theta","fixef"))
# get it to converge...
# code from: https://rstudio-pubs-static.s3.amazonaws.com/33653_57fc7b8e5d484c909b615d8633c01d51.html
do_trend_fall_noday2 <- update(do_trend_fall_noday,
             start=ss,
             control=lmerControl(optimizer="bobyqa",
                            optCtrl=list(maxfun=2e5)))
summary(do_trend_fall_noday2)
do_trend_fall_noday <- do_trend_fall_noday2
# aa <- allFit(do_trend_fall_noday)

do_trend_fall0 <- 
  lmerTest::lmer(do ~ yearn + (1|dayf) + (1|site) +
                   (0 + yearn|site), 
             data = filter(dodata, is.na(do)==F,
                           season == "fall_mig"))
summary(do_trend_fall0)

do_trend_fall_int <- 
  lmerTest::lmer(do ~ yearn + (1|dayf) + (1 | site), 
             data = filter(dodata, is.na(do)==F,
                           season == "fall_mig"))
summary(do_trend_fall_int)

anova(temp_trend_fall, 
      temp_trend_fall0, 
      temp_trend_fall_int)


```
# Plot temperature trends across sites
```{r}

library(ggeffects)

migrate_do_trend_df <- 
  ggpredict(do_trend_migrate, terms = "yearn")
spawn_do_trend_df <- 
  ggpredict(do_trend_spawn, terms = "yearn")
larvae_do_trend_df <- 
  ggpredict(do_trend_lar, terms = "yearn")
juv_do_trend_df <- 
  ggpredict(do_trend_juv, terms = "yearn")
fall_do_trend_df <- 
  ggpredict(do_trend_fall, terms = "yearn")
fall_do_trend_df_noday <- 
  ggpredict(do_trend_fall_noday, terms = "yearn")

# Plot of DO trends in spring migration

season_pts_do <- dosum_season %>%
  # filter(n > 10) %>%
  group_by(season, yearf) %>% 
  summarise(mean = mean(mean_mean),
            sd = sd(mean_mean),
            n = length(mean_mean),
            .groups = "drop") %>%
  mutate(se = sd/sqrt(n),
            ll = mean-2*se,
            ul = mean+2*se,
            yearn = as.numeric(as.character(yearf))-2015)


(migrate_do_plot <- 
    ggplot(migrate_do_trend_df) +
  geom_line(aes(x, predicted), size = 1.25, color = "firebrick") +
  geom_ribbon(aes(x = x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts_do, season == "migrate"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts_do, 
                              season == "migrate")) +  
    theme_bw() +
  # scale_y_continuous(limits = c(8, 10)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean DO trend",
         title = "Apr 15 - May 15 (spring migration)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 8.5, 
             label = paste0("Trend = ", 
                            round(fixef(do_trend_migrate)[2], 2),
                            " / yr",
            "\np-value = ",                   
            round(summary(do_trend_migrate)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
)

ggsave("output/Task2_WQ_migratory_species/PlotN_mean_DO_trends_spring_mig.png",
       width = 5, height = 5, dpi = 400)

# Plot of DO trends in spawning season

(spawn_do_plot <- 
    ggplot(spawn_do_trend_df) +
  geom_line(aes(x, predicted), size = 1.25, color = "firebrick") +
  geom_ribbon(aes(x=x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts_do, season == "spawn"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts_do, 
                              season == "spawn")) +  
  theme_bw() +
  # scale_y_continuous(limits = c(8, 10.5)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean DO trend",
         title = "May 16-31 (spawning)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 6.75, 
             label = paste0("Trend = ", 
                            round(fixef(do_trend_spawn)[2], 2),
                            " / yr",
            "\np-value = ",                   
            round(summary(do_trend_spawn)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotO_mean_DO_trends_spawning.png",
       width = 5, height = 5, dpi = 400)

# Plot of DO trends in larval season
(larvae_do_plot <- 
    ggplot(larvae_do_trend_df) +
  geom_line(size = 1.25, color = "firebrick", aes(x, predicted)) +
  geom_ribbon(aes(x=x,ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts_do, season == "larvae"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts_do, 
                              season == "larvae")) +  
  theme_bw() +
  # scale_y_continuous(limits = c(6.5, 11.5)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean DO trend",
         title = "Jun 1-30 (larvae)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 5.5, 
             label = paste0("Trend = ", 
                            round(fixef(do_trend_lar)[2], 2),
                            " / yr",
            "\np-value = ",                   
            round(summary(do_trend_lar)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotP_mean_DO_trends_larvae.png",
       width = 5, height = 5, dpi = 400)

(juv_do_plot <- 
    ggplot(juv_do_trend_df) +
  geom_line(size = 1.25, color = "firebrick", aes(x, predicted)) +
  geom_ribbon(aes(x=x,ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts_do, season == "juvenile"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts_do, 
                              season == "juvenile")) +  
  theme_bw() +
  # scale_y_continuous(limits = c(5,10)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean DO trend",
         title = "Jul 1 - Sep 15 (juvenile)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 3.5, 
             label = paste0("Trend = ", 
                            round(fixef(do_trend_juv)[2], 2),
                            " / yr",
            "\np-value = ",                   
            round(summary(do_trend_juv)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotQ_mean_do_trends_juvenile.png",
       width = 5, height = 5, dpi = 400)

(fall_do_plot <- 
    ggplot(fall_do_trend_df) +
  geom_line(size = 1.25, color = "firebrick", aes(x, predicted)) +
  geom_ribbon(aes(x=x, ymin = conf.low, ymax = conf.high), 
              alpha = .1) +
  geom_line(size = 1, color = "firebrick", aes(x, predicted),
            data = fall_do_trend_df_noday, lty = 2) +  geom_point(aes(x = yearn, y = mean), 
             data = filter(season_pts_do, season == "fall_mig"),
               size = 2) +
  geom_errorbar(aes(x = yearn, ymin = mean-2*se, ymax = mean+2*se),
                width = 0,
                data = filter(season_pts_do, 
                              season == "fall_mig")) +  

  theme_bw() +
  scale_y_continuous(limits = c(4, 11)) +
    scale_x_continuous(breaks = 1:6,
                       labels = 2016:2021) +
    labs(x = "", 
         y = "Mean do trend",
         title = "Sep 16 - Nov 30 (fall migration)") +
    theme(text = element_text(size = 14)) +
    annotate(geom = "text", x = 1, y = 4, 
             label = paste0("Trend = ", 
                            round(fixef(do_trend_fall)[2], 2),
                            " / yr",
            "\np-value = ",                   
            round(summary(do_trend_fall)$coefficients[2,5], 3)),
             hjust = 0, vjust = 0)
  )

ggsave("output/Task2_WQ_migratory_species/PlotS_mean_do_trends_fall.png",
       width = 5, height = 5, dpi = 400)

gg_do <- gridExtra::arrangeGrob(migrate_do_plot, 
                             spawn_do_plot,
                             larvae_do_plot,
                             juv_do_plot,
                             fall_do_plot)

ggsave("output/Task2_WQ_migratory_species/PlotT_mean_do_trends_all_stages.png", plot = gg_do, width = 10, height = 10, dpi = 400)
```
