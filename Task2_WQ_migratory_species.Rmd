---
title: "Task 2. migratory species"
author: "Mike Allen"
date: "2/28/2022"
output:
  html_document: default
  pdf_document: default
---
#Task 2: Site specific water quality conditions important to us other than SWQS
a. Determine which sites are more supportive of migrating species during key lifecycle periods over time
spring adult migration (~ 15 Apr - 15 May) 
spring spawning (~ 16-31 May)
summer fry stage (~ 1 Jun - 30 Sep; ~ 1 mo. larval, ~ 3 mo. juv.)
fall fry migration (~ 1 Oct - 30 Nov)

i. What is the daily min, max, mean temperature and dissolved oxygen?

b. Determine which sites are more likely not to thermally stress sensitive species during peak summer temperatures?
i. For the period of July 1- Sept 15
1. What’s the daily max?

c. What is the daily mean, min, and max temperatures?

d. What is the monthly mean temperature?

e. What is the annual mean temperature?

f. Are there significant changes to daily, monthly and annual mean temperature and dissolved oxygen over time (year to year, across all years sampled)?

g. How can we characterize seasonal variation over time and what differences, or patterns do we see in seasonal variation across the years?


# Product 2:
• Evaluate the water quality characteristics highlighted in Task 2 with respect to the needs of key migratory species.
• Meetings as needed to refine objectives and desired outputs.
• Data visualization (figures, maps, plots) and statistical analysis to compare same across sites and assess trends through time, along with associated interpretative text.

# Load libraries, format data, etc.
```{r}
library(dplyr)
# library(knitr)
# library(kableExtra)
library(lubridate)
library(ggplot2)
library(forcats)
library(lme4)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tdata <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60) %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  # peak movement ~ 15 April - 15 May in Raritan per Anthony V.
  mutate(migrate = case_when(day %in% 105:135 ~ 1,
                            TRUE ~ 0),
         # spawn May 16 - 31?
         spawn = case_when(day %in% 136:151 ~ 1,
                            TRUE ~ 0),
         juvenile = case_when(day %in% 152:273 ~ 1,
                            TRUE ~ 0),         
         fall_mig = case_when(day %in% 274:334 ~ 1,
                            TRUE ~ 0),
         season = case_when(day %in% 105:135 ~ "migrate",
                            day %in% 136:151 ~ "spawn",
                            day %in% 152:273 ~ "juvenile",
                            day %in% 274:334 ~ "fall_mig"),
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour),
         season = as.factor(season))

tmax <- tdata %>%
    group_by(site, year, day, migrate, spawn) %>%
  summarise(min_temp = min(temp, na.rm = T),
            max_temp = max(temp, na.rm = T),
            mean_temp = mean(temp, na.rm = T),
            .groups = "drop") %>%
  mutate(yearf = as.factor(year))

# format final compiled DO data
dodata <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60,
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  select(-do, -do_adj) %>%
  rename(do = do_adj2) %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
    # peak movement ~ 15 April - 15 May in Raritan per Anthony V.
  mutate(migrate = case_when(day %in% 105:135 ~ 1,
                            TRUE ~ 0),
         # spawn May 16 - 31?
         spawn = case_when(day %in% 136:151 ~ 1,
                            TRUE ~ 0),
         juvenile = case_when(day %in% 152:273 ~ 1,
                            TRUE ~ 0),         
         fall_mig = case_when(day %in% 274:334 ~ 1,
                            TRUE ~ 0),
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour))
  
  
dmin <- dodata %>%
  group_by(site, year, day) %>%
  summarise(min_DO = min(do, na.rm = T),
            mean_DO = mean(do, na.rm = T),
            mean24_DO = mean(do, na.rm = T),
            .groups = "drop") %>%
  arrange(site, year, day) %>%
  mutate(yearf = as.factor(year))
```
# Mean temperature by site: migratory period, 15 Apr - 15 May
```{r}
# intercept varying among years and among days within years (nested random effects)

# fit model during migration period
temp_mod_migrate <- lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "migrate"))
summary(temp_mod_migrate)

temp_mod_hr_migrate <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "migrate"))
summary(temp_mod_hr_migrate)

# compare model with and without hour random effect
# with hour effect is much better
anova(temp_mod_migrate, temp_mod_hr_migrate)

# fit model during spawning period
temp_mod_hr_spawn <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "spawn"))
summary(temp_mod_hr_spawn)

temp_mod_hr_juv <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "juvenile"))
summary(temp_mod_hr_juv)

temp_mod_hr_fall <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_mod_hr_fall)
```
# Generate bootstrapped CI's for predictions
```{r}
# make prediction covariate data for migration
newdat_migrate <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "migrate")$site) %>%
  droplevels()

# make prediction covariate data for spawning
newdat_spawn <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "spawn")$site) %>%
  droplevels()

# make prediction covariate data for juvenile
newdat_juv <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "juvenile")$site) %>%
  droplevels()

# make prediction covariate data for fall migration
newdat_fall <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "fall_mig")$site) %>%
  droplevels()


# Bootstrapped CIs for predicted mean temperature - Spawning
pred_fun_spawn <- function(.) {
  c(predict(., data.frame(site = unique(newdat_spawn$site)), 
            re.form = NA))
}

bootCI_spawn = bootMer(temp_mod_hr_spawn, pred_fun_spawn, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_spawn, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_spawn_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Juvenile
pred_fun_juv <- function(.) {
  c(predict(., data.frame(site = unique(newdat_juv$site)), 
            re.form = NA))
}

bootCI_juv = bootMer(temp_mod_hr_juv, pred_fun_juv, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_juv, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_juv_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Fall migration
pred_fun_fall <- function(.) {
  c(predict(., data.frame(site = unique(newdat_fall$site)), 
            re.form = NA))
}

bootCI_fall = bootMer(temp_mod_hr_fall, pred_fun_fall, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_fall, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_fall_bootstraps.rds")


# Bootstrapped CIs for predicted mean temperature - Migration
pred_fun_migrate <- function(.) {
  c(predict(., data.frame(site = unique(newdat_migrate$site)), 
            re.form = NA))
}

bootCI_migrate = bootMer(temp_mod_hr_migrate, pred_fun_migrate, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_migrate, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_migrate_bootstraps.rds")



bootCI = readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_bootstraps.rds")
tplot <- apply(bootCI$t, 2, 
               function(x) quantile(x, c(0.025,0.975))) %>% 
  t() %>%
  as.data.frame() %>%
  bind_cols(predict(temp_mod_hr_spawn, 
                    data.frame(site = unique(newdat_spawn$site)), 
                    re.form = NA)) %>%
  rename(q2.5 = 1, q97.5 = 2, fit = 3) %>%
  mutate(site = unique(tdata2$site)) %>%
  select(site, fit, q2.5, q97.5) %>%
  mutate(site = fct_reorder(site, fit))

tplot %>%
  ggplot() +
  geom_point(aes(y = site, x = fit)) +
  geom_errorbar(aes(y = site, xmin = q2.5, xmax = q97.5))
                      

# try Bayesian later...
# y ~ dnorm(mu, tau)
# mu ~ site[s] + day[y] + year[y]
# or in BRMS
library(brms)
temp_mod_hr_seas <- brm(temp ~ site + migrate + 
                       spawn + juvenile + fall_mig +
                       (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F))
saveRDS(temp_mod_hr_seas, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_seas_stanmod.rds")
```
# Mean temperature by site: migratory period, 15 Apr - 15 May
```{r}

tmax2 <- tmax %>%
  filter(migrate == 1,
         is.infinite(max_temp) == F)

tdata_mig <- tdata %>%
  filter(migrate == 1,
         is.na(temp) == F)

# intercept varying among years and among days within years (nested random effects)
temp_mod <- lmer(temp ~ site + (1 | yearf/dayf), 
             data = tdata_mig)
summary(temp_mod)

temp_mod_hr <- lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = tdata_mig)
summary(temp_mod_hr)

# compare model with and without hour random effect
# with hour effect is much better
anova(temp_mod, temp_mod_hr)

# plot results - fit looks good
# temp_fitdata <- cbind(tdata2, predict(temp_mod_hr)) %>%
#   rename(fit = 'predict(temp_mod_hr)')
# 
# temp_fitdata %>%
#   filter(yearf == 2016) %>%
#   ggplot() +
#   geom_point(aes(x = day, y = temp, color = site),
#                  alpha = 0.05) +
#   geom_point(aes(x = day, y = fit), shape = 16) +
#   facet_wrap(~site) +
#   theme_minimal()

newdat <- data.frame(site = unique(tdata2$site))
# fit <- predict(temp_mod_hr, newdat, re.form = NA)
predict(temp_mod_hr, newdat, re.form = NA)
newdat$temp <- 3
  
mySumm3 <- function(.) {
  c(predict(., data.frame(site = unique(tdata2$site)), 
            re.form = NA))
}

bootCI = bootMer(temp_mod_hr, mySumm3, re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_bootstraps.rds")


# try Bayesian later...
# y ~ dnorm(mu, tau)
# mu ~ site[s] + day[y] + year[y]
# or in BRMS
```

