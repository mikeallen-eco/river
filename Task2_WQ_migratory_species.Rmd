---
title: "Task 2. migratory species"
author: "Mike Allen"
date: "2/28/2022"
output:
  html_document: default
  pdf_document: default
---
#Task 2: Site specific water quality conditions important to us other than SWQS
a. Determine which sites are more supportive of migrating species during key lifecycle periods over time
spring adult migration (~ 15 Apr - 15 May) 
spring spawning (~ 16-31 May)
summer fry stage (~ 1 Jun - 15 Sep; ~ 1 mo. larval, ~ 3 mo. juv.)
fall fry migration (~ 16 Sep - 30 Nov)

i. What is the daily min, max, mean temperature and dissolved oxygen?

b. Determine which sites are more likely not to thermally stress sensitive species during peak summer temperatures?
i. For the period of July 1- Sept 15
1. What’s the daily max?

c. What is the daily mean, min, and max temperatures?

d. What is the monthly mean temperature?

e. What is the annual mean temperature?

f. Are there significant changes to daily, monthly and annual mean temperature and dissolved oxygen over time (year to year, across all years sampled)?

g. How can we characterize seasonal variation over time and what differences, or patterns do we see in seasonal variation across the years?


# Product 2:
• Evaluate the water quality characteristics highlighted in Task 2 with respect to the needs of key migratory species.
• Meetings as needed to refine objectives and desired outputs.
• Data visualization (figures, maps, plots) and statistical analysis to compare same across sites and assess trends through time, along with associated interpretative text.

# Load libraries, format data, etc.
```{r}
library(dplyr)
library(knitr)
library(kableExtra)
library(wesanderson)
library(lubridate)
library(ggplot2)
library(forcats)
library(lme4)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tdata <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60) %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  # right_join(expand.grid(site = unique(p$site), 
  #                        year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  # peak movement ~ 15 April - 15 May in Raritan per Anthony V.
  mutate(season = case_when(day %in% 105:135 ~ "migrate", #4/15-5/15
                            day %in% 136:151 ~ "spawn", #5/16-5/31
                            day %in% 152:181 ~ "larvae", #6/1-6/30
                            day %in% 182:258 ~ "juvenile", #7/1-9/15
                            day %in% 259:334 ~ "fall_mig"), #9/15-11
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour),
         season = as.factor(season))

# summarize data by day
tsum <- tdata %>%
    group_by(site, yearf, month, day, dayf) %>%
  summarise(min_temp = min(temp, na.rm = T),
            max_temp = max(temp, na.rm = T),
            mean_temp = mean(temp, na.rm = T),
            .groups = "drop") 

# summarize daily temp data by month
tsum_month <- tsum %>%
  group_by(site, yearf, month) %>%
  summarize(mean_mean = mean(mean_temp),
            mean_max = mean(max_temp),
            mean_min = mean(min_temp),
            n = length(mean_temp),
            .groups = "drop") %>%
  mutate(mid = case_when(month == 3 ~ yday("2021-03-15"),
                         month == 4 ~ yday("2021-04-15"),
                         month == 5 ~ yday("2021-05-15"),
                         month == 6 ~ yday("2021-06-15"),
                         month == 7 ~ yday("2021-07-15"),
                         month == 8 ~ yday("2021-08-15"),
                         month == 9 ~ yday("2021-09-15"),
                         month == 10 ~ yday("2021-10-15"),
                         month == 11 ~ yday("2021-11-15")
                         )) %>%
  mutate(Month = case_when(month == 4 ~ "April",
                           month == 5 ~ "May",
                           month == 6 ~ "June",
                           month == 7 ~ "July",
                           month == 8 ~ "August",
                           month == 9 ~ "September",
                           month == 10 ~ "October",
                           month == 11 ~ "November",
                           month == 12 ~ "December"))

# summarize daily temp data by fish life history season
tsum_season <- tdata %>%
    group_by(site, yearf, season, day, dayf) %>%
  summarise(min_temp = min(temp, na.rm = T),
            max_temp = max(temp, na.rm = T),
            mean_temp = mean(temp, na.rm = T),
            .groups = "drop")  %>%
  group_by(site, yearf, season) %>%
  summarize(mean_mean = mean(mean_temp),
            mean_max = mean(max_temp),
            mean_min = mean(min_temp),
            max_max = max(max_temp),
            min_min = min(min_temp),
            n = length(mean_temp),
            .groups = "drop") %>%
  mutate(order = case_when(season == "migrate" ~ 1,
                           season == "spawn" ~ 2,
                           season == "larvae" ~ 3,
                           season == "juvenile" ~ 4,
                           season == "fall_mig" ~ 5),
         season2 = case_when(season == "migrate" ~ "Migrate (S)",
                           season == "spawn" ~ "Spawn",
                           season == "larvae" ~ "Larvae",
                           season == "juvenile" ~ "Juvenile",
                           season == "fall_mig" ~ "Migrate (F)"),
         season2 = fct_reorder(season2, order))

# format final compiled DO data
dodata <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60,
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  select(-do, -do_adj) %>%
  rename(do = do_adj2) %>%
  # right_join(expand.grid(site = unique(p$site), 
  #                        year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
    # Dates based on Anthony V. and shad reference he provided
  mutate(season = case_when(day %in% 105:135 ~ "migrate",
                            day %in% 136:151 ~ "spawn",
                            day %in% 152:273 ~ "juvenile",
                            day %in% 274:334 ~ "fall_mig"),
         yearf = as.factor(year),
         dayf = as.factor(day),
         hourf = as.factor(hour))
  
# summarize DO data by day
dosum <- dodata %>%
    group_by(site, yearf, month, day, dayf) %>%
  summarise(min_do = min(do, na.rm = T),
            mean_do = mean(do, na.rm = T),
            max_do = max(do, na.rm = T),
            .groups = "drop") %>%
  arrange(site, yearf, day)

# summarize daily DO data by month
dosum_month <- dosum %>%
  group_by(site, yearf, month) %>%
  summarize(mean_mean = mean(mean_do),
            mean_max = mean(max_do),
            mean_min = mean(min_do),
            n = length(mean_do),
            .groups = "drop") %>%
  mutate(mid = case_when(month == 3 ~ yday("2021-03-15"),
                         month == 4 ~ yday("2021-04-15"),
                         month == 5 ~ yday("2021-05-15"),
                         month == 6 ~ yday("2021-06-15"),
                         month == 7 ~ yday("2021-07-15"),
                         month == 8 ~ yday("2021-08-15"),
                         month == 9 ~ yday("2021-09-15"),
                         month == 10 ~ yday("2021-10-15"),
                         month == 11 ~ yday("2021-11-15")
                         ))

# summarize daily DO data by fish life history season
dosum_season <- dodata %>%
    group_by(site, yearf, season, day, dayf) %>%
  summarise(min_do = min(do, na.rm = T),
            max_do = max(do, na.rm = T),
            mean_do = mean(do, na.rm = T),
            .groups = "drop")  %>%
  group_by(site, yearf, season) %>%
  summarize(mean_mean = mean(mean_do),
            mean_max = mean(max_do),
            mean_min = mean(min_do),
            n = length(mean_do),
            .groups = "drop") %>%
  mutate(order = case_when(season == "migrate" ~ 1,
                           season == "spawn" ~ 2,
                           season == "larvae" ~ 3,
                           season == "juvenile" ~ 4,
                           season == "fall_mig" ~ 5),
         season2 = case_when(season == "migrate" ~ "Migrate (S)",
                           season == "spawn" ~ "Spawn",
                           season == "larvae" ~ "Larvae",
                           season == "juvenile" ~ "Juvenile",
                           season == "fall_mig" ~ "Migrate (F)"),
         season2 = fct_reorder(season2, order))

rm(p)
```
# Mean temperature by site: migratory period, 15 Apr - 15 May
```{r}
# intercept varying among years and among days within years (nested random effects)

# fit model during migration period
temp_mod_migrate <- lmer(temp ~ site + (1 | yearf/dayf), 
             data = filter(tdata, is.na(temp)==F,
                           season == "migrate"))
summary(temp_mod_migrate)

temp_mod_hr_migrate <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "migrate"))
summary(temp_mod_hr_migrate)

# compare model with and without hour random effect
# with hour effect is much better
anova(temp_mod_migrate, temp_mod_hr_migrate)

# fit model during spawning period
temp_mod_hr_spawn <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "spawn"))
summary(temp_mod_hr_spawn)

temp_mod_hr_juv <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "juvenile"))
summary(temp_mod_hr_juv)

temp_mod_hr_fall <- 
  lmer(temp ~ site + (1 | yearf/dayf/hour), 
             data = filter(tdata, is.na(temp)==F,
                           season == "fall_mig"))
summary(temp_mod_hr_fall)
```
# Generate bootstrapped CI's for predictions
```{r}
# make prediction covariate data for migration
newdat_migrate <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "migrate")$site) %>%
  droplevels()

# make prediction covariate data for spawning
newdat_spawn <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "spawn")$site) %>%
  droplevels()

# make prediction covariate data for juvenile
newdat_juv <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "juvenile")$site) %>%
  droplevels()

# make prediction covariate data for fall migration
newdat_fall <- expand.grid(site = unique(tdata$site)) %>%
  filter(site %in% filter(tdata, is.na(temp)==F,
                          season == "fall_mig")$site) %>%
  droplevels()


# Bootstrapped CIs for predicted mean temperature - Spawning
pred_fun_spawn <- function(.) {
  c(predict(., data.frame(site = unique(newdat_spawn$site)), 
            re.form = NA))
}

bootCI_spawn = bootMer(temp_mod_hr_spawn, pred_fun_spawn, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_spawn, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_spawn_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Juvenile
pred_fun_juv <- function(.) {
  c(predict(., data.frame(site = unique(newdat_juv$site)), 
            re.form = NA))
}

bootCI_juv = bootMer(temp_mod_hr_juv, pred_fun_juv, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_juv, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_juv_bootstraps.rds")

# Bootstrapped CIs for predicted mean temperature - Fall migration
pred_fun_fall <- function(.) {
  c(predict(., data.frame(site = unique(newdat_fall$site)), 
            re.form = NA))
}

bootCI_fall = bootMer(temp_mod_hr_fall, pred_fun_fall, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_fall, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_fall_bootstraps.rds")


# Bootstrapped CIs for predicted mean temperature - Migration
pred_fun_migrate <- function(.) {
  c(predict(., data.frame(site = unique(newdat_migrate$site)), 
            re.form = NA))
}

bootCI_migrate = bootMer(temp_mod_hr_migrate, pred_fun_migrate, 
                 re.form=NA, nsim = 1000,
                 verbose = T)

saveRDS(bootCI_migrate, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_migrate_bootstraps.rds")



bootCI = readRDS("output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_bootstraps.rds")
tplot <- apply(bootCI$t, 2, 
               function(x) quantile(x, c(0.025,0.975))) %>% 
  t() %>%
  as.data.frame() %>%
  bind_cols(predict(temp_mod_hr_spawn, 
                    data.frame(site = unique(newdat_spawn$site)), 
                    re.form = NA)) %>%
  rename(q2.5 = 1, q97.5 = 2, fit = 3) %>%
  mutate(site = unique(tdata2$site)) %>%
  select(site, fit, q2.5, q97.5) %>%
  mutate(site = fct_reorder(site, fit))

tplot %>%
  ggplot() +
  geom_point(aes(y = site, x = fit)) +
  geom_errorbar(aes(y = site, xmin = q2.5, xmax = q97.5))
                      

# try Bayesian later...
# y ~ dnorm(mu, tau)
# mu ~ site[s] + day[y] + year[y]
# or in BRMS
# library(brms)
# temp_mod_hr_seas <- brm(temp ~ site + migrate + 
#                        spawn + juvenile + fall_mig +
#                        (1 | yearf/dayf/hour), 
#              data = filter(tdata, is.na(temp)==F))
# saveRDS(temp_mod_hr_seas, "output/Task2_WQ_migratory_species/statistical_analysis/temp_mod_hr_seas_stanmod.rds")
```

i. What is the daily min, max, mean temperature and dissolved oxygen?
```{r}
sites <- unique(tdata$site)



# i = sites[2]
for(i in sites){
# x11(8,5); 
print(i)
tsum %>%
  filter(site == i) %>%
  ggplot() +
  geom_errorbar(aes(x = day, ymin = min_temp, ymax = max_temp),
                width = 0, size = .3, color = "firebrick",
                alpha = 0.4) +  
  geom_point(aes(x = day, y = mean_temp), size = .5,
             color = "firebrick", shape = 18, alpha = 1) +
  geom_errorbar(aes(x = mid, ymin = mean_min, ymax = mean_max),
                width = 0, size = .5, color = "black",
                data = filter(tsum_month, site == i)) +  
  geom_point(aes(x = mid, y = mean_mean), size = 2,
             color = "black", shape = 16,
             data = filter(tsum_month, site == i)) +
  facet_wrap(~yearf) +
  theme_minimal() +
  labs(x = "", y = "Daily & monthly temperatures",
       title = i) +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  )

ggsave(paste0("output/Task2_WQ_migratory_species/PlotA/PlotA_",i,"_daily_monthly_temps.png"), height = 5, width = 8, dpi = 400)
}

```
# Plot monthy mean temperatures for each site
```{r}
sites <- unique(tdata$site)

tsum_envelope <- tdata %>%
  group_by(site, day) %>%
  summarize(multi_min = min(temp),
            multi_max = max(temp),
            .groups = "drop")

i = sites[1]

for( i in sites) {
print(i)
tsum_month %>%
  filter(site == i) %>%
  ggplot() +
  geom_ribbon(aes(x = day, ymax = multi_max,
                  ymin = multi_min), 
              data = filter(tsum_envelope, site == i),
              fill = "gray", alpha = 0.5) +
  geom_line(aes(x = mid, y = mean_mean, color = yearf), size = .5,
             shape = 16,
             position = position_dodge(width = 10)) +      
  geom_point(aes(x = mid, y = mean_mean, color = yearf), size = 2,
             shape = 16,
             position = position_dodge(width = 10)) +
  theme_minimal() +
  labs(x = "", y = "Mean monthly temperature",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  scale_color_manual(values = c(wes_palettes$Royal1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotB/PlotB_",i,"_monthly_temps.png"), height = 5, width = 7, dpi = 400)
}


```

# do monthly and daily
```{r}


sites <- unique(dodata$site)

i = sites[2]

for(i in sites){
# x11(8,5); 
print(i)
dosum %>%
  filter(site == i) %>%
  ggplot() +
  geom_errorbar(aes(x = day, ymin = min_do, ymax = max_do),
                width = 0, size = .3, color = "dodgerblue",
                alpha = 0.4) +  
  geom_point(aes(x = day, y = mean_do), size = .5,
             color = "dodgerblue", shape = 18, alpha = 1) +
  geom_errorbar(aes(x = mid, ymin = mean_min, ymax = mean_max),
                width = 0, size = .5, color = "black",
                data = filter(dosum_month, site == i)) +  
  geom_point(aes(x = mid, y = mean_mean), size = 2,
             color = "black", shape = 16,
             data = filter(dosum_month, site == i)) +
  facet_wrap(~yearf) +
  theme_minimal() +
  labs(x = "", y = "Daily & monthly dissolved oxygen",
       title = i) +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  )

ggsave(paste0("output/Task2_WQ_migratory_species/PlotC/PlotC_",i,"_daily_monthly_DO.png"), height = 5, width = 8, dpi = 400)
}
```

# Plot monthy mean DO for each site
```{r}
sites <- unique(tdata$site)

dosum_envelope <- dodata %>%
  group_by(site, day) %>%
  summarize(multi_min = min(do),
            multi_max = max(do),
            .groups = "drop")

i = "TNC_16"

for( i in sites) {
print(i)
dosum_month %>%
  filter(site == i,
         n >= 10) %>%
  ggplot() +
  geom_ribbon(aes(x = day, ymax = multi_max,
                  ymin = multi_min), 
              data = filter(dosum_envelope, site == i),
              fill = "gray", alpha = 0.5) +
  geom_line(aes(x = mid, y = mean_mean, color = yearf), size = .5,
             position = position_dodge(width = 10)) +      
  geom_point(aes(x = mid, y = mean_mean, color = yearf), size = 2,
             shape = 16,
             position = position_dodge(width = 10)) +
  theme_minimal() +
  labs(x = "", y = "Mean monthly dissolved oxygen",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12)) +
    scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  scale_color_manual(values = c(wes_palettes$Royal1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotD/PlotD_",i,"_monthly_DO.png"), height = 5, width = 7, dpi = 400)
}


```
# mean/min/max temperature during migratory fish periods
```{r}
sites <- unique(tdata$site)

i = sites[2]

for(i in sites){
  print(i)
tsum_season %>%
  filter(site == i,
         is.na(season)==F,
         n > 10) %>%
  ggplot() +
  geom_errorbar(aes(y = yearf, 
                    xmin = mean_min, xmax = mean_max),
                width = 0) +
  geom_point(aes(y = yearf, x = mean_mean, color = season2),
             size = 2) +
  facet_grid(season2~.) +
    theme_bw() +
  labs(x = "Mean daily temperature", y = "",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12),
        strip.text = element_blank(),
        strip.background = element_blank(),
        legend.position = "right") +
  scale_color_manual(values = c(wes_palettes$Zissou1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotE/PlotE_",i,"_fish_seasons_temp.png"), height = 5, width = 7, dpi = 400)
}
```
# mean/min/max DO during migratory fish periods
```{r}
sites <- unique(dodata$site)

i = sites[1]

for(i in sites){
  print(i)
dosum_season %>%
  filter(site == i,
         is.na(season)==F,
         n > 10) %>%
  ggplot() +
  geom_errorbar(aes(y = yearf, 
                    xmin = mean_min, xmax = mean_max),
                width = 0) +
  geom_point(aes(y = yearf, x = mean_mean, color = season2),
             size = 2) +
  facet_grid(season2~.) +
    theme_bw() +
  labs(x = "Mean daily dissolved oxygen", y = "",
       title = i, color = "") +
  theme(text = element_text(size = 14),
        axis.title.y = element_text(size = 12),
        strip.text = element_blank(),
        strip.background = element_blank(),
        legend.position = "right") +
  scale_color_manual(values = c(wes_palettes$Zissou1,
                                wes_palettes$Royal2))

ggsave(paste0("output/Task2_WQ_migratory_species/PlotF/PlotF_",i,"_fish_seasons_DO.png"), height = 5, width = 7, dpi = 400)
}
```
# Tables of average daily temperatures by month
- What is the monthly mean mean/min/max temperature?
```{r}

sites <- unique(tdata$site)

i = sites[1]

for(i in sites){
  print(i)
(tmonth_table <- tsum_month %>%
  filter(n >= 10,
         site == i) %>%
  rename(Year = yearf,
         Site = site,
         Mean = mean_mean,
         Max = mean_max,
         Min = mean_min) %>%
  arrange(Site, month, Year) %>%
  select(Site, Month, Year, Min, Mean, Max, n)  %>%
  kbl(caption = 
        paste0("Average daily temperatures (min, mean, and max) by month for site ", i,"."), 
      digits = 1) %>%
  kable_classic(full_width = F, html_font = "Cambria")
)

# save the table to HTML file
save_kable(tmonth_table,
           paste0("output/",
                  "Task2_WQ_migratory_species/TableA/",
                  "TableA_", i, 
                  "_monthly_average_temperatures.html"))
}

```
# Tables of average daily temperatures for 1 Jul - 15 Sept
- For July 1- Sept 15, What’s the mean daily max?
```{r}

sites <- unique(tdata$site)

i = sites[1]

for(i in sites){
  print(i)
(t_hotseason_table <- tsum_season %>%
  filter(n >= 10,
         season == "juvenile",
         site == i) %>%
  rename(Year = yearf,
         Site = site,
         Mean = mean_mean,
         'Avg. Max' = mean_max,
         'Avg. Min' = mean_min,
         'Abs. Min' = min_min,
         'Abs. Max' = max_max) %>%
    mutate(Period = "1 Jul - 15 Sep") %>%
  arrange(Site, Year) %>%
  select(Site, Year, Period, 'Abs. Min', 'Avg. Min', 
         Mean, 'Avg. Max', 'Abs. Max',  n)  %>%
  kbl(caption = 
        paste0("Average daily temperatures (min, mean, and max) during the period 1 July to 15 September for site ", i,"."), 
      digits = 1) %>%
  kable_classic(full_width = F, html_font = "Cambria")
)

# save the table to HTML file
save_kable(t_hotseason_table,
           paste0("output/",
                  "Task2_WQ_migratory_species/TableB/",
                  "TableB_", i, 
                  "_average_temps_1Jul_15Sep.html"))
}

```
# Tables of average daily temperatures for migratory fish seasons
- What is mean mean/min/max by fish season?
```{r}

sites <- unique(tdata$site)

i = sites[1]

for(i in sites){
  print(i)
(t_fishseason_table <- tsum_season %>%
  filter(n >= 10,
         site == i,
         is.na(season) == F) %>%
  rename(Year = yearf,
         Season = season2,
         Site = site,
         Mean = mean_mean,
         'Avg. Max' = mean_max,
         'Avg. Min' = mean_min,
         'Abs. Min' = min_min,
         'Abs. Max' = max_max) %>%
  arrange(Site, Season, Year) %>%
  select(Site, Season, Year, 'Abs. Min', 'Avg. Min', 
         Mean, 'Avg. Max', 'Abs. Max',  n)  %>%
  kbl(caption = 
        paste0("Average daily temperatures (min, mean, and max) during the primary migratory fish periods for site ", i,". Spring migration: 15 April - 15 May; Spawning: 16-31 May; Larvae: 1-30 June; Juvenile: 1 July - 15 Sept.; Fall migration: 16 Sept. - 30 Nov."), 
      digits = 1) %>%
  kable_classic(full_width = F, html_font = "Cambria")
)

# save the table to HTML file
save_kable(t_fishseason_table,
           paste0("output/",
                  "Task2_WQ_migratory_species/TableC/",
                  "TableC_", i, 
                  "_average_temps_mig_fish_seasons.html"))
}

```

