---
title: "Task 2. migratory species"
author: "Mike Allen"
date: "2/28/2022"
output:
  html_document: default
  pdf_document: default
---
#Task 2: Site specific water quality conditions important to us other than SWQS
a. Determine which sites are more supportive of migrating species during key lifecycle periods over time (spring adult migration, spring spawning, summer fry stage, fall fry migration)?

i. What is the daily min, max, mean temperature and dissolved oxygen?

b. Determine which sites are more likely not to thermally stress sensitive species during peak summer temperatures?
i. For the period of July 1- Sept 15
1. What’s the daily max?

c. What is the daily mean, min, and max temperatures?

d. What is the monthly mean temperature?

e. What is the annual mean temperature?

f. Are there significant changes to daily, monthly and annual mean temperature and dissolved oxygen over time (year to year, across all years sampled)?
g. How can we characterize seasonal variation over time and what differences, or patterns do we see in seasonal variation across the years?


# Product 2:
• Evaluate the water quality characteristics highlighted in Task 2 with respect to the needs of key migratory species.
• Meetings as needed to refine objectives and desired outputs.
• Data visualization (figures, maps, plots) and statistical analysis to compare same across sites and assess trends through time, along with associated interpretative text.

# Load libraries, format data, etc.
```{r}
library(dplyr)
# library(knitr)
# library(kableExtra)
library(lubridate)
# library(wesanderson)
library(ggplot2)
library(forcats)
# library(tidyr)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tdata <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime),
         month = month(datetime),
         hour = hour(datetime),
         minute = minute(datetime),
         dtime = hour + minute/60) %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
    ungroup() %>%
    # migrate April 20 - May 15?
  mutate(migrate = case_when(day %in% 110:135 ~ 1,
                            TRUE ~ 0),
         # spawn May 16 - 31?
         spawn = case_when(day %in% 136:151 ~ 1,
                            TRUE ~ 0),
         yearf = as.factor(year))

tmax <- tdata %>%
    group_by(site, year, day, migrate, spawn) %>%
  summarise(min_temp = min(temp, na.rm = T),
            max_temp = max(temp, na.rm = T),
            mean_temp = mean(temp, na.rm = T),
            .groups = "drop") %>%
  ungroup() %>%
  mutate(yearf = as.factor(year))

# to do...
# format final compiled DO data
dmin <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  group_by(site, year, day) %>%
  summarise(min_DO = min(do_adj2),
            mean24_DO = mean(do_adj2),
            .groups = "drop") %>%
  droplevels() %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  mutate(summer = case_when(day %in% 152:243 ~ 1,
                            TRUE ~ 0))



```

# Analyze temp and DO with respect to migratory fish stages
```{r}
tmax %>%
  filter(migrate == 1) %>%
  droplevels() %>%
  ggplot(aes(x = site, y = max_temp, color = as.factor(year))) +
  geom_boxplot() +
  facet_wrap(~as.factor(year)) +
  coord_flip()

tdata %>%
  filter(migrate == 1,
         year == 2021) %>%
  ggplot(aes(x = dtime, y = temp, color = day)) +
  scale_color_viridis_b() +
  geom_point(alpha = 0.5) +
  facet_wrap(~site)

library(lme4)
tmax2 <- tmax %>%
  filter(migrate == 1,
         is.infinite(max_temp) == F)

tdata2 <- tdata %>%
  filter(migrate == 1,
         is.na(temp) == F,
         day %in% 121:135) %>%
  mutate(dayf = as.factor(day))

# from GLMER FAQ:
# (x|group) = (1+x|group) 	
# random slope of x within group with correlated intercept
temp_mod1 <- lmer(temp ~ site + (1 + yearf|dayf), 
             data = tdata2)
summary(temp_mod1)

# intercept varying among years and among days within sites (nested random effects)
temp_mod2 <- lmer(temp ~ site + (1 | yearf/dayf), 
             data = tdata2)
summary(temp_mod2)


fitdata1 <- cbind(tdata2, predict(temp_mod1)) %>%
  rename(fit = 'predict(temp_mod1)')

fitdata2 <- cbind(tdata2, predict(temp_mod2)) %>%
  rename(fit = 'predict(temp_mod2)')

fitdata2 %>%
  # filter(site %in% c("TNC_2", "TNC_4", "TNC_5",
  #                    "TNC_8", "TNC_9", "TNC_10",
  #                    "TNC_13", "TNC_16", "TNC_18",
  #                    "TNC_19", "TNC_23", "TNC_24",
  #                    "TNC_25", "TNC_26")) %>%
  filter(yearf == 2021) %>%
  ggplot() +
  geom_point(aes(x = day, y = temp, color = site),
                 alpha = 0.05) +
  geom_point(aes(x = day, y = fit), shape = 16) +
  facet_wrap(~site) +
  theme_minimal()


# try Bayesian later...
# y ~ dnorm(mu, tau)
# mu ~ site[s] + day[y] + year[y]

coef(temp_mod)
```



# Fit Generalized Additive Model to temperature data
```{r}
library(mgcv)
# GAM by year with site as a covariate
tmax_gam <- tmax %>%
  mutate(yearf = as.factor(year)) %>%
  filter(is.na(max_temp)==F,
         day %in% 91:288) %>%
  arrange(site, year, day)

gam_1 <- gam(max_temp ~ s(day, by = yearf) + site,
             data = tmax_gam,
             family = gaussian)
sink(paste0("output/Task1_SWQS_loggers/",
              "statistical_analysis/GAM_results_temp.txt"))
summary(gam_1)
sink()

summary(gam_1)

```
# Plot each results from temperature GAM for each year
```{r}
temp2 <- cbind(tmax_gam, fit = gam_1$fitted.values)
for(the_year in c(2016:2021)){
  print(the_year)
  temp2 %>% filter(yearf == the_year) %>%
  ggplot() +
  geom_vline(xintercept = 196, lty = 2, color = "darkgray") +  
  geom_point(aes(x = day, y = max_temp), color = "darkgray") +
  geom_line(aes(x = day, y = fit), color = "salmon") +

  facet_wrap(~site) +
  theme_bw() +
  labs(x = "", y = "Daily maximum temperature (C)",
       title = paste0("GAM results: ", the_year)) +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 9),
        strip.background = element_rect(fill = "white")) + 
  scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  )

ggsave(paste0("output/Task1_SWQS_loggers/",
              "statistical_analysis/GAM_plots/GAM_plots_",
              the_year, ".png"),
       height = 5, width = 7, dpi = 400)
}

```
# Plot GAM predicted temperature values from July 15th
```{r}
tmax_jul15 <- data.frame(
  expand.grid(site = unique(tmax$site), 
                                   yearf = 2016:2021, 
                                   day = 196),
  meanTmax = predict(gam_1, 
                     newdata = 
                       expand.grid(site = unique(tmax$site), 
                                   yearf = 2016:2021, 
                                   day = 196), se.fit = T)[[1]],
  seTmax = predict(gam_1, 
                     newdata = 
                       expand.grid(site = unique(tmax$site), 
                                   yearf = 2016:2021, 
                                   day = 196), se.fit = T)[[2]]) %>%
  mutate(site = fct_reorder(site, meanTmax))

tmax_jul15

tmax_jul15 %>%
  ggplot() +
  geom_errorbar(aes(y = site, xmax = meanTmax+2*seTmax,
                    xmin = meanTmax-2*seTmax),
                width = 0, color = "dodgerblue") + 
  geom_point(aes(y = site, x = meanTmax),
             color = "dodgerblue") +  
  # geom_hline(aes(yintercept = ))
  facet_wrap(~as.factor(yearf)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white"),
        axis.text.y = element_text(size = 10)) +
  labs(x = "Predicted mean maximum temperature on July 15th", 
       y = "",
       title = "Generalized Additive Model (GAM) results") +
  scale_x_continuous(breaks = c(20, 22, 24, 26, 28))

ggsave(
  "output/Task1_SWQS_loggers/PlotN_temp_GAM_standardized_site_comparisons.png",
         width = 7, height = 7, dpi = 400)
```

# Fit Generalized Additive Model to DO data
```{r}
library(mgcv)
# GAM by year with site as a covariate
dmin_gam <- dmin %>%
  mutate(yearf = as.factor(year)) %>%
  filter(is.na(min_DO)==F,
         day %in% 91:288) %>%
  arrange(site, year, day)

gam_2 <- gam(min_DO ~ s(day, by = yearf) + site,
             data = dmin_gam,
             family = gaussian)

sink(paste0("output/Task1_SWQS_loggers/",
              "statistical_analysis/GAM_results/GAM_results_DO.txt"))
summary(gam_2)
sink()

summary(gam_2)

```
# Plot each results from temperature GAM for each year
```{r}
temp3 <- cbind(dmin_gam, fit = gam_2$fitted.values)
for(the_year in c(2016:2021)){
  print(the_year)
  temp3 %>% filter(yearf == the_year) %>%
  ggplot() +
  geom_vline(xintercept = 196, lty = 2, color = "darkgray") +  
  geom_point(aes(x = day, y = min_DO), color = "darkgray") +
  geom_line(aes(x = day, y = fit), color = "salmon") +
  facet_wrap(~site) +
  theme_bw() +
  labs(x = "", y = "Daily minimum dissolved oxygen",
       title = paste0("GAM results: ", the_year)) +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 9),
        strip.background = element_rect(fill = "white")) + 
  scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  )

ggsave(paste0("output/Task1_SWQS_loggers/",
              "statistical_analysis/GAM_plots/GAM_plots_DO",
              the_year, ".png"),
       height = 5, width = 7, dpi = 400)
}

```
# Plot GAM predicted dissolved oxygen values from July 15th
```{r}
dmin_jul15 <- data.frame(
  expand.grid(site = unique(dmin$site), 
                                   yearf = 2016:2021, 
                                   day = 196),
  meandmin = predict(gam_2, 
                     newdata = 
                       expand.grid(site = unique(dmin$site), 
                                   yearf = 2016:2021, 
                                   day = 196), se.fit = T)[[1]],
  sedmin = predict(gam_2, 
                     newdata = 
                       expand.grid(site = unique(dmin$site), 
                                   yearf = 2016:2021, 
                                   day = 196), se.fit = T)[[2]]) %>%
  mutate(site = fct_reorder(site, meandmin))

dmin_jul15

dmin_jul15 %>%
  ggplot() +
  geom_errorbar(aes(y = site, xmax = meandmin+2*sedmin,
                    xmin = meandmin-2*sedmin),
                width = 0, color = "dodgerblue") + 
  geom_point(aes(y = site, x = meandmin),
             color = "dodgerblue") +  
  facet_wrap(~as.factor(yearf)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white"),
        axis.text.y = element_text(size = 10)) +
  labs(x = "Predicted mean minimum dissolved oxygen on July 15th", 
       y = "",
       title = "Generalized Additive Model (GAM) results") +
  scale_x_continuous(breaks = 2:8)

ggsave(
  "output/Task1_SWQS_loggers/PlotO_DO_GAM_standardized_site_comparisons.png",
         width = 7, height = 7, dpi = 400)
```

# Bivariate GAM temp vs. DO
Predict DO and max temperature on July 15, 2018
```{r}
dmin_jul15 %>%
  left_join(tmax_jul15) %>%
  filter(yearf == 2018) %>%
  ggplot() +
  geom_errorbar(aes(xmin = meanTmax-2*seTmax, 
                    xmax = meanTmax+2*seTmax, y = meandmin)) +
  geom_errorbar(aes(ymin = meandmin-2*sedmin, 
                    ymax = meandmin+2*sedmin, x = meanTmax)) +     
  geom_point(aes(x = meanTmax, y = meandmin), size = 2) +
  geom_text(aes(x = meanTmax-.1, y = meandmin-.1, label = site),
            color = "gray", size = 2) +

  theme_bw() +
  theme(text = element_text(size = 14)) +
  labs(x = "Predicted mean maximum temp. (C)",
       y = "Predicted mean minimum DO")

ggsave(
  "output/Task1_SWQS_loggers/PlotP_DO_and_temp_GAM_standardized_site_comparisons.png",
         width = 5, height = 5, dpi = 400)

```

