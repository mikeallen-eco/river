# To do: errors discovereed
1. see 3 QC filter steps for hobo
2. TNC_25_CLDHY_2_masterfile_2017.xlsx sheet name is "2021"
  note: I fixed this in temp copy to allow compile to run
3. possible naming issue in HYDRO data: is CLDHY-2 the same as CLDHY_2? In file: TNC_81_CLDHY2_2020_masterfile.xlsx

# To do: questions
1. Some "troughs" in DO remain

# load libraries
```{r}
library(dplyr)
library(here)
library(readxl)
library(lubridate)
library(ggplot2)
here <- here::here # resolve namespace conflict
# load function to compile data files for hobo or hydro loggers 
source(here("scripts", "logger_compile_function.R"))
# load function to plot temp or do over time for each site/year 
source(here("scripts", "logger_plot_function.R"))

# set path to folder where the latest logger data files are kept
logger_path <- "D:/river/Logger_Data_dl_20220104/" 
```

# Read and compile HOBO data using logger_compile function
```{r}
hobo <- logger_compile("2016", type = "hobo") %>%
  bind_rows(logger_compile("2017", type = "hobo")) %>%
  bind_rows(logger_compile("2018", type = "hobo")) %>%
  bind_rows(logger_compile("2019", type = "hobo")) %>%
  bind_rows(logger_compile("2020", type = "hobo")) %>%
  bind_rows(logger_compile("2021", type = "hobo")) %>%
  # remove rows with year = NA (removes ~50k rows)
  filter(is.na(year) != TRUE) %>%
# temporary fix for 10460 rows in TNC_24_CLDHO_1_2019_masterfile.xlsx
# with wrong year, site, and logger values (increasing sequentially)
  mutate(site = case_when(year != year(datetime) ~ "TNC_24",
                          TRUE ~ site),
         logger = case_when(year != year(datetime) ~ "CLDHO_1",
                            TRUE ~ logger),
         year = case_when(year != year(datetime) ~ year(datetime),
                          TRUE ~ year)) %>%
# fix name (TNC to TNC_16) in TNC_16_PKHO_10_2017_masterfile.xlsx
# affected 15372 rows
  mutate(site = case_when(site == "TNC" ~ "TNC_16",
                          TRUE ~ site)) %>%
  # remove 17952 rows from various files with large negative numbers
  filter(temp != -9999.00,
         temp != -888.88)

# to filter sites by site number if needed
 # %>% filter(as.numeric(gsub("TNC_", "", site)) < 30)
```
# Various QC checks for HOBO data
```{r}

str(hobo)
unique(hobo$year) # 2016:2021
unique(hobo$site)
length(unique(hobo$site)) # 16
unique(hobo$logger)
length(unique(hobo$logger)) # 16
table(hobo$FLAG_temp)
table(hobo$FLAG_DO)
table(hobo$FLAG_other)
table(hobo$FLAG_cnt)
unique(hobo$logger)

hobo_flag5 = hobo[hobo$FLAG_DO == 5,] #
 
# checks for things that were fixed above
nrow(hobo[hobo$year != lubridate::year(hobo$datetime),]) # now 0
nrow(hobo[hobo$site == "TNC",]) # now 0
nrow(hobo[hobo$temp <= 0,]) # now 0

```
# Plotting HOBO data by site for QC
```{r}
# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(filename = paste0("output/Initial_QC/hobo_temp/", i, 
              "_hobo_temp.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0("output/Initial_QC/hobo_do/", i, "_hobo_do.png"), 
              width = 9, height = 9, dpi = 100)
}

# do the same but now without flagged data
# make versions of the data without any flagged observations
hobo_no_temp_flags <- hobo %>%
  filter(FLAG_temp == 0)

hobo_no_DO_flags <- hobo %>%
  filter(FLAG_DO == 0)

# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo_no_temp_flags, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(filename = paste0("output/Initial_QC/hobo_temp/", i, 
              "_hobo_temp_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HOBO temperature data by site & year for QC
for(i in as.character(unique(hobo$year))){
logger_plot(hobo_no_DO_flags, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0("output/Initial_QC/hobo_do/", i, 
              "_hobo_do_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

rm(hobo_no_temp_flags, hobo_no_DO_flags)
```
# Read and compile HYDRO data using logger_compile function
```{r}

hydro <- logger_compile("2016", type = "hydro") %>%
  bind_rows(logger_compile("2017", type = "hydro")) %>%
  bind_rows(logger_compile("2018", type = "hydro")) %>%
  bind_rows(logger_compile("2019", type = "hydro")) %>%
  bind_rows(logger_compile("2020", type = "hydro")) %>%
  bind_rows(logger_compile("2021", type = "hydro")) %>%
  # remove a 12 row with NA year (and other fields)
  filter(is.na(year) != TRUE,
         is.na(temp) != TRUE)

# note: TNC_25_CLDHY_2_masterfile_2017.xlsx sheet name was "2021"
#   I corrected it so the code would run; inform TNC

```


# Various QC checks for HYDRO data
```{r}
str(hydro)
unique(hydro$year) # 2016:2021
unique(hydro$site)
length(unique(hydro$site)) # 9
unique(hydro$logger)
length(unique(hydro$logger)) # 7 
# note: possible naming issue: is CLDHY-2 the same as CLDHY_2?
# file: TNC_81_CLDHY2_2020_masterfile.xlsx
hydro[hydro$logger == "CLDHY-2",]

# checks for things that were fixed above
nrow(hydro[is.na(hydro$temp),]) # 0
nrow(hydro[hydro$year != lubridate::year(hydro$datetime),]) # 0
nrow(hydro[hydro$temp <= 0,]) # 0
nrow(hydro[is.na(hydro$temp) == TRUE,]) # 0
```
# Plotting HYDRO data by site for QC
```{r}
# make all HYDRO temperature data by site & year for QC
for(i in as.character(unique(hydro$year))){
logger_plot(hydro, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(paste0("output/Initial_QC/hydro_temp/", i, 
              "_hydro_temp.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HYDRO temperature data by site & year for QC
for(i in as.character(unique(hydro$year))){
logger_plot(hydro, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0("output/Initial_QC/hydro_do/", i, "_hydro_do.png"), 
              width = 9, height = 9, dpi = 100)
}

# do the same but now without flagged data
# make versions of the data without any flagged observations
hydro_no_temp_flags <- hydro %>%
  filter(FLAG_Temp == 0)

hydro_no_DO_flags <- hydro %>%
  filter(FLAG_DO == 0)

# make all HYDRO temperature data by site & year for QC
for(i in as.character(unique(hydro$year))){
logger_plot(hydro_no_temp_flags, i, "temp")
print(paste0("saving ", i, " plot"))
ggsave(paste0("output/Initial_QC/hydro_temp/", i, "_hydro_temp_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

# make all HYDRO temperature data by site & year for QC
for(i in as.character(unique(hydro$year))){
logger_plot(hydro_no_DO_flags, i, "do")
print(paste0("saving ", i, " plot"))
ggsave(paste0("output/Initial_QC/hydro_do/", i, 
              "_hydro_do_noflag.png"), 
              width = 9, height = 9, dpi = 100)
}

rm(hydro_no_temp_flags, hydro_no_DO_flags)
```

# Make final hobo-hydro file with temp and DO
```{r}
p <- hobo %>%
  select(site, year, datetime, logger, temp, do, do_adj, do_sat,
         FLAG_Temp = FLAG_temp, FLAG_DO) %>%
  mutate(spcon = NA, turb = NA, FLAG_NTU = NA, FLAG_SpCnd = NA,
         logger_type = "hobo") %>%
  bind_rows(mutate(hydro, logger_type = "hydro")) %>%
  select(site:logger_type)

# saveRDS(p, "output/compiled_hydro_hobo.rds")
```
# plot time series for each site/year vs. thresholds (showing loggers)
```{r}

unique(p$site)
#  [1] "TNC_10" "TNC_18" "TNC_19" "TNC_2"  "TNC_28" "TNC_5"  "TNC_8" 
#  [8] "TNC_9"  "TNC_16" "TNC_24" "TNC_4"  "TNC_13" "TNC_81" "TNC_80"
# [15] "TNC_23" "TNC_25" "TNC_26" "TNC_27"

for(station in unique(p$site)){
  
# station = "TNC_80"
p %>%
  filter(FLAG_Temp == 0,
         site == station) %>%
  ggplot() +
  geom_hline(yintercept = 22, color = "gray", lty = 3, size = 1) +
  geom_hline(yintercept = 25, color = "gray", lty = 2, size = 1) +
  geom_hline(yintercept = 31, color = "gray", lty = 1, size = 1) +  geom_point(aes(x = yday(datetime), y = temp, color = logger), 
             shape = 1, alpha = 0.5, size = 0.1) +
  facet_wrap(~year) +
  scale_color_manual(values = wes_palette("Darjeeling1")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = "none",
        strip.background = element_rect(fill = "white")) +
  labs(y = "Temperature (degrees C)", x = "Day of year",
       title = station) +
  scale_y_continuous(limits = c(0,35))

ggsave(paste0("output/Initial_QC/temp_by_date_year_site_logger/", 
              station, "_temp.png"),
       height = 6, width = 6, dpi = 400)
}
```

