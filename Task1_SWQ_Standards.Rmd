---
title: "Task 1. SWQ Standards"
author: "Mike Allen"
date: "2/4/2022"
output:
  html_document: default
  pdf_document: default
---
# Task 1: Surface Water Quality Standards (SWQS)
a. Analyze logger data to determine if select monitoring reaches are impaired for sensitive aquatic life (e.g., macroinvertebrates, trout) in freshwater streams. 
- Analyze daily/monthly data at each monitoring location against state SWQS criteria. Which sites are meeting/not meeting SWQS (do temperatures and dissolved oxygen meet criteria required to support aquatic life and trout?)?
b. How often do sites exceed SWQS for temperature (how many days per year)?
c. How often do sites exceed SWQS for dissolved oxygen (how many days per year)?


# Product 1:
• Data visualization (figures, maps, plots) of seasonal, monthly, and diel fluctuations in flow, physiochemical conditions to address the items in Task 1 with respect to state water quality criteria.

• Meetings as needed to refine objectives and desired outputs.

• Summary statistics and statistical analysis of same along with associated interpretative text.

To do:
* add TNC_80's graphs
* add way to flag/remove years with low coverage in Jun-Aug
* graphs of individual sites w/ panels by year (maybe raw & rolling average on same graph)
* fix "adjusted DO" graphs & tables (include deleted data)
* fix DO boxplot figure (good -> bad = top -> bottom)
5. research statistically controlling for air temp (water temp ~ air temp)
6. research methods to statistically QC / censor DO data using water temp data
* add low-sample-size flag to tables
* try bivariate figure that includes temp and DO days above
* days above either threshold boxplot


# Load libraries, format data, etc.
```{r}
library(dplyr)
library(knitr)
library(kableExtra)
library(lubridate)
library(wesanderson)
library(ggplot2)
library(forcats)
library(tidyr)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tmax <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime)) %>%
  group_by(site, year, day) %>%
  summarise(max_temp = max(temp),
            .groups = "drop") %>%
  group_by(site, year) %>%
  mutate(roll_temp = zoo::rollmean(max_temp, 7, fill = NA)) %>%
  droplevels() %>%
  ungroup() %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  mutate(summer = case_when(day %in% 152:243 ~ 1,
                            TRUE ~ 0))

# summarize number of days above temperature thresholds
temp_count <- tmax %>%
  filter(is.na(max_temp)==F) %>%
  mutate(max_22 = ifelse(max_temp > 22, 1, 0),
         max_25 = ifelse(max_temp > 25, 1, 0),
         max_31 = ifelse(max_temp > 31, 1, 0),
         roll_19 = ifelse(roll_temp > 19, 1, 0),
         roll_23 = ifelse(roll_temp > 23, 1, 0),
         roll_28 = ifelse(roll_temp > 28, 1, 0),
         FW2_TP = case_when(max_22 > 0 ~ 1,
                            roll_19 > 0 ~ 1, 
                            TRUE ~ 0),
         FW2_TM = case_when(max_25 > 0 ~ 1,
                            roll_23 > 0 ~ 1, 
                            TRUE ~ 0),
         FW2_NT = case_when(max_31 > 0 ~ 1,
                            roll_28 > 0 ~ 1,
                            TRUE ~ 0)) %>%
  group_by(site, year) %>%
  summarise(max_22 = sum(max_22),
            max_25 = sum(max_25),
            max_31 = sum(max_31),
            roll_19 = sum(roll_19, na.rm = T),
            roll_23 = sum(roll_23, na.rm = T),
            roll_28 = sum(roll_28, na.rm = T),
            Trout_Production = sum(FW2_TP),
            Trout_Maintenance = sum(FW2_TM),
            Non.Trout = sum(FW2_NT),
            summer_days = sum(summer)/92,
            .groups = "drop") %>%
  pivot_longer(cols = 9:11, names_to = "Threshold",
                      values_to = "days_over") %>%
  mutate(Threshold = gsub(gsub(Threshold, pattern = "_", 
                          replacement = " "), pattern = "\\.",
                          replacement = "-")) %>%
  ungroup() %>%
  select(-starts_with("max"), -starts_with("roll"))

# Create data frame listing sites with low temperature data coverage
temp_cov <- temp_count[temp_count$summer_days < 0.8,] %>%
  select(site, year, summer_days) %>%
  distinct() %>%
  mutate(low = case_when((summer_days < 0.8 &
                            summer_days >= 0.5) ~ "*",
                         summer_days < 0.5 ~ "**"
  ))

# format final compiled DO data
dmin <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  group_by(site, year, day) %>%
  summarise(min_DO = min(do_adj2),
            mean24_DO = mean(do_adj2),
            .groups = "drop") %>%
  droplevels() %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  mutate(summer = case_when(day %in% 152:243 ~ 1,
                            TRUE ~ 0))

# summarize number of days below DO thresholds
DO_count <- dmin %>%
  filter(is.na(min_DO)==F) %>%
  mutate(min_7 = ifelse(min_DO < 7, 1, 0),
         min_5 = ifelse(min_DO < 5, 1, 0),
         min_4 = ifelse(min_DO < 4, 1, 0),
         mean24_6 = ifelse(mean24_DO < 6, 1, 0),
         mean24_5 = ifelse(mean24_DO < 5, 1, 0),
         FW2_TP = case_when(min_7 > 0 ~ 1,
                            TRUE ~ 0),
         FW2_TM = case_when(min_5 > 0 ~ 1,
                            mean24_6 > 0 ~ 1,
                            TRUE ~ 0),
         FW2_NT = case_when(min_4 > 0 ~ 1,
                            mean24_5 > 0 ~ 1,
                            TRUE ~ 0)) %>%
  group_by(site, year) %>%
  summarise(min_7 = sum(min_7),
            min_5 = sum(min_5),
            min_4 = sum(min_4),
            mean24_6 = sum(mean24_6, na.rm = T),
            mean24_5 = sum(mean24_5, na.rm = T),
            Trout_Production = sum(FW2_TP),
            Trout_Maintenance = sum(FW2_TM),
            Non.Trout = sum(FW2_NT),
            summer_days = sum(summer)/92,
            .groups = "drop") %>%
  pivot_longer(cols = 8:10, names_to = "Threshold",
                      values_to = "days_under") %>%
  select(site, year, Threshold, days_under, summer_days) %>%
  mutate(Threshold = gsub(gsub(Threshold, pattern = "_", 
                          replacement = " "), pattern = "\\.",
                          replacement = "-"))

# Create data frame listing sites with low DO data coverage
DO_cov <- DO_count[DO_count$summer_days < 0.8,] %>%
  select(site, year, summer_days) %>%
  distinct() %>%
  mutate(low = case_when((summer_days < 0.8 &
                            summer_days >= 0.5) ~ "*",
                         summer_days < 0.5 ~ "**"
  ))


# combine "days exceeding" counts for temperature and DO
both_count <- temp_count %>%
  left_join(DO_count, by = c("site", "year", "Threshold"))


# compile "either threshold" data
either <- tmax %>%
  left_join(dmin, by = c("site", "year", "day", "summer"))

# either count
either_count <- either %>%
  mutate(max_22 = ifelse(max_temp > 22, 1, 0),
         max_25 = ifelse(max_temp > 25, 1, 0),
         max_31 = ifelse(max_temp > 31, 1, 0),
         roll_19 = ifelse(roll_temp > 19, 1, 0),
         roll_23 = ifelse(roll_temp > 23, 1, 0),
         roll_28 = ifelse(roll_temp > 28, 1, 0),
         min_7 = ifelse(min_DO < 7, 1, 0),
         min_5 = ifelse(min_DO < 5, 1, 0),
         min_4 = ifelse(min_DO < 4, 1, 0),
         mean24_6 = ifelse(mean24_DO < 6, 1, 0),
         mean24_5 = ifelse(mean24_DO < 5, 1, 0),
         FW2_TP = case_when(max_22 > 0 ~ 1,
                            roll_19 > 0 ~ 1,
                            min_7 > 0 ~ 1,
                            TRUE ~ 0),
         FW2_TM = case_when(max_25 > 0 ~ 1,
                            roll_23 > 0 ~ 1,
                            min_5 > 0 ~ 1,
                            mean24_6 > 0 ~ 1,
                            TRUE ~ 0),
         FW2_NT = case_when(max_31 > 0 ~ 1,
                            roll_28 > 0 ~ 1,
                            min_4 > 0 ~ 1,
                            mean24_5 > 0 ~ 1,
                            TRUE ~ 0),
         max_temp_NA = ifelse(is.na(max_temp), 1, 0),
         min_DO_NA = ifelse(is.na(min_DO), 1, 0)) %>%
    group_by(site, year) %>%
    summarise(Trout_Production = sum(FW2_TP),
            Trout_Maintenance = sum(FW2_TM),
            Non.Trout = sum(FW2_NT),
            summer_days_temp = sum(summer==1 & max_temp_NA == 0)/92,
            summer_days_DO = sum(summer==1 & min_DO_NA == 0)/92,
            .groups = "drop") %>%
  pivot_longer(cols = 3:5, names_to = "Threshold",
                      values_to = "days_exceeding") %>%
  select(site, year, Threshold, days_exceeding, 
         summer_days_temp, summer_days_DO) %>%
  mutate(Threshold = gsub(gsub(Threshold, pattern = "_", 
                          replacement = " "), pattern = "\\.",
                          replacement = "-")) %>%
  filter(!(summer_days_temp==0 & summer_days_DO==0))
```

# Temperature SWQS
b. How often do sites exceed SWQS for temperature (how many days per year)?

From the QAPP:
	1. FW2-TP - Temperature	Shall not exceed a daily maximum of 22 degrees Celsius or rolling seven-day average of the daily maximum of 19 degrees Celsius, unless due to natural conditions
	  - How many days exceed 22 C
	  - How many days 7-d rolling average of daily max exceed 19 C
	
	2. FW2-TM - Shall not exceed a daily maximum of 25 degrees Celsius or rolling seven-day average of the daily maximum of 23 degrees Celsius, unless due to natural conditions	
    - How many days exceed 25 C
    - How many days 7-d rolling average of daily max exceed 23 C

	3. FW2-NT - Shall not exceed a daily maximum of 31 degrees Celsius or rolling seven-day average of the daily maximum of 28 degrees Celsius, unless due to natural conditions	
	
## Temperature SWQS: plot daily max temp for each site/year vs. thresholds
```{r}
# plot daily max vs. thresholds
#x11(height = 7, width = 9)
tmax %>%
  ggplot() +
  geom_hline(
    yintercept = 22,
    color = "gray",
    lty = 3,
    size = .75
  ) +
  geom_hline(
    yintercept = 25,
    color = "gray",
    lty = 2,
    size = .75
  ) +
  geom_hline(
    yintercept = 31,
    color = "gray",
    lty = 1,
    size = .75
  ) +
  geom_line(aes(x = day, y = max_temp,
                color = as.factor(year)),
            alpha = 0.75) +
  facet_wrap( ~ site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 14),
    axis.text.x = element_text(size = 10),
    strip.background = element_rect(fill = "white")
  ) +
  labs(y = "Daily maximum temperature (C)", x = "",
       color = "Year") +
  annotate("text", x = 335, y = 30, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 24, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 21, label = "TP", 
           color = "darkgray", size = 2)

# ggsave("output/Task1_SWQS_loggers/PlotA_tmax_by_day_year_site3.png",
#        height = 7, width = 9, dpi = 400)
```
## Temperature SWQS: plot rolling-average daily max temp for each site/year vs. thresholds
```{r}
# plot rolling average daily max vs. thresholds
tmax %>%
  ggplot() +
  geom_hline(yintercept = 19, color = "gray", lty = 3, size = .75) +
  geom_hline(yintercept = 23, color = "gray", lty = 2, size = .75) +
  geom_hline(yintercept = 28, color = "gray", lty = 1, size = .75) +
  geom_line(aes(x = day, y = roll_temp, 
                 color = as.factor(year)),
             alpha = 0.75) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = c(91, 152, 213, 274, 335),
                     labels = c("Apr", "Jun", "Aug", 
                                "Oct", "Dec")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 10),
        strip.background = element_rect(fill = "white")) +
  labs(y = "Daily maximum temperature (C)\n7-day rolling average", 
       x = "",
       color = "Year") +
  annotate("text", x = 335, y = 27, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 22, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 18, label = "TP", 
           color = "darkgray", size = 2)

# ggsave("output/Task1_SWQS_loggers/PlotB_tmax_by_day_year_site_rolling3.png",
#           height = 7, width = 9, dpi = 400)
```
## create tables: n days and days over T per year & site
```{r}
# create table with Kable
day_table <- tmax %>%
  droplevels() %>%
  filter(is.na(max_temp) != T) %>%
  group_by(site, year) %>%
  tally() %>%
  left_join(temp_cov) %>%
  mutate(n = case_when(is.na(low)==F ~ paste0(as.character(n), low),
                          TRUE ~ as.character(n))) %>%
  select(-low) %>%
  pivot_wider(id_cols = site, 
              names_from = year, 
              values_from = n) %>%
  kbl(caption = "Total number of days with temperature data in each year. Asterisks indicate years with less complete data coverage during the warmest period (Jun-Aug). * = less than 80% coverage; ** = less than 50% coverage.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

day_table

# save the table to HTML file
# save_kable(day_table,
#            "output/Task1_SWQS_loggers/TableA_tmax_n_table3.html")

## Table of "Days above TM temp. threshold"
days_over_table <- temp_count %>%
  filter(Threshold == "Trout Maintenance") %>%
  select(site, year, days_over, summer_days) %>%
  left_join(temp_cov) %>%
  mutate(days_over = case_when(is.na(low)==F ~ 
                         paste0(as.character(days_over), low),
                          TRUE ~ as.character(days_over))) %>%
  select(-low) %>%
  pivot_wider(id_cols = site, names_from = year,
              values_from = days_over) %>%
  kbl(caption = "Total number of days with tempertature readings over the Trout Maintenance threshold. Asterisks indicate years with less complete data during the warmest period (Jun-Aug). * = less than 80% coverage; ** = less than 50% coverage.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

days_over_table

# save the table to HTML file
# save_kable(
#   days_over_table,
#   "output/Task1_SWQS_loggers/TableB_tmax_days_over_TM_table3.html")

rm(day_table, days_over_table)
```
## Plot number of days exceeding temperature thresholds
```{r}
temp_count_bad <- temp_count %>%
  left_join(temp_cov) %>%
  filter(is.na(low) == F)

temp_count %>%
  filter(summer_days >= 0.8) %>%
ggplot() +
  geom_line(aes(x = year, y = days_over, color = Threshold)) +
  geom_point(aes(x = year, y = days_over, color = Threshold), 
             size = 3) +
  geom_point(data = temp_count_bad, aes(x = year, y = days_over,
                                        shape = "*",
                                        color = Threshold)) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 7),
        strip.background = element_rect(fill = "white"),
        legend.position = "top",
        legend.justification="center",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-8,-8,-8,-8)) +
  labs(x = "", y = "Days above temp. threshold") +
  guides(shape = "none")

# ggsave(
#   "output/Task1_SWQS_loggers/PlotC_days_above_temp_threshold_timeseries.png",
#        height = 7, width = 9, dpi = 400)

rm(temp_count_bad)
```
## "days over temp threshold" boxplots by site
```{r}
# x11(width = 8, height = 6)
temp_count %>%
  filter(summer_days >= 0.8) %>%
  group_by(site) %>%
  mutate(mean_days = mean(days_over)) %>%
  ungroup() %>%
  mutate(site = fct_reorder(as.factor(site), 
                            days_over, 
                            .fun = "mean",
                            .desc = T)) %>%
  ggplot() +
  geom_boxplot(aes(y = site, x = days_over), 
               outlier.color = "transparent",
               color = "darkgray") +
  geom_point(aes(y = site, x = days_over, 
                 color = as.factor(year)), size = 3, 
             alpha =0.75, shape = 16) +
  scale_color_manual(values = c(wes_palettes$Darjeeling1,
                                wes_palettes$Darjeeling2)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = c(0.687,0.14),
        legend.justification="left",
        legend.margin=margin(2,2,2,2),
        legend.box.margin=margin(0,0,0,0),
        legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(color = "darkgray"),
        strip.background = element_rect(fill = "white")) +
  labs(y = "", x = "Days above temperature threshold", 
       color = "Year") +
    facet_wrap(~Threshold)

# ggsave(
#   "output/Task1_SWQS_loggers/PlotD_days_above_temp_threshold_boxplot2.png",
#        width = 8,
#        height = 6, dpi = 400)
```
# Dissolved Oxygen SWQS
c. How often do sites exceed SWQS for dissolved oxygen (how many days per year)?

FW2-TP
Not less than 7.0 at any time 

FW2-TM
24-hour average not less than 6.0. Not less than 5.0 at any time

FW2-NT
24-hour average not less than 5.0, but not less than 4.0 at any time 
FW2-TM, FW2-NT
Supersaturated dissolved oxygen values shall be expressed as their corresponding 100 percent saturation values for purposes of calculating 24 hour averages

## DO SWQS: plot daily min for each site/year vs. thresholds
```{r}
# plot daily min DO vs. thresholds
# x11(width = 9, heigh = 7)
dmin %>%
  ggplot() +
  geom_hline(yintercept = 7, color = "gray", lty = 3, size = .75) +
  geom_hline(yintercept = 5, color = "gray", lty = 2, size = .75) +
  geom_hline(yintercept = 4, color = "gray", lty = 1, size = .75) + 
  geom_line(aes(x = day, y = min_DO, 
                 color = as.factor(year)),
             alpha = 0.75) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = c(91, 152, 213, 274, 335),
                     labels = c("Apr", "Jun", "Aug", 
                                "Oct", "Dec")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white")) +
  labs(y = "Daily minimum dissolved oxygen", x = "",
       color = "Year") +
  annotate("text", x = 335, y = 3, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 6, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 8, label = "TP", 
           color = "darkgray", size = 2)

# ggsave(
#   "output/Task1_SWQS_loggers/PlotE_dmin_adj_by_day_year_site2.png",
#        height = 7, width = 9, dpi = 400)
```
## DO SWQS: plot 24-h average daily DO for each site/year vs. thresholds
```{r}
# plot 24-h average DO vs. thresholds
# x11(width = 9, heigh = 7)
dmin %>%
  ggplot() +
  geom_hline(yintercept = 6, color = "gray", lty = 2, size = .75) +
  geom_hline(yintercept = 5, color = "gray", lty = 1, size = .75) +
  geom_line(aes(x = day, y = mean24_DO, 
                 color = as.factor(year)),
             alpha = 0.75) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = c(91, 152, 213, 274, 335),
                     labels = c("Apr", "Jun", "Aug", 
                                "Oct", "Dec")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        strip.background = element_rect(fill = "white")) +
  labs(y = "Daily average dissolved oxygen", x = "",
       color = "Year") +
  annotate("text", x = 335, y = 4, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 7, label = "TM", 
           color = "darkgray", size = 2) 

# ggsave(
#   "output/Task1_SWQS_loggers/PlotF_dmin_by_day_year_24h_avg2.png",
#   height = 7, width = 9, dpi = 400)
```
## create table of number of DO measurement days per year per site
```{r}

day_table <- tmax %>%
  droplevels() %>%
  filter(is.na(max_temp) != T) %>%
  group_by(site, year) %>%
  tally() %>%
  left_join(temp_cov) %>%
  mutate(n = case_when(is.na(low)==F ~ paste0(as.character(n), low),
                          TRUE ~ as.character(n))) %>%
  select(-low) %>%
  pivot_wider(id_cols = site, 
              names_from = year, 
              values_from = n)

# create table with Kable
day_table_DO <- dmin %>%
  droplevels() %>%
  filter(is.na(min_DO) != T) %>%
  group_by(site, year) %>%
  tally() %>%
  left_join(DO_cov) %>%
  mutate(n = case_when(is.na(low)==F ~ paste0(as.character(n), low),
                          TRUE ~ as.character(n))) %>%
  select(-low) %>%
  pivot_wider(id_cols = site, 
              names_from = year, 
              values_from = n) %>%
  kbl(caption = "Total number of days with dissolved oxygen data in each year. Asterisks indicate years with less complete data coverage during the warmest period (Jun-Aug). * = less than 80% coverage; ** = less than 50% coverage.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

day_table_DO

# save the table to HTML file
# save_kable(day_table_DO,
#            "output/Task1_SWQS_loggers/TableC_dmin_n_table2.html")

# Table of "Days below DO threshold"
days_below_table <- DO_count %>%
  filter(Threshold == "Trout Maintenance") %>%
  select(site, year, days_under, summer_days) %>%
  left_join(DO_cov) %>%
  mutate(days_under = case_when(is.na(low)==F ~ 
                         paste0(as.character(days_under), low),
                          TRUE ~ as.character(days_under))) %>%
  select(-low) %>%
  pivot_wider(id_cols = site, names_from = year,
              values_from = days_under) %>%
  kbl(caption = "Total number of days with dissolved oxygen readings below the minimum Trout Maintenance threshold. Asterisks indicate years with less complete data during the warmest period (Jun-Aug). * = less than 80% coverage; ** = less than 50% coverage.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

days_below_table

# save the table to HTML file
# save_kable(days_below_table,
#   "output/Task1_SWQS_loggers/TableD_dmin_days_under_TM_table2.html")

rm(dmin_table, days_below_table)
```
## Plot number of days below DO thresholds (time series)
```{r}
# create a separate data frame of years with < 80% Jun-Aug coverage
DO_count_bad <- DO_count %>%
  left_join(DO_cov) %>%
  filter(is.na(low) == F)

DO_count %>%
  # filter out site/year with < 80% coverage during Jun-Aug
  mutate(days_under = case_when(summer_days>=0.8 ~ days_under,
                                TRUE ~ NaN)) %>%
ggplot() +
  geom_line(aes(x = year, y = days_under, color = Threshold)) +
  geom_point(aes(x = year, y = days_under, color = Threshold), 
             size = 3) +
  geom_point(data = DO_count_bad, aes(x = year, y = days_under,
                                        shape = "*",
                                        color = Threshold)) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 8),
        strip.background = element_rect(fill = "white"),
        legend.position = "top",
        legend.justification="center",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-8,-8,-8,-8)) +
  labs(x = "", y = "Days below dissolved oxygen threshold") +
  guides(shape = "none")

# ggsave(
#   "output/Task1_SWQS_loggers/PlotG_days_below_DO_threshold2.png",
#        height = 7, width = 9, dpi = 400)
```
## "days below DO threshold" boxplots by site
```{r}
# x11(width = 8, height = 6)
DO_count %>%
  filter(summer_days >= 0.8) %>%
  group_by(site) %>%
  mutate(mean_days = mean(days_under)) %>%
  ungroup() %>%
  mutate(site = fct_reorder(as.factor(site), 
                            days_under, 
                            .fun = "mean",
                            .desc = T)) %>%
  ggplot() +
  geom_boxplot(aes(y = site, x = days_under), 
               outlier.color = "transparent",
               color = "darkgray") +
  geom_point(aes(y = site, x = days_under, 
                 color = as.factor(year)), size = 3, 
             alpha =0.75, shape = 16) +
  scale_color_manual(values = c(wes_palettes$Darjeeling1,
                                wes_palettes$Darjeeling2)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        # legend.position = c(0.89,0.14),
        legend.position = c(0.687,0.14),
        legend.justification="left",
        legend.margin=margin(2,2,2,2),
        legend.box.margin=margin(0,0,0,0),
        legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(color = "darkgray"),
        strip.background = element_rect(fill = "white")) +
  labs(y = "", x = "Days below dissolved oxygen threshold", 
       color = "Year") +
    facet_wrap(~Threshold)

ggsave(
  "output/Task1_SWQS_loggers/PlotH_days_below_DO_threshold_boxplot2.png",
       width = 8,
       height = 6, dpi = 400)
```
# Plots of temperature over time for each site (panels by year)
```{r}
site_name_vector = unique(tmax$site)
# plot daily max vs. thresholds

for(site_name in site_name_vector){

print(paste0("Making site ", site_name))
# for testing
#x11(height = 7, width = 9)
  
max_col = "dodgerblue"
roll_col = "red"

tmax %>%
  filter(site == site_name) %>%
  # # this commented code removes empty plots
  # group_by(year) %>%
  # mutate(test = mean(max_temp, na.rm = T)) %>%
  # filter(is.na(test) == F) %>%
  ggplot() +
  geom_hline(
    yintercept = 22,
    color = max_col,
    lty = 3,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 25,
    color = max_col,
    lty = 2,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 31,
    color = max_col,
    lty = 1,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 19,
    color = roll_col,
    lty = 3,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 23,
    color = roll_col,
    lty = 2,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 28,
    color = roll_col,
    lty = 1,
    size = .5,
    alpha = 0.5
  ) +
  geom_line(aes(x = day, y = max_temp),
            size = 1, alpha = 0.75, color = max_col) +
  geom_line(aes(x = day, y = roll_temp),
            size = 0.5, alpha = 0.75, color = roll_col) +
  facet_wrap( ~ year) +
  scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  scale_y_continuous(limits = c(0,32)) +
  cowplot::theme_cowplot() +
  theme(
    strip.background = element_rect(fill = "white")
  ) +
  labs(y = "Daily maximum temperature (C)", x = "",
       color = "Year", title = paste0("Site: ",site_name)) +
  annotate("text", x = 335, y = 30, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 24, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 21, label = "TP", 
           color = "darkgray", size = 2)

num_panels <- length(unique((tmax %>% 
                               filter(site == site_name))$year))
if(num_panels %in% 4:6){
ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_temperature/", site_name, "_tmax_by_day_year.png"),
       height = 6, width = 9, dpi = 400)
  }

# # use this if saving graphs with different numbers of year panels
# if(num_panels %in% 3){
# ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_temperature/", site_name, "_tmax_by_day_year.png"),
#        height = 3, width = 9, dpi = 400)
# }
# 
# if(num_panels %in% 2){
# ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_temperature/", site_name, "_tmax_by_day_year.png"),
#        height = 3, width = 6, dpi = 400)
# }
# 
# if(num_panels %in% 1){
# ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_temperature/", site_name, "_tmax_by_day_year.png"),
#        height = 3, width = 3, dpi = 400)
#   }

}

```
# Plots of DO over time for each site (panels by year)
```{r}

site_name_vector = unique(dmin$site)
# plot daily max vs. thresholds

for(site_name in site_name_vector){

print(paste0("Making site ", site_name))
# for testing
#x11(height = 7, width = 9)
  
max_col = "dodgerblue"
roll_col = "red"

dmin %>%
  filter(site == site_name) %>%
  # # this commented code removes empty plots
  # group_by(year) %>%
  # mutate(test = mean(min_DO, na.rm = T)) %>%
  # filter(is.na(test) == F) %>%
  ggplot() +
    geom_hline(
    yintercept = 7,
    color = max_col,
    lty = 3,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 5,
    color = max_col,
    lty = 2,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 4,
    color = max_col,
    lty = 1,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 6,
    color = roll_col,
    lty = 2,
    size = .5,
    alpha = 0.5
  ) +
  geom_hline(
    yintercept = 5,
    color = roll_col,
    lty = 1,
    size = .5,
    alpha = 0.5
  ) +
  geom_line(aes(x = day, y = min_DO),
            size = 1, alpha = 0.75, color = max_col) +
  geom_line(aes(x = day, y = mean24_DO),
            size = 0.5, alpha = 0.75, color = roll_col) +
  facet_wrap( ~ year) +
  scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  scale_y_continuous(limits = c(0,14.5)) +
  cowplot::theme_cowplot() +
  theme(
    strip.background = element_rect(fill = "white")
  ) +
  labs(y = "Dissolved oxygen", x = "",
       color = "Year", title = paste0("Site: ",site_name)) +
  annotate("text", x = 335, y = 4.5, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 5.5, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 7.5, label = "TP", 
           color = "darkgray", size = 2)

num_panels <- length(unique((tmax %>% 
                               filter(site == site_name))$year))
if(num_panels %in% 4:6){
ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_DO/", site_name, "_DO_by_day_year.png"),
       height = 5, width = 8, dpi = 400)
  }

# # use this if saving graphs with different numbers of year panels
# if(num_panels %in% 3){
# ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_DO/", site_name, "_DO_by_day_year.png"),
#        height = 3, width = 9, dpi = 400)
# }
# 
# if(num_panels %in% 2){
# ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_DO/", site_name, "_DO_by_day_year.png"),
#        height = 3, width = 6, dpi = 400)
# }
# 
# if(num_panels %in% 1){
# ggsave(paste0("output/Task1_SWQS_loggers/individual_sites_DO/", site_name, "_DO_by_day_year.png"),
#        height = 3, width = 3, dpi = 400)
#   }

}

```
# Biplot of DO and temp thresholds
```{r}
# X11(7,5)
both_count %>%
  filter(summer_days.x >= 0.8, summer_days.y >= 0.8) %>%
  filter(Threshold == "Trout Maintenance") %>%
  group_by(site) %>%
  summarise(days_over = mean(days_over),
            days_under = mean(days_under),
            .groups = "drop") %>%
  mutate(mean_days = (days_under+days_over)/2) %>%
  ungroup() %>%
  ggplot() +
  geom_point(aes(y = days_under, x = days_over, 
                color = mean_days), size = 2) +
  geom_text(aes(y = days_under+4, x = days_over, 
                color = mean_days, label = site)) +
  labs(y = "Days exceeding dissolved oxygen",
       x = "Days exceeding temperature",
       title = "Mean days exceeding 'Trout Maintenance' threshold") +
  scale_x_continuous(limits = c(0,110)) +
  scale_y_continuous(limits = c(0,110)) +
  scale_color_gradient(high = "firebrick",space = "Lab") +
  theme_bw() +
  theme(text = element_text(size = 14)) +
  guides(color = "none")

# ggsave(
#   "output/Task1_SWQS_loggers/PlotI_days_exceeding_any_thresholds_scatterplot.png",
#        width = 7,
#        height = 5, dpi = 400)
```
## "days exceeding either threshold" boxplots by site
```{r}
# x11(width = 8, height = 6)
either_count %>%
  filter(summer_days_temp >= 0.8, summer_days_DO >= 0.8) %>%
  mutate(site = fct_reorder(as.factor(site), 
                            days_exceeding, 
                            .fun = "mean",
                            .desc = T)) %>%
  ggplot() +
  geom_boxplot(aes(y = site, x = days_exceeding), 
               outlier.color = "transparent",
               color = "darkgray") +
  geom_point(aes(y = site, x = days_exceeding, 
                 color = as.factor(year)), size = 3, 
             alpha =0.75, shape = 16) +
  scale_color_manual(values = c(wes_palettes$Darjeeling1,
                                wes_palettes$Darjeeling2)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        # legend.position = c(0.89,0.14),
        legend.position = c(0.687,0.14),
        legend.justification="left",
        legend.margin=margin(2,2,2,2),
        legend.box.margin=margin(0,0,0,0),
        legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(color = "darkgray"),
        strip.background = element_rect(fill = "white")) +
  labs(y = "", x = "Days exceeding any threshold (temperature or DO)", 
       color = "Year") +
    facet_wrap(~Threshold)

# ggsave(
#   "output/Task1_SWQS_loggers/PlotJ_days_exceeding_any_threshold_boxplot.png",
#        width = 8,
#        height = 6, dpi = 400)
```
# Testing out GAMs
```{r}

temp <- tmax %>%
  filter(site == "TNC_2",
         year == 2017)

temp <- tmax %>%
  filter(site == "TNC_2") %>%
  mutate(yearf = as.factor(year),
         yearnum = year-2015)

library(mgcv)
ggplot(temp) +
  geom_point(aes(x = day, y = max_temp))

N_days <- length(82:339)

test <- p %>% filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime), 
         hour = hour(datetime),
         yearf = as.factor(year))

gam_all <- gam(temp ~ s(hour) + s(day) + site + yearf,
             data = test,
             family = gaussian)
summary(gam_all)

# the real version
tmax_gam <- tmax %>%
  mutate(yearf = as.factor(year)) %>%
  filter(is.na(max_temp)==F) %>%
  arrange(site, )

gam_1 <- gam(max_temp ~ s(day, by = site:yearf),
             data = tmax_gam,
             family = gaussian)
temp2 <- cbind(tmax_gam, fit = gam_1$fitted.values)

ggplot(temp2) +
  # geom_point(aes(x = day, y = max_temp), color = "darkgray") +
  geom_line(aes(x = day, y = fit, color = yearf)) +
  facet_wrap(~site)


summary(gam_1)
gam_1_plot <- plot(gam_1)[1]

gam_1 <- gam(max_temp ~ s(day, by = yearf),
             data = temp,
             family = gaussian)


plot(gam_1)

gam_mm <- gamm(max_temp ~ s(day, bs = "cc", k = 12) + s(year, bs = "re"), data = temp)



# layout(matrix(1, nrow = 1))
plot(gam_1, shade = T)

summary(gam_1$gam)

tmax_hat = predict(gam_1, 
                     newdata = 
                       expand.grid(site = "TNC_2", 
                                   yearf = 2016:2021, 
                                   day = 82:300), se.fit = T)
plot_data <- expand.grid(year = 2016:2021, 
                                   day = 82:300) %>%
  mutate(tmax_hat = tmax_hat[[1]],
         tmax_UL = tmax_hat[[1]]+2*tmax_hat[[2]],
         tmax_LL = tmax_hat[[1]]-2*tmax_hat[[2]],
         yearf = as.factor(year)) 
  
ggplot() +
    geom_point(data = tmax, aes(x = day, y = max_temp, color = as.factor(year))) +
  geom_line(data = plot_data, aes(x = day, y = tmax_hat, color = yearf))
 

```
# Statistical analysis of days exceeding Trout Maintenance
```{r}
tstat <- tmax %>%
  mutate(MAresid = max_temp - roll_temp,
         TMex = case_when(max_temp > 25 ~ 1,
                          roll_temp > 23 ~ 1,
                          TRUE ~ 0),
         day = day/100,
         yearnum = year-2015,
         yearf = as.factor(yearnum)) %>%
  filter(summer == 1,
         is.na(max_temp) == F) %>%
  select(site, yearf, day, TMex)

library(lme4)
mod <- glmer(TMex ~ (1 | site) + (1 | yearf) , data = tstat, family = "binomial")
plot(mod)



tstat_plot = expand.grid(site = unique(tstat$site), 
                         yearf = 3) %>%
  mutate(fit = predict(mod, newdata = expand.grid(site = unique(tstat$site), yearf = 3), type = "response"))
  

tstat_plot %>%
  ggplot() +
  geom_point(aes(x = site, y = fit, color = yearf))
```


