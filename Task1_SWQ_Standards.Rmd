---
title: "Task 1. SWQ Standards"
author: "Mike Allen"
date: "2/4/2022"
output:
  html_document: default
  pdf_document: default
---
# Task 1: Surface Water Quality Standards (SWQS)
a. Analyze logger data to determine if select monitoring reaches are impaired for sensitive aquatic life (e.g., macroinvertebrates, trout) in freshwater streams. 
- Analyze daily/monthly data at each monitoring location against state SWQS criteria. Which sites are meeting/not meeting SWQS (do temperatures and dissolved oxygen meet criteria required to support aquatic life and trout?)?
b. How often do sites exceed SWQS for temperature (how many days per year)?
c. How often do sites exceed SWQS for dissolved oxygen (how many days per year)?


# Product 1:
• Data visualization (figures, maps, plots) of seasonal, monthly, and diel fluctuations in flow, physiochemical conditions to address the items in Task 1 with respect to state water quality criteria.

• Meetings as needed to refine objectives and desired outputs.

• Summary statistics and statistical analysis of same along with associated interpretative text.

To do:
1. add TNC_80's graphs
1a. add way to flag/remove years with low coverage in Jun-Sep
2. graphs of individual sites w/ panels by year (maybe raw & rolling average on same graph)
3. fix "adjusted DO" graphs & tables (include deleted data)
4. fix DO boxplot figure (good -> bad = top -> bottom)
5. research statistically controlling for air temp (water temp ~ air temp)
6. research methods to statistically QC / censor DO data using water temp data
7. try adding "/n" to tables
8. try bivariate figure that includes temp and DO days above


# Load libraries, format data, etc.
```{r}
library(dplyr)
library(knitr)
library(kableExtra)
library(lubridate)
library(wesanderson)
library(ggplot2)
library(forcats)
library(tidyr)

# read in compiled logger data (including flagged data)
p <- readRDS("output/compiled_logger_data.rds") %>%
  mutate(order = as.numeric(substr(site, 5, 6)),
         site = fct_reorder(site, order))

# format final compiled temperature data
tmax <- p %>%
  filter(FLAG_Temp == 0) %>%
  mutate(day = yday(datetime)) %>%
  group_by(site, year, day) %>%
  summarise(max_temp = max(temp),
            .groups = "drop") %>%
  group_by(site, year) %>%
  mutate(roll_temp = zoo::rollmean(max_temp, 7, fill = NA)) %>%
  droplevels() %>%
  ungroup() %>%
  # remove obvious outliers at start of time series
  filter(as.logical(1-(site == "TNC_25" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2018 & 
                         day == 122))) %>%
  filter(as.logical(1-(site == "TNC_23" & 
                         year == 2021 & 
                         day == 118))) %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  mutate(summer = case_when(day %in% 152:243 ~ 1,
                            TRUE ~ 0))

# summarize number of days above temperature thresholds
temp_count <- tmax %>%
  filter(is.na(max_temp)==F) %>%
  mutate(max_22 = ifelse(max_temp > 22, 1, 0),
         max_25 = ifelse(max_temp > 25, 1, 0),
         max_31 = ifelse(max_temp > 31, 1, 0),
         roll_19 = ifelse(roll_temp > 19, 1, 0),
         roll_23 = ifelse(roll_temp > 23, 1, 0),
         roll_28 = ifelse(roll_temp > 28, 1, 0),
         FW2_TP = case_when(max_22 > 0 ~ 1,
                            roll_19 > 0 ~ 1, 
                            TRUE ~ 0),
         FW2_TM = case_when(max_25 > 0 ~ 1,
                            roll_23 > 0 ~ 1, 
                            TRUE ~ 0),
         FW2_NT = case_when(max_31 > 0 ~ 1,
                            roll_28 > 0 ~ 1,
                            TRUE ~ 0)) %>%
  group_by(site, year) %>%
  summarise(max_22 = sum(max_22),
            max_25 = sum(max_25),
            max_31 = sum(max_31),
            roll_19 = sum(roll_19, na.rm = T),
            roll_23 = sum(roll_23, na.rm = T),
            roll_28 = sum(roll_28, na.rm = T),
            Trout_Production = sum(FW2_TP),
            Trout_Maintenance = sum(FW2_TM),
            Non.Trout = sum(FW2_NT),
            summer_days = sum(summer)/92,
            .groups = "drop") %>%
  pivot_longer(cols = 9:11, names_to = "Threshold",
                      values_to = "days_over") %>%
  mutate(Threshold = gsub(gsub(Threshold, pattern = "_", 
                          replacement = " "), pattern = "\\.",
                          replacement = "-")) %>%
  ungroup()

# Create data frame listing sites with low coverage
temp_cov <- temp_count[temp_count$summer_days < 0.8,] %>%
  select(site, year, summer_days) %>%
  distinct() %>%
  mutate(low = case_when((summer_days < 0.8 &
                            summer_days >= 0.5) ~ "*",
                         summer_days < 0.5 ~ "**"
  ))

# format final compiled DO data
dmin <- p %>%
  filter(FLAG_DO == 0) %>%
  mutate(day = yday(datetime),
         do_adj2 = case_when((is.na(do)==F & is.na(do_adj)==T) ~
                               do,
                             TRUE ~ do_adj),
         adj = case_when(is.na(do_adj)==F ~ 1,
                         TRUE ~ 0)) %>%
  group_by(site, year, day) %>%
  summarise(min_DO = min(do_adj2),
            mean24_DO = mean(do_adj2),
            .groups = "drop") %>%
  droplevels() %>%
  right_join(expand.grid(site = unique(p$site), 
                         year = 2016:2021, day = 82:339)) %>%
  arrange(site, year, day) %>%
  mutate(summer = case_when(day %in% 152:243 ~ 1,
                            TRUE ~ 0))

# summarize number of days below DO thresholds
DO_count <- dmin %>%
  filter(is.na(min_DO)==F) %>%
  mutate(min_7 = ifelse(min_DO < 7, 1, 0),
         min_5 = ifelse(min_DO < 5, 1, 0),
         min_4 = ifelse(min_DO < 4, 1, 0),
         mean24_6 = ifelse(mean24_DO < 6, 1, 0),
         mean24_5 = ifelse(mean24_DO < 5, 1, 0),
         FW2_TP = case_when(min_7 > 0 ~ 1,
                            TRUE ~ 0),
         FW2_TM = case_when(min_5 > 0 ~ 1,
                            mean24_6 > 0 ~ 1,
                            TRUE ~ 0),
         FW2_NT = case_when(min_4 > 0 ~ 1,
                            mean24_5 > 0 ~ 1,
                            TRUE ~ 0)) %>%
  group_by(site, year) %>%
  summarise(min_7 = sum(min_7),
            min_5 = sum(min_5),
            min_4 = sum(min_4),
            mean24_6 = sum(mean24_6, na.rm = T),
            mean24_5 = sum(mean24_5, na.rm = T),
            Trout_Production = sum(FW2_TP),
            Trout_Maintenance = sum(FW2_TM),
            Non.Trout = sum(FW2_NT),
            summer_days = sum(summer)/92,
            .groups = "drop") %>%
  pivot_longer(cols = 8:10, names_to = "Threshold",
                      values_to = "days_under") %>%
  select(site, year, Threshold, days_under, summer_days) %>%
  mutate(Threshold = gsub(gsub(Threshold, pattern = "_", 
                          replacement = " "), pattern = "\\.",
                          replacement = "-"))

```

# Temperature SWQS
b. How often do sites exceed SWQS for temperature (how many days per year)?

From the QAPP:
	1. FW2-TP - Temperature	Shall not exceed a daily maximum of 22 degrees Celsius or rolling seven-day average of the daily maximum of 19 degrees Celsius, unless due to natural conditions
	  - How many days exceed 22 C
	  - How many days 7-d rolling average of daily max exceed 19 C
	
	2. FW2-TM - Shall not exceed a daily maximum of 25 degrees Celsius or rolling seven-day average of the daily maximum of 23 degrees Celsius, unless due to natural conditions	
    - How many days exceed 25 C
    - How many days 7-d rolling average of daily max exceed 23 C

	3. FW2-NT - Shall not exceed a daily maximum of 31 degrees Celsius or rolling seven-day average of the daily maximum of 28 degrees Celsius, unless due to natural conditions	
	
## Temperature SWQS: plot daily max temp for each site/year vs. thresholds
```{r}
# plot daily max vs. thresholds
#x11(height = 7, width = 9)
tmax %>%
  ggplot() +
  geom_hline(
    yintercept = 22,
    color = "gray",
    lty = 3,
    size = .75
  ) +
  geom_hline(
    yintercept = 25,
    color = "gray",
    lty = 2,
    size = .75
  ) +
  geom_hline(
    yintercept = 31,
    color = "gray",
    lty = 1,
    size = .75
  ) +
  geom_line(aes(x = day, y = max_temp,
                color = as.factor(year)),
            alpha = 0.75) +
  facet_wrap( ~ site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(
    breaks = c(91, 152, 213, 274, 335),
    labels = c("Apr", "Jun", "Aug",
               "Oct", "Dec")
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 14),
    axis.text.x = element_text(size = 10),
    strip.background = element_rect(fill = "white")
  ) +
  labs(y = "Daily maximum temperature (C)", x = "",
       color = "Year") +
  annotate("text", x = 335, y = 30, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 24, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 21, label = "TP", 
           color = "darkgray", size = 2)

# ggsave("output/Task1_SWQS_loggers/PlotA_tmax_by_day_year_site3.png",
#        height = 7, width = 9, dpi = 400)
```
## Temperature SWQS: plot rolling-average daily max temp for each site/year vs. thresholds
```{r}
# plot rolling average daily max vs. thresholds
tmax %>%
  ggplot() +
  geom_hline(yintercept = 19, color = "gray", lty = 3, size = .75) +
  geom_hline(yintercept = 23, color = "gray", lty = 2, size = .75) +
  geom_hline(yintercept = 28, color = "gray", lty = 1, size = .75) +
  geom_line(aes(x = day, y = roll_temp, 
                 color = as.factor(year)),
             alpha = 0.75) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = c(91, 152, 213, 274, 335),
                     labels = c("Apr", "Jun", "Aug", 
                                "Oct", "Dec")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 10),
        strip.background = element_rect(fill = "white")) +
  labs(y = "Daily maximum temperature (C)\n7-day rolling average", 
       x = "",
       color = "Year") +
  annotate("text", x = 335, y = 27, label = "NT", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 22, label = "TM", 
           color = "darkgray", size = 2) +
  annotate("text", x = 335, y = 18, label = "TP", 
           color = "darkgray", size = 2)

# ggsave("output/Task1_SWQS_loggers/PlotB_tmax_by_day_year_site_rolling3.png",
#           height = 7, width = 9, dpi = 400)
```
## create table of number of temp measurement days per year per site
```{r}
# create table with Kable
tmax_table <- tmax %>%
  droplevels() %>%
  filter(is.na(max_temp) != T) %>%
  group_by(site, year) %>%
  tally() %>%
  left_join(temp_cov) %>%
  mutate(n = case_when(is.na(low)==F ~ paste0(as.character(n), low),
                          TRUE ~ as.character(n))) %>%
  select(-low) %>%
  pivot_wider(id_cols = site, names_from = year, values_from = n)

day_table <- tmax_table %>%
  kbl(caption = "Total number of days with temperature data by site and year. * = less than 80% coverage of warmest period (Jun-Aug); ** = less than 50% coverage of warmest period.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

day_table

# save the table to HTML file
# save_kable(day_table, 
#            "output/Task1_SWQS_loggers/TableA_tmax_n_table3.html")

# remove tmax_table object
rm(tmax_table, day_table)
```
## Plot number of days exceeding temperature thresholds
```{r}
temp_count %>%
  filter(summer_days >= 0.8) %>%
ggplot() +
  geom_line(aes(x = year, y = days_over, color = Threshold)) +
  geom_point(aes(x = year, y = days_over, color = Threshold), 
             size = 3) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 7),
        strip.background = element_rect(fill = "white"),
        legend.position = "top",
        legend.justification="center",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-8,-8,-8,-8)) +
  labs(x = "", y = "Days above temp. threshold")

# ggsave("output/Task1_SWQS_loggers/PlotC_days_above_temp_threshold2.png",
#        height = 7, width = 9, dpi = 400)
```
## Table of "Days above TM temp. threshold"
```{r}
days_over_table <- temp_count %>%
  filter(Threshold == "Trout Maintenance") %>%
  filter(!(site == "TNC_9" & year == 2016)) %>%
  select(site, year, days_over) %>%
  pivot_wider(id_cols = site, names_from = year,
              values_from = days_over) %>%
  kbl(caption = "Days with tempertature readings over the Trout Maintenance threshold by site and year.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

days_over_table

# save the table to HTML file
# save_kable(days_over_table, 
#            "output/Task1_SWQS_loggers/TableB_tmax_days_over_TM_table2.html")

rm(days_over_table)
```
## "days over temp threshold" boxplots by site
```{r}
temp_count %>%
  # filter(Threshold == "Trout Maintenance") %>%
  filter(!(site == "TNC_9" & year == 2016)) %>%
  group_by(site) %>%
  mutate(mean_days = mean(days_over)) %>%
  ungroup() %>%
  mutate(site = fct_reorder(as.factor(site), 
                            days_over, 
                            .fun = "mean",
                            .desc = T)) %>%
  ggplot() +
  geom_boxplot(aes(y = site, x = days_over), 
               outlier.color = "transparent",
               color = "darkgray") +
  geom_point(aes(y = site, x = days_over, 
                 color = as.factor(year)), size = 3, 
             alpha =0.75, shape = 16) +
  scale_color_manual(values = c(wes_palettes$Darjeeling1,
                                wes_palettes$Darjeeling2)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = c(0.687,0.14),
        legend.justification="left",
        legend.margin=margin(2,2,2,2),
        legend.box.margin=margin(0,0,0,0),
        legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(color = "darkgray"),
        strip.background = element_rect(fill = "white")) +
  labs(y = "", x = "Days above temperature threshold", 
       color = "Year") +
    facet_wrap(~Threshold)

ggsave("output/Task1_SWQS_loggers/PlotD_days_above_temp_threshold2.png",
       width = 8,
       height = 6, dpi = 400)
```
# Dissolved Oxygen SWQS
c. How often do sites exceed SWQS for dissolved oxygen (how many days per year)?

FW2-TP
Not less than 7.0 at any time 

FW2-TM
24-hour average not less than 6.0. Not less than 5.0 at any time

FW2-NT
24-hour average not less than 5.0, but not less than 4.0 at any time 
FW2-TM, FW2-NT
Supersaturated dissolved oxygen values shall be expressed as their corresponding 100 percent saturation values for purposes of calculating 24 hour averages


## DO SWQS: plot daily min for each site/year vs. thresholds
To do: 
Question: DO or DO adjusted?
```{r}
# plot daily min DO vs. thresholds
dmin %>%
  ggplot() +
  geom_hline(yintercept = 7, color = "gray", lty = 3, size = .75) +
  geom_hline(yintercept = 5, color = "gray", lty = 2, size = .75) +
  geom_hline(yintercept = 4, color = "gray", lty = 1, size = .75) + 
  geom_line(aes(x = day, y = min_DOadj, 
                 color = as.factor(year)),
             alpha = 0.75) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = c(91, 152, 213, 274, 335),
                     labels = c("Apr", "Jun", "Aug", 
                                "Oct", "Dec")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        strip.background = element_rect(fill = "white")) +
  labs(y = "Daily minimum dissolved oxygen (adjusted)", x = "",
       color = "Year")

# ggsave("output/Task1_SWQS_loggers/PlotE2_dmin_adj_by_day_year_site.png",
#        height = 7, width = 9, dpi = 400)
```
## DO SWQS: plot 24-h average daily DO for each site/year vs. thresholds
To do:
1. label threshold lines
```{r}
# plot rolling average daily max vs. thresholds
dmin %>%
  ggplot() +
  geom_hline(yintercept = 6, color = "gray", lty = 2, size = .75) +
  geom_hline(yintercept = 5, color = "gray", lty = 1, size = .75) +
  geom_line(aes(x = day, y = mean24_DOadj, 
                 color = as.factor(year)),
             alpha = 0.75) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  scale_x_continuous(breaks = c(91, 152, 213, 274, 335),
                     labels = c("Apr", "Jun", "Aug", 
                                "Oct", "Dec")) +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 12),
        strip.background = element_rect(fill = "white")) +
  labs(y = "Daily average dissolved oxygen (adjusted)", x = "",
       color = "Year")

# ggsave("output/Task1_SWQS_loggers/PlotF2_dmin_by_day_year_24h_avg_adj.png",
# height = 7, width = 9, dpi = 400)
```
## create table of number of DO measurement days per year per site
```{r}
# create table with Kable
dmin_table <- dmin %>%
  droplevels() %>%
  filter(is.na(min_DO) != T)
day_table_DO <- table(dmin_table$site, dmin_table$year) %>%
  kbl(caption = "Number of days of dissolved oxygen data by site and year.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

day_table_DO

# save the table to HTML file
# save_kable(day_table_DO, "output/Task1_SWQS_loggers/TableC1_dmin_n_table.html")

# create DO adjusted table with Kable
dmin_table_adj <- dmin %>%
  droplevels() %>%
  filter(is.na(min_DOadj) != T)
day_table_DOadj <- table(dmin_table_adj$site, 
                         dmin_table_adj$year) %>%
  kbl(caption = "Number of days of adjusted dissolved oxygen data by site and year.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

day_table_DOadj

# save the table to HTML file
# save_kable(day_table_DOadj, "output/Task1_SWQS_loggers/TableC2_dmin_adj_n_table.html")

# remove dmin_table and dmin_table_adj objects
rm(dmin_table, dmin_table_adj)
```

## Plot number of days below DO thresholds
```{r}
DO_count %>%
  # filter out site/year with exceptionally low n (= 16d)
  filter(!(site == "TNC_9" & year == 2016)) %>%
ggplot() +
  geom_line(aes(x = year, y = days_under, color = Threshold)) +
  geom_point(aes(x = year, y = days_under, color = Threshold), 
             size = 3) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 8),
        strip.background = element_rect(fill = "white"),
        legend.position = "top",
        legend.justification="center",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-8,-8,-8,-8)) +
  labs(x = "", y = "Days below dissolved oxygen threshold")

# ggsave("output/Task1_SWQS_loggers/PlotG1_days_below_DO_threshold.png",
#        height = 7, width = 9, dpi = 400)
```
## Plot number of days below DO thresholds (adjusted data)
```{r}
DO_count_adj %>%
  # filter out 4 site/year with exceptionally low n (= 16d)
  filter(!(site == "TNC_9" & year == 2016),
         !(site == "TNC_18" & year == 2021),
         !(site == "TNC_23" & year == 2020),
         !(site == "TNC_25" & year == 2020)) %>%
ggplot() +
  geom_line(aes(x = year, y = days_under, color = Threshold)) +
  geom_point(aes(x = year, y = days_under, color = Threshold), 
             size = 3) +
  facet_wrap(~site) +
  scale_color_brewer(palette = "Dark2") +
  theme_bw() +
  theme(text = element_text(size = 14),
        axis.text.x = element_text(size = 8),
        strip.background = element_rect(fill = "white"),
        legend.position = "top",
        legend.justification="center",
        legend.margin=margin(0,0,0,0),
        legend.box.margin=margin(-8,-8,-8,-8)) +
  labs(x = "", y = "Days below dissolved oxygen threshold (adjusted)")

# ggsave("output/Task1_SWQS_loggers/PlotG2_days_below_DO_threshold_adj.png",
#        height = 7, width = 9, dpi = 400)
```
## Table of "Days below DO threshold"
```{r}
# for straight DO data
days_below_table <- DO_count %>%
  filter(Threshold == "Trout Maintenance") %>%
  filter(!(site == "TNC_9" & year == 2016)) %>%
  select(site, year, days_under) %>%
  pivot_wider(id_cols = site, names_from = year,
              values_from = days_under) %>%
  kbl(caption = "Days with dissolved oxygen readings under the Trout Maintenance threshold by site and year.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

days_below_table

# save the table to HTML file
# save_kable(days_below_table, "output/Task1_SWQS_loggers/TableD1_dmin_days_under_TM_table.html")

# for adjusted DO data
days_below_table_adj <- DO_count_adj %>%
  filter(Threshold == "Trout Maintenance") %>%
  # remove records for 4 under-sampled years
  filter(!(site == "TNC_9" & year == 2016),
         !(site == "TNC_18" & year == 2021),
         !(site == "TNC_23" & year == 2020),
         !(site == "TNC_25" & year == 2020)) %>%
  select(site, year, days_under) %>%
  pivot_wider(id_cols = site, names_from = year,
              values_from = days_under) %>%
  kbl(caption = "Days with adjusted dissolved oxygen readings under the Trout Maintenance threshold by site and year.") %>%
  kable_classic(full_width = F, html_font = "Cambria")

days_below_table_adj

# save the table to HTML file
# save_kable(days_below_table_adj, "output/Task1_SWQS_loggers/TableD2_dmin_days_under_TM_table_adj.html")

rm(days_below_table, days_below_table_adj)
```
## "days below DO threshold" boxplots by site
```{r}
# x11(width = 8, height = 6)
DO_count %>%
  filter(!(site == "TNC_9" & year == 2016)) %>%
  group_by(site) %>%
  mutate(mean_days = mean(days_under)) %>%
  ungroup() %>%
  mutate(site = fct_reorder(as.factor(site), 
                            days_under, 
                            .fun = "mean",
                            .desc = F)) %>%
  ggplot() +
  geom_boxplot(aes(y = site, x = days_under), 
               outlier.color = "transparent",
               color = "darkgray") +
  geom_point(aes(y = site, x = days_under, 
                 color = as.factor(year)), size = 3, 
             alpha =0.75, shape = 16) +
  scale_color_manual(values = c(wes_palettes$Darjeeling1,
                                wes_palettes$Darjeeling2)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = c(0.89,0.14),
        legend.justification="left",
        legend.margin=margin(2,2,2,2),
        legend.box.margin=margin(0,0,0,0),
        legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(color = "darkgray"),
        strip.background = element_rect(fill = "white")) +
  labs(y = "", x = "Days below dissolved oxygen threshold", 
       color = "Year") +
    facet_wrap(~Threshold)


# ggsave("output/Task1_SWQS_loggers/PlotH1_days_below_DO_threshold.png", 
#        width = 8,
#        height = 6, dpi = 400)
```

## "days below DO threshold" boxplots by site (adjusted DO)
```{r}
# x11(width = 8, height = 6)
DO_count_adj %>%
  # remove records for 4 under-sampled years
  filter(!(site == "TNC_9" & year == 2016),
         !(site == "TNC_18" & year == 2021),
         !(site == "TNC_23" & year == 2020),
         !(site == "TNC_25" & year == 2020)) %>%  
  group_by(site) %>%
  mutate(mean_days = mean(days_under)) %>%
  ungroup() %>%
  mutate(site = fct_reorder(as.factor(site), 
                            days_under, 
                            .fun = "mean",
                            .desc = F)) %>%
  ggplot() +
  geom_boxplot(aes(y = site, x = days_under), 
               outlier.color = "transparent",
               color = "darkgray") +
  geom_point(aes(y = site, x = days_under, 
                 color = as.factor(year)), size = 3, 
             alpha =0.75, shape = 16) +
  scale_color_manual(values = c(wes_palettes$Darjeeling1,
                                wes_palettes$Darjeeling2)) +
  theme_bw() +
  theme(text = element_text(size = 14),
        legend.position = c(0.89,0.14),
        legend.justification="left",
        legend.margin=margin(2,2,2,2),
        legend.box.margin=margin(0,0,0,0),
        legend.key.size = unit(0.25, "cm"),
        legend.background = element_rect(color = "darkgray"),
        strip.background = element_rect(fill = "white")) +
  labs(y = "", 
       x = "Days below dissolved oxygen threshold (adjusted DO)", 
       color = "Year") +
    facet_wrap(~Threshold)


# ggsave("output/Task1_SWQS_loggers/PlotH2_days_below_DO_threshold_adj.png", 
#        width = 8,
#        height = 6, dpi = 400)
```